<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑ‰ªªÂä°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 0;
        }

        /* ÁôªÂΩïÈ°µÈù¢Ê†∑Âºè */
        .login-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
        }

        .login-title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #5568d3;
        }

        .error-msg {
            color: #ef4444;
            font-size: 13px;
            margin-top: 10px;
            text-align: center;
        }

        .tip {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #0369a1;
        }

        /* ‰ªªÂä°È°µÈù¢Ê†∑Âºè */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .stats-bar {
            background: white;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .stat-pending { color: #f59e0b; }
        .stat-accepted { color: #10b981; }
        .stat-total { color: #3b82f6; }

        .tabs {
            background: white;
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .content {
            padding: 15px;
        }

        .task-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .task-card:active {
            transform: scale(0.98);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .task-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            margin-left: 10px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-accepted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-completed {
            background: #bbf7d0;
            color: #166534;
        }

        .task-desc {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #999;
            margin-bottom: 10px;
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .deadline-urgent {
            color: #ef4444 !important;
            font-weight: 600;
        }

        .deadline-soon {
            color: #f59e0b !important;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-accept {
            background: #10b981;
            color: white;
        }

        .btn-accept:hover {
            background: #059669;
        }

        .btn-reject {
            background: #ef4444;
            color: white;
        }

        .btn-reject:hover {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .sort-info {
            background: #f0f9ff;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 13px;
            color: #1e40af;
            text-align: center;
        }

        /* Â∫ïÈÉ®ÂØºËà™Ê†è */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            padding: 12px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #6b7280;
        }

        .nav-item.active {
            color: #3b82f6;
        }

        .nav-item .nav-icon {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .nav-item .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        .main-content {
            padding-bottom: 70px;
        }

        /* Ë¥üËΩΩÈ°µÈù¢Ê†∑Âºè */
        .workload-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
        }

        .workload-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 15px;
            background: white;
        }

        .workload-stat-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .workload-stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .workload-stat-label {
            font-size: 12px;
            color: #666;
        }

        .workload-gauge {
            background: white;
            padding: 20px;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .gauge-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            text-align: center;
        }

        .gauge-bar {
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .gauge-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .gauge-fill.low { background: linear-gradient(90deg, #10b981, #34d399); }
        .gauge-fill.medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .gauge-fill.high { background: linear-gradient(90deg, #f97316, #fb923c); }
        .gauge-fill.overload { background: linear-gradient(90deg, #ef4444, #f87171); }

        .gauge-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #999;
        }

        .gauge-percentage {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin-top: 15px;
        }

        .workload-section {
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .section-action {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }

        .section-action:hover {
            background: #2563eb;
        }

        .workload-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workload-item:last-child {
            border-bottom: none;
        }

        .workload-item-info {
            flex: 1;
        }

        .workload-item-name {
            font-size: 15px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .workload-item-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .workload-item-hours {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .workload-item-delete {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }

        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .type-project { background: #dbeafe; color: #1d4ed8; }
        .type-temporary { background: #fef3c7; color: #92400e; }
        .type-learning { background: #d1fae5; color: #065f46; }
        .type-meeting { background: #ede9fe; color: #5b21b6; }
        .type-travel { background: #fce7f3; color: #9d174d; }
        .type-training { background: #cffafe; color: #0e7490; }
        .type-leave { background: #fee2e2; color: #991b1b; }
        .type-other { background: #f3f4f6; color: #374151; }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }

        .modal-footer .btn {
            flex: 1;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .empty-section {
            padding: 30px;
            text-align: center;
            color: #999;
        }

        .empty-section p {
            margin-top: 10px;
            font-size: 14px;
        }

        /* ÂõæË°®Ê†∑Âºè */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
        }

        @media (max-width: 600px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        /* È•ºÂõæÊ†∑Âºè */
        .pie-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .pie-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            position: relative;
            margin-bottom: 15px;
        }

        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #666;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Êü±Áä∂ÂõæÊ†∑Âºè */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            padding: 10px 0;
            border-bottom: 2px solid #e5e7eb;
        }

        .bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .bar-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 120px;
        }

        .bar {
            width: 12px;
            border-radius: 3px 3px 0 0;
            transition: height 0.3s ease;
            min-height: 2px;
        }

        .bar-available {
            background: linear-gradient(180deg, #3b82f6, #60a5fa);
        }

        .bar-manager {
            background: linear-gradient(180deg, #8b5cf6, #a78bfa);
        }

        .bar-self {
            background: linear-gradient(180deg, #10b981, #34d399);
        }

        .bar-unavailable {
            background: linear-gradient(180deg, #ef4444, #f87171);
        }

        .bar-label {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        .bar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            padding-top: 10px;
        }

        /* Ë¥üËΩΩÊåáÁ§∫Âô®‰ºòÂåñ */
        .workload-indicator {
            background: white;
            margin: 15px;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .workload-circle {
            width: 140px;
            height: 140px;
            margin: 0 auto 20px;
            position: relative;
        }

        .workload-circle svg {
            transform: rotate(-90deg);
        }

        .workload-circle-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 12;
        }

        .workload-circle-fill {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .workload-circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .workload-percentage {
            font-size: 32px;
            font-weight: bold;
        }

        .workload-status {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .workload-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .workload-detail-row:last-child {
            border-bottom: none;
        }

        .workload-detail-label {
            color: #666;
        }

        .workload-detail-value {
            font-weight: 600;
            color: #333;
        }

        .week-hours-badge {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        /* Êó•Á®ãÈ°µÈù¢Ê†∑Âºè */
        .schedule-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
        }
        
        .schedule-actions {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .schedule-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .schedule-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }
        
        .schedule-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .schedule-day {
            background: white;
            margin: 10px 15px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .schedule-day-header {
            background: #f8fafc;
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .schedule-day-title {
            font-weight: 600;
            color: #333;
        }
        
        .schedule-day-hours {
            background: #8b5cf6;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .schedule-task {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .schedule-task:last-child {
            border-bottom: none;
        }
        
        .schedule-task-info {
            flex: 1;
        }
        
        .schedule-task-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .schedule-task-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .schedule-task-hours {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .importance-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }
        
        .importance-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
        }
        
        .importance-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #8b5cf6;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .importance-value {
            background: #8b5cf6;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            min-width: 35px;
            text-align: center;
        }
        
        .task-importance-section {
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .task-importance-header {
            background: #f8fafc;
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-importance-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .task-importance-item:last-child {
            border-bottom: none;
        }
        
        .task-importance-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .task-importance-meta {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .schedule-info-card {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .schedule-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .schedule-info-row:last-child {
            border-bottom: none;
        }
        
        .schedule-warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px 15px;
            margin: 15px;
            border-radius: 8px;
            font-size: 13px;
        }
        
        /* ÊùÉÈáçÈÖçÁΩÆÊ†∑Âºè - ‰∫§‰∫íÂºèÈ•ºÂõæ */
        .weight-config {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .weight-config-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 16px;
        }
        
        .weight-pie-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .weight-pie {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .weight-pie:hover {
            transform: scale(1.02);
        }
        
        .weight-pie-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .weight-pie-label {
            font-size: 11px;
            color: #999;
        }
        
        .weight-pie-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .weight-controls {
            width: 100%;
        }
        
        .weight-control-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .weight-control-item:hover {
            background: #f0f4f8;
        }
        
        .weight-control-item.active {
            background: #ede9fe;
            border: 2px solid #8b5cf6;
        }
        
        .weight-color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .weight-control-info {
            flex: 1;
        }
        
        .weight-control-label {
            font-size: 13px;
            font-weight: 500;
            color: #333;
        }
        
        .weight-control-desc {
            font-size: 11px;
            color: #999;
        }
        
        .weight-control-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .weight-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 50%;
            background: #e5e7eb;
            color: #333;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .weight-btn:hover {
            background: #d1d5db;
        }
        
        .weight-btn:active {
            transform: scale(0.95);
        }
        
        .weight-number {
            font-size: 16px;
            font-weight: 600;
            min-width: 45px;
            text-align: center;
        }
        
        /* ËøõÂ∫¶ÁéØÊ†∑Âºè */
        .progress-ring {
            width: 40px;
            height: 40px;
            position: relative;
        }
        
        .progress-ring svg {
            transform: rotate(-90deg);
        }
        
        .progress-ring-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 4;
        }
        
        .progress-ring-fill {
            fill: none;
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s;
        }
        
        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: 600;
            color: #333;
        }
        
        /* ‰∏çÂèØÁî®Êó∂Èó¥Ê†∑Âºè */
        .schedule-unavailable {
            padding: 10px 15px;
            background: #fef2f2;
            border-bottom: 1px solid #fecaca;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .schedule-unavailable-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .schedule-unavailable-icon {
            font-size: 16px;
        }
        
        .schedule-unavailable-text {
            font-size: 13px;
            color: #991b1b;
        }
        
        .schedule-unavailable-hours {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Âª∂ÊúüÈ£éÈô©Ê†∑Âºè */
        .delay-risks-section {
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .delay-risks-header {
            background: #fef2f2;
            padding: 15px;
            border-bottom: 1px solid #fecaca;
            font-weight: 600;
            color: #991b1b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delay-risk-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .delay-risk-item:last-child {
            border-bottom: none;
        }
        
        .delay-risk-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .delay-risk-meta {
            font-size: 12px;
            color: #999;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 5px;
        }
        
        .delay-risk-reason {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .risk-overdue {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .risk-high {
            background: #ffedd5;
            color: #9a3412;
        }
        
        .risk-medium {
            background: #fef3c7;
            color: #92400e;
        }
        
        .risk-low {
            background: #ecfdf5;
            color: #065f46;
        }
        
        /* ========== ÂºÄÂßãÂ∑•‰ΩúÊ®°ÂùóÊ†∑Âºè ========== */
        .work-page-header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 20px;
            padding-bottom: 30px;
        }
        
        .work-date-section {
            background: white;
            margin: -15px 15px 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .work-date-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .work-date-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            font-size: 13px;
            color: #64748b;
            transition: all 0.3s;
        }
        
        .work-date-tab.active {
            color: #059669;
            background: white;
            font-weight: 600;
        }
        
        .work-date-tab.today {
            border-bottom: 3px solid #059669;
        }
        
        .work-task-list {
            padding: 10px 0;
        }
        
        .work-task-card {
            margin: 10px 15px;
            background: #f8fafc;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .work-task-card.working {
            background: #ecfdf5;
            border-color: #059669;
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.2);
        }
        
        .work-task-card.paused {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .work-task-card.completed {
            background: #f0fdf4;
            border-color: #22c55e;
            opacity: 0.8;
        }
        
        .work-task-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .work-task-info {
            flex: 1;
        }
        
        .work-task-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .work-task-type.manager {
            background: #ddd6fe;
            color: #7c3aed;
        }
        
        .work-task-type.self {
            background: #fef3c7;
            color: #b45309;
        }
        
        .work-task-name {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .work-task-meta {
            font-size: 12px;
            color: #6b7280;
        }
        
        .work-task-status {
            text-align: right;
        }
        
        .work-status-badge {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .work-status-badge.pending {
            background: #e5e7eb;
            color: #4b5563;
        }
        
        .work-status-badge.working {
            background: #059669;
            color: white;
            animation: pulse 2s infinite;
        }
        
        .work-status-badge.paused {
            background: #f59e0b;
            color: white;
        }
        
        .work-status-badge.completed {
            background: #22c55e;
            color: white;
        }
        
        .work-status-badge.overtime {
            background: #ef4444;
            color: white;
        }
        
        .work-status-badge.overwork {
            background: #f97316;
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* ËÆ°Êó∂Âô®ÊòæÁ§∫ */
        .work-timer-section {
            padding: 15px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }
        
        .work-timer-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .work-timer {
            font-size: 28px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            color: #1f2937;
        }
        
        .work-timer.overtime {
            color: #ef4444;
        }
        
        .work-timer.overwork {
            color: #f97316;
        }
        
        .work-planned {
            font-size: 13px;
            color: #6b7280;
        }
        
        .work-progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .work-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #059669, #10b981);
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        .work-progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }
        
        .work-progress-fill.danger {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        /* Êìç‰ΩúÊåâÈíÆ */
        .work-actions {
            display: flex;
            gap: 10px;
        }
        
        .work-btn {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .work-btn-start {
            background: #059669;
            color: white;
        }
        
        .work-btn-start:hover {
            background: #047857;
        }
        
        .work-btn-pause {
            background: #f59e0b;
            color: white;
        }
        
        .work-btn-pause:hover {
            background: #d97706;
        }
        
        .work-btn-resume {
            background: #3b82f6;
            color: white;
        }
        
        .work-btn-resume:hover {
            background: #2563eb;
        }
        
        .work-btn-complete {
            background: #22c55e;
            color: white;
        }
        
        .work-btn-complete:hover {
            background: #16a34a;
        }
        
        /* ‰∏≠Êñ≠ËÆ∞ÂΩï */
        .work-interruptions {
            padding: 10px 15px;
            background: #fffbeb;
            border-top: 1px solid #fef3c7;
        }
        
        .work-interruptions-title {
            font-size: 12px;
            color: #92400e;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .work-interruption-item {
            font-size: 12px;
            color: #78716c;
            padding: 5px 0;
            border-bottom: 1px dashed #e7e5e4;
            display: flex;
            justify-content: space-between;
        }
        
        .work-interruption-item:last-child {
            border-bottom: none;
        }
        
        /* ‰∏≠Êñ≠ÂºπÁ™ó */
        .pause-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .pause-modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }
        
        .pause-modal-header {
            background: #f59e0b;
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .pause-modal-body {
            padding: 20px;
        }
        
        .pause-reason-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
        }
        
        .pause-modal-footer {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #e5e7eb;
        }
        
        /* ‰∏çÂèØÁî®Êó∂Èó¥Âç°Áâá */
        .work-unavailable-card {
            margin: 10px 15px;
            background: #fef2f2;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #fecaca;
        }
        
        .work-unavailable-title {
            font-size: 14px;
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .work-unavailable-time {
            font-size: 13px;
            color: #b91c1c;
        }
        
        /* Á©∫Áä∂ÊÄÅ */
        .work-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        .work-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .work-empty-text {
            font-size: 14px;
        }
        
        /* ÂÆåÊàêÁªüËÆ° */
        .work-complete-stats {
            background: #f0fdf4;
            padding: 15px;
            margin: 15px;
            border-radius: 12px;
            border: 1px solid #bbf7d0;
        }
        
        .work-complete-title {
            font-size: 14px;
            font-weight: 600;
            color: #166534;
            margin-bottom: 10px;
        }
        
        .work-complete-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #4b5563;
            padding: 5px 0;
        }
    </style>
    
    <!-- ÂºïÂÖ•ÈíâÈíâ JSAPI -->
    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.10.3/dingtalk.open.js"></script>
</head>
<body>
    <div id="app"></div>

    <script>
        let currentUser = null;
        let allTasks = [];
        let currentFilter = 'manager';  // 'manager', 'self', 'unavailable'
        let currentPage = 'tasks';  // 'tasks' Êàñ 'workload'
        const API_BASE = '/api';

        // ÂÖ®Â±ÄÂèòÈáèÔºöÈíâÈíâÈÖçÁΩÆÂíåÁéØÂ¢ÉÊ£ÄÊµã
        let dingtalkConfig = null;
        let isDingTalkEnv = false;

        // Ë¥üËΩΩÊï∞ÊçÆ
        let workloadData = null;
        let selfTasks = [];
        let unavailableTimes = [];
        let allUnavailableTimes = [];  // ÊâÄÊúâ‰∏çÂèØÁî®Êó∂Èó¥Ôºà‰∏çÈôêÊú¨Âë®Ôºâ
        let allSelfTasks = [];  // ÊâÄÊúâËá™‰∏ª‰ªªÂä°Ôºà‰∏çÈôêÊú¨Âë®Ôºâ
        
        // Êó•Á®ãÊï∞ÊçÆ
        let scheduleData = null;
        
        // Â∑•‰Ωú‰ºöËØùÊï∞ÊçÆ
        let workSessionData = null;
        let currentWorkDate = null;  // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊó•Êúü
        let workTimer = null;  // ËÆ°Êó∂Âô®
        let workTimerInterval = null;  // ËÆ°Êó∂Âô®Êõ¥Êñ∞Èó¥Èöî
        
        // ========== ÁôªÂΩïÁä∂ÊÄÅÊåÅ‰πÖÂåñ ==========
        function saveLoginState() {
            if (currentUser) {
                localStorage.setItem('employee_user', JSON.stringify(currentUser));
                localStorage.setItem('employee_page', currentPage);
                localStorage.setItem('employee_filter', currentFilter);
            }
        }
        
        function loadLoginState() {
            try {
                const savedUser = localStorage.getItem('employee_user');
                const savedPage = localStorage.getItem('employee_page');
                const savedFilter = localStorage.getItem('employee_filter');
                
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    currentPage = savedPage || 'tasks';
                    currentFilter = savedFilter || 'manager';
                    return true;
                }
            } catch (e) {
                console.error('Âä†ËΩΩÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', e);
            }
            return false;
        }
        
        function clearLoginState() {
            localStorage.removeItem('employee_user');
            localStorage.removeItem('employee_page');
            localStorage.removeItem('employee_filter');
        }

        // ÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢
        function showLogin() {
            document.body.className = '';
            
            // Ê£ÄÊµãÊòØÂê¶Âú®ÈíâÈíâÁéØÂ¢É‰∏≠
            isDingTalkEnv = typeof dd !== 'undefined' && dd.env && dd.env.platform !== 'notInDingTalk';
            
            let loginButtons = '';
            if (isDingTalkEnv) {
                // Âú®ÈíâÈíâÁéØÂ¢É‰∏≠ÔºåÊòæÁ§∫ÂÖçÂØÜÁôªÂΩïÊåâÈíÆ
                loginButtons = `
                    <button type="button" class="login-btn" onclick="handleDingTalkLogin()" style="background: linear-gradient(135deg, #00b96b 0%, #00a854 100%);">
                        üîê ÈíâÈíâÂÖçÂØÜÁôªÂΩï
                    </button>
                    <div style="text-align: center; margin: 15px 0; color: #999; font-size: 14px;">Êàñ</div>
                    <button type="submit" class="login-btn" style="background: #667eea;">ÊâãÂä®ËæìÂÖ•IDÁôªÂΩï</button>
                `;
            } else {
                // ‰∏çÂú®ÈíâÈíâÁéØÂ¢É‰∏≠ÔºåÂè™ÊòæÁ§∫ÊâãÂä®ÁôªÂΩï
                loginButtons = `
                    <button type="submit" class="login-btn">ÁôªÂΩï</button>
                `;
            }
            
            document.getElementById('app').innerHTML = `
                <div class="login-page">
                    <div class="login-container">
                        <h1 class="login-title">üìã ÊàëÁöÑ‰ªªÂä°</h1>
                        <div class="tip">${isDingTalkEnv ? 'üí° Êé®Ëçê‰ΩøÁî®ÈíâÈíâÂÖçÂØÜÁôªÂΩï' : 'üí° ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÈíâÈíâÁî®Êà∑IDÁôªÂΩï'}</div>
                        <form onsubmit="handleLogin(event)">
                            <div class="input-group">
                                <label>ÈíâÈíâÁî®Êà∑ID</label>
                                <input type="text" id="userid" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÈíâÈíâID" ${isDingTalkEnv ? '' : 'required'} autofocus>
                            </div>
                            ${loginButtons}
                            <div id="error" class="error-msg"></div>
                        </form>
                    </div>
                </div>
            `;
            
            // Âä†ËΩΩÈíâÈíâÈÖçÁΩÆ
            if (isDingTalkEnv) {
                loadDingTalkConfig();
            }
        }

        // Â§ÑÁêÜÁôªÂΩï
        async function handleLogin(event) {
            event.preventDefault();
            const userid = document.getElementById('userid').value.trim();
            const errorDiv = document.getElementById('error');
            
            if (!userid) {
                errorDiv.textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ID';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/employees`);
                const employees = await response.json();
                const employee = employees.find(e => e.dingtalk_id === userid);

                if (employee) {
                    currentUser = employee;
                    await loadTasks();
                    showTaskPage();
                } else {
                    errorDiv.textContent = 'Áî®Êà∑ID‰∏çÂ≠òÂú®ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò';
                }
            } catch (err) {
                errorDiv.textContent = 'ÁôªÂΩïÂ§±Ë¥•: ' + err.message;
            }
        }

        // Âä†ËΩΩÈíâÈíâÈÖçÁΩÆ
        async function loadDingTalkConfig() {
            try {
                const response = await fetch(`${API_BASE}/dingtalk/config?type=employee`);
                dingtalkConfig = await response.json();
                console.log('ÈíâÈíâÈÖçÁΩÆÂä†ËΩΩÊàêÂäü:', dingtalkConfig);
            } catch (error) {
                console.error('Âä†ËΩΩÈíâÈíâÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // Â§ÑÁêÜÈíâÈíâÂÖçÂØÜÁôªÂΩï
        async function handleDingTalkLogin() {
            const errorDiv = document.getElementById('error');
            
            if (!isDingTalkEnv) {
                errorDiv.textContent = 'ËØ∑Âú®ÈíâÈíâÂÆ¢Êà∑Á´Ø‰∏≠ÊâìÂºÄ';
                return;
            }
            
            if (!dingtalkConfig) {
                errorDiv.textContent = 'ÈíâÈíâÈÖçÁΩÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
                return;
            }
            
            try {
                errorDiv.textContent = 'Ê≠£Âú®ÁôªÂΩï...';
                errorDiv.style.color = '#00b96b';
                
                // 1. Ëé∑ÂèñÊéàÊùÉÁ†Å
                console.log('ÂºÄÂßãËé∑ÂèñÊéàÊùÉÁ†Å...');
                const authCode = await getDingTalkAuthCode();
                console.log('ÊéàÊùÉÁ†ÅËé∑ÂèñÊàêÂäü:', authCode);
                
                // 2. ÂèëÈÄÅÂà∞ÂêéÁ´ØËøõË°åÁôªÂΩï
                const response = await fetch(`${API_BASE}/dingtalk/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        authCode: authCode,
                        type: 'employee'
                    })
                });
                
                const result = await response.json();
                console.log('ÁôªÂΩïÁªìÊûú:', result);
                
                if (result.success) {
                    // ÁôªÂΩïÊàêÂäü
                    currentUser = result.data.employee;
                    await loadTasks();
                    showTaskPage();
                } else {
                    errorDiv.style.color = '#ff4d4f';
                    errorDiv.textContent = result.message || 'ÁôªÂΩïÂ§±Ë¥•';
                }
            } catch (error) {
                console.error('ÈíâÈíâÁôªÂΩïÂ§±Ë¥•:', error);
                errorDiv.style.color = '#ff4d4f';
                errorDiv.textContent = 'ÁôªÂΩïÂ§±Ë¥•: ' + error.message;
            }
        }

        // Ëé∑ÂèñÈíâÈíâÊéàÊùÉÁ†Å
        function getDingTalkAuthCode() {
            return new Promise((resolve, reject) => {
                dd.runtime.permission.requestAuthCode({
                    corpId: dingtalkConfig.corpId,
                    onSuccess: function(result) {
                        resolve(result.code);
                    },
                    onFail: function(err) {
                        reject(new Error('Ëé∑ÂèñÊéàÊùÉÁ†ÅÂ§±Ë¥•: ' + JSON.stringify(err)));
                    }
                });
            });
        }

        // Âä†ËΩΩ‰ªªÂä°
        async function loadTasks() {
            try {
                const response = await fetch(`${API_BASE}/assignments`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const assignments = await response.json();
                
                // Á°Æ‰øùËøîÂõûÁöÑÊòØÊï∞ÁªÑ
                if (!Array.isArray(assignments)) {
                    console.error('ËøîÂõûÁöÑÊï∞ÊçÆ‰∏çÊòØÊï∞ÁªÑ:', assignments);
                    throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
                }
                
                // ÂêéÁ´ØAPIËøîÂõûÁöÑÂ≠óÊÆµÂêçÔºöemployeeId, taskName, taskDescriptionÁ≠â
                allTasks = assignments
                    .filter(a => a.employeeId === currentUser.id && a.status !== 'rejected')
                    .map(a => ({
                        id: a.id,
                        name: a.taskName,
                        description: a.taskDescription,
                        deadline: a.taskDeadline,
                        estimatedHours: a.taskEstimatedHours,  // È¢ÑËÆ°ËÄóÊó∂
                        managerImportance: a.managerImportance,  // ÁªèÁêÜËØÑÂÆöÁöÑÈáçË¶ÅÊÄß
                        employeeImportance: a.employeeImportance,  // ÂëòÂ∑•ËØÑÂÆöÁöÑÈáçË¶ÅÊÄß
                        status: a.status,
                        assignedAt: a.assignedAt,
                        assignedByName: a.assignedByName || 'ÁÆ°ÁêÜÂëò',
                        // ÂÆåÊàêÊÉÖÂÜµÂ≠óÊÆµ
                        completedAt: a.completedAt,
                        actualHours: a.actualHours,
                        completionNote: a.completionNote,
                        // ÁªèÁêÜËØÑ‰ª∑Â≠óÊÆµ
                        efficiencyRating: a.efficiencyRating,
                        qualityRating: a.qualityRating,
                        reviewComment: a.reviewComment,
                        reviewedAt: a.reviewedAt
                    }))
                    .sort((a, b) => {
                        // Â∑≤ÂÆåÊàêÁöÑÊéíÂú®ÂêéÈù¢
                        if (a.status === 'completed' && b.status !== 'completed') return 1;
                        if (a.status !== 'completed' && b.status === 'completed') return -1;
                        // ÊåâÊà™Ê≠¢Êó•ÊúüÊéíÂ∫è
                        return new Date(a.deadline || '9999') - new Date(b.deadline || '9999');
                    });
            } catch (error) {
                console.error('Âä†ËΩΩ‰ªªÂä°Â§±Ë¥•:', error);
                alert('Âä†ËΩΩ‰ªªÂä°Â§±Ë¥•: ' + error.message);
                allTasks = [];
            }
        }

        // ÊòæÁ§∫‰ªªÂä°È°µÈù¢
        async function showTaskPage() {
            document.body.className = '';
            currentPage = 'tasks';
            saveLoginState();  // ‰øùÂ≠òÁôªÂΩïÁä∂ÊÄÅ
            
            const pending = allTasks.filter(t => t.status === 'pending').length;
            const accepted = allTasks.filter(t => t.status === 'accepted').length;
            
            // Âä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
            await loadTaskPageData();
            
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÊéíÁ®ã
            let scheduleUpdateInfo = null;
            try {
                const response = await fetch(`${API_BASE}/schedule/check-updates/${currentUser.id}`);
                if (response.ok) {
                    scheduleUpdateInfo = await response.json();
                }
            } catch (e) {
                console.log('Ê£ÄÊü•ÊéíÁ®ãÊõ¥Êñ∞Â§±Ë¥•:', e);
            }

            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div class="header">
                        <div class="header-content">
                            <div>
                                <h1>üìã ÊàëÁöÑ‰ªªÂä°</h1>
                                <p>${currentUser.name} ¬∑ ${allTasks.length} ‰∏™ÁªèÁêÜ‰ªªÂä°</p>
                            </div>
                            <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                        </div>
                    </div>

                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-number stat-pending">${pending}</div>
                            <div class="stat-label">ÂæÖÂ§ÑÁêÜ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number stat-accepted">${accepted}</div>
                            <div class="stat-label">ËøõË°å‰∏≠</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number stat-total">${allTasks.filter(t => t.status === 'completed').length + allSelfTasks.filter(t => t.status === 'completed').length}</div>
                            <div class="stat-label">Â∑≤ÂÆåÊàê</div>
                        </div>
                    </div>
                    
                    ${scheduleUpdateInfo && scheduleUpdateInfo.needsUpdate ? `
                        <div style="margin: 10px 15px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 1px solid #fcd34d;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 5px;">
                                        üîî ÊúâÊñ∞ÂÜÖÂÆπÈúÄË¶ÅÊõ¥Êñ∞ÊéíÁ®ã
                                    </div>
                                    <div style="font-size: 12px; color: #b45309;">
                                        ${scheduleUpdateInfo.reason}
                                    </div>
                                </div>
                                <button onclick="showUpdateScheduleModal()" style="
                                    background: #f59e0b;
                                    color: white;
                                    border: none;
                                    padding: 10px 15px;
                                    border-radius: 8px;
                                    font-size: 13px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    white-space: nowrap;
                                ">
                                    ÊàëË¶ÅÊõ¥Êñ∞ÊéíÁ®ã
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <div class="tabs">
                        <div class="tab ${currentFilter === 'manager' ? 'active' : ''}" onclick="filterTasks('manager')">
                            ÁªèÁêÜ‰ªªÂä° (${allTasks.length})
                        </div>
                        <div class="tab ${currentFilter === 'self' ? 'active' : ''}" onclick="filterTasks('self')">
                            Ëá™‰∏ª‰ªªÂä° (${allSelfTasks.length})
                        </div>
                        <div class="tab ${currentFilter === 'unavailable' ? 'active' : ''}" onclick="filterTasks('unavailable')">
                            ‰∏çÂèØÁî®Êó∂Èó¥ (${allUnavailableTimes.length})
                        </div>
                    </div>

                    <div class="content">
                        <!-- ÁªèÁêÜ‰ªªÂä° Tab -->
                        <div id="manager-tab" class="tab-content ${currentFilter === 'manager' ? 'active' : ''}">
                            <div class="sort-info">üìå ÁªèÁêÜÂàÜÈÖçÁöÑ‰ªªÂä°ÔºàÊåâÊà™Ê≠¢Êó•ÊúüÊéíÂ∫èÔºâ</div>
                            <div id="manager-tasks"></div>
                        </div>

                        <!-- Ëá™‰∏ª‰ªªÂä° Tab -->
                        <div id="self-tab" class="tab-content ${currentFilter === 'self' ? 'active' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="sort-info" style="margin-bottom: 0; flex: 1;">üìù ÊàëÁöÑËá™‰∏ª‰ªªÂä°</div>
                                <button class="section-action" onclick="showAddSelfTaskModal()">+ Ê∑ªÂä†‰ªªÂä°</button>
                        </div>
                            <div id="self-tasks"></div>
                </div>

                        <!-- ‰∏çÂèØÁî®Êó∂Èó¥ Tab -->
                        <div id="unavailable-tab" class="tab-content ${currentFilter === 'unavailable' ? 'active' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="sort-info" style="margin-bottom: 0; flex: 1;">üö´ ‰∏çÂèØÁî®Êó∂Èó¥ÔºàÂá∫Â∑Æ„ÄÅ‰ºöËÆÆ„ÄÅÂüπËÆ≠Á≠âÔºâ</div>
                                <button class="section-action" onclick="showAddUnavailableTimeModal()">+ Ê∑ªÂä†Êó∂Èó¥</button>
                    </div>
                            <div id="unavailable-times"></div>
                    </div>
                </div>
                </div>

                ${renderBottomNav()}
            `;

            renderAllTaskTabs();
        }
        
        // Ê∏≤ÊüìÊâÄÊúâ‰ªªÂä°TabÂÜÖÂÆπ
        function renderAllTaskTabs() {
            renderManagerTasks();
            renderSelfTasksList();
            renderUnavailableTimesList();
        }
        
        // Ê∏≤ÊüìÁªèÁêÜ‰ªªÂä°ÂàóË°®
        function renderManagerTasks() {
            const container = document.getElementById('manager-tasks');
            if (!container) return;
            
            if (allTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>ÊöÇÊó†ÁªèÁêÜÂàÜÈÖçÁöÑ‰ªªÂä°</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allTasks.map(task => {
                const deadlineClass = getDeadlineClass(task.deadline);
                let statusText = 'ÂæÖÂ§ÑÁêÜ';
                let statusClass = 'status-pending';
                
                if (task.status === 'accepted') {
                    statusText = 'ËøõË°å‰∏≠';
                    statusClass = 'status-accepted';
                } else if (task.status === 'completed') {
                    statusText = 'Â∑≤ÂÆåÊàê';
                    statusClass = 'status-completed';
                }

                // ÂÆåÊàêÊÉÖÂÜµÊòæÁ§∫
                let completionSection = '';
                if (task.status === 'completed') {
                    if (task.completionNote) {
                        // Â∑≤Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµ
                        completionSection = `
                            <div style="margin-top: 10px; padding: 12px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #166534; font-weight: 600;">‚úÖ ÂÆåÊàêÊÉÖÂÜµ</span>
                                    <span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Â∑≤Â°´ÂÜô</span>
                                </div>
                                <div style="font-size: 13px; color: #4b5563;">${task.completionNote}</div>
                                ${task.actualHours ? `<div style="font-size: 12px; color: #6b7280; margin-top: 5px;">ÂÆûÈôÖÁî®Êó∂: ${task.actualHours}Â∞èÊó∂</div>` : ''}
                                ${task.efficiencyRating ? `
                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #bbf7d0;">
                                        <div style="font-size: 12px; color: #8b5cf6; font-weight: 600;">üìä ÁªèÁêÜËØÑ‰ª∑</div>
                                        <div style="font-size: 12px; color: #6b7280; margin-top: 3px;">
                                            ÊïàÁéá: ${task.efficiencyRating}/10 ¬∑ Ë¥®Èáè: ${task.qualityRating}/10
                                        </div>
                                        ${task.reviewComment ? `<div style="font-size: 12px; color: #4b5563; margin-top: 3px;">${task.reviewComment}</div>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Êú™Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµ
                        completionSection = `
                            <div class="action-buttons" style="margin-top: 10px;">
                                <button class="btn" style="background: #8b5cf6; color: white;" onclick="showFillCompletionModal('manager', ${task.id}, null, '${task.name.replace(/'/g, "\\'")}')">
                                    üìù Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµ
                                </button>
                            </div>
                        `;
                    }
                }

                return `
                    <div class="task-card" style="${task.status === 'completed' ? 'border-left: 4px solid #22c55e;' : ''}">
                        <div class="task-header">
                            <div class="task-title">${task.name}</div>
                            <div class="task-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="task-desc">${task.description}</div>
                        <div class="task-meta">
                            ${task.deadline ? `
                                <div class="task-meta-item ${deadlineClass}">
                                    <span>‚è∞</span>
                                    <span>${formatDeadline(task.deadline)}</span>
                                </div>
                            ` : ''}
                            <div class="task-meta-item">
                                <span>üìÖ</span>
                                <span>ÂàÜÈÖç: ${formatDate(task.assignedAt)}</span>
                            </div>
                            <div class="task-meta-item">
                                <span>üë§</span>
                                <span>ÁªèÁêÜ: ${task.assignedByName}</span>
                            </div>
                            ${task.completedAt ? `
                                <div class="task-meta-item" style="color: #16a34a;">
                                    <span>‚úì</span>
                                    <span>ÂÆåÊàê: ${formatDate(task.completedAt)}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${task.status === 'pending' ? `
                            <div class="action-buttons">
                                <button class="btn btn-accept" onclick="acceptTask(${task.id})">‚úÖ Êé•Âèó‰ªªÂä°</button>
                                <button class="btn btn-reject" onclick="rejectTask(${task.id})">‚ùå ÊãíÁªù</button>
                            </div>
                        ` : ''}
                        ${completionSection}
                    </div>
                `;
            }).join('');
        }
        
        // Ê∏≤ÊüìËá™‰∏ª‰ªªÂä°ÂàóË°®
        // Ê∏≤ÊüìËá™‰∏ª‰ªªÂä°ÂàóË°®
        function renderSelfTasksList() {
            const container = document.getElementById('self-tasks');
            if (!container) return;
            
            if (allSelfTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <p>ÊöÇÊó†Ëá™‰∏ª‰ªªÂä°ÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊ∑ªÂä†</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allSelfTasks.map(task => {
                const isCompleted = task.status === 'completed';
                
                // ÂÆåÊàêÊÉÖÂÜµÊòæÁ§∫
                let completionSection = '';
                if (isCompleted) {
                    if (task.completionNote) {
                        // Â∑≤Â°´ÂÜôÂÆåÊàêËÆ∞ÂΩï
                        completionSection = `
                            <div style="margin-top: 10px; padding: 12px; background: #fffbeb; border-radius: 8px; border: 1px solid #fef3c7;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #b45309; font-weight: 600;">‚úÖ ÂÆåÊàêËÆ∞ÂΩï</span>
                                    <span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Â∑≤Â°´ÂÜô</span>
                                </div>
                                <div style="font-size: 13px; color: #4b5563;">${task.completionNote}</div>
                                ${task.actualHours ? `<div style="font-size: 12px; color: #6b7280; margin-top: 5px;">ÂÆûÈôÖÁî®Êó∂: ${task.actualHours}Â∞èÊó∂</div>` : ''}
                            </div>
                        `;
                    } else {
                        // Êú™Â°´ÂÜôÂÆåÊàêËÆ∞ÂΩï
                        completionSection = `
                            <div class="action-buttons" style="margin-top: 10px;">
                                <button class="btn" style="background: #f59e0b; color: white;" onclick="showFillCompletionModal('self', ${task.id}, null, '${task.name.replace(/'/g, "\\'")}')">
                                    üìù Â°´ÂÜôÂÆåÊàêËÆ∞ÂΩï
                                </button>
                            </div>
                        `;
                    }
                }
                
                return `
                    <div class="task-card" style="${isCompleted ? 'border-left: 4px solid #22c55e;' : ''}">
                        <div class="task-header">
                            <div class="task-title">${task.name}</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="type-badge type-${task.taskType}">${task.taskTypeLabel}</span>
                                ${isCompleted ? '<span class="task-status status-completed">Â∑≤ÂÆåÊàê</span>' : ''}
                            </div>
                        </div>
                        ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
                        <div class="task-meta">
                            <div class="task-meta-item">
                                <span>‚è±Ô∏è</span>
                                <span>È¢ÑËÆ° ${task.estimatedHours} Â∞èÊó∂</span>
                            </div>
                            ${task.deadline ? `
                                <div class="task-meta-item ${getDeadlineClass(task.deadline)}">
                                    <span>üìÖ</span>
                                    <span>Êà™Ê≠¢: ${formatDate(task.deadline)}</span>
                                </div>
                            ` : ''}
                            <div class="task-meta-item" style="color: #999;">
                                <span>üìù</span>
                                <span>ÂàõÂª∫: ${formatDate(task.createdAt)}</span>
                            </div>
                            ${task.completedAt ? `
                                <div class="task-meta-item" style="color: #16a34a;">
                                    <span>‚úì</span>
                                    <span>ÂÆåÊàê: ${formatDate(task.completedAt)}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${!isCompleted ? `
                            <div class="action-buttons" style="margin-top: 10px;">
                                <button class="btn btn-reject" onclick="deleteSelfTask(${task.id})">üóëÔ∏è Âà†Èô§</button>
                            </div>
                        ` : ''}
                        ${completionSection}
                    </div>
                `;
            }).join('');
        }
        
        // Ê∏≤Êüì‰∏çÂèØÁî®Êó∂Èó¥ÂàóË°®
        function renderUnavailableTimesList() {
            const container = document.getElementById('unavailable-times');
            if (!container) return;
            
            if (allUnavailableTimes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p>ÊöÇÊó†‰∏çÂèØÁî®Êó∂Èó¥ÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊ∑ªÂä†</p>
                    </div>
                `;
                return;
            }

            // ÊåâÊó•ÊúüÊéíÂ∫èÔºàÊúÄËøëÁöÑÂú®ÂâçÔºâ
            const sortedTimes = [...allUnavailableTimes].sort((a, b) => a.date.localeCompare(b.date));

            container.innerHTML = sortedTimes.map(time => `
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-title">${time.reasonTypeLabel}${time.note ? ' - ' + time.note : ''}</div>
                        <span class="type-badge type-${time.reasonType}">${time.reasonTypeLabel}</span>
                    </div>
                    <div class="task-meta">
                        <div class="task-meta-item">
                            <span>üìÖ</span>
                            <span>${time.date}</span>
                        </div>
                        <div class="task-meta-item">
                            <span>üïê</span>
                            <span>${time.startTime} - ${time.endTime}</span>
                        </div>
                        <div class="task-meta-item" style="color: #ef4444;">
                            <span>‚è±Ô∏è</span>
                            <span>${time.durationHours} Â∞èÊó∂</span>
                        </div>
                    </div>
                    <div class="action-buttons" style="margin-top: 10px;">
                        <button class="btn btn-reject" onclick="deleteUnavailableTime(${time.id})">üóëÔ∏è Âà†Èô§</button>
                    </div>
                </div>
            `).join('');
        }


        // Âà§Êñ≠Êà™Ê≠¢Êó•ÊúüÁ¥ßÊÄ•Á®ãÂ∫¶
        function getDeadlineClass(deadline) {
            if (!deadline) return '';
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diffDays = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0 || diffDays <= 1) return 'deadline-urgent';
            if (diffDays <= 3) return 'deadline-soon';
            return '';
        }

        // Ê†ºÂºèÂåñÊà™Ê≠¢Êó•Êúü
        function formatDeadline(deadline) {
            if (!deadline) return 'Êó†Êà™Ê≠¢Êó•Êúü';
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diffDays = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
            const dateStr = deadlineDate.toLocaleDateString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            if (diffDays < 0) return `${dateStr} (Â∑≤ÈÄæÊúü)`;
            if (diffDays === 0) return `${dateStr} (‰ªäÂ§©)`;
            if (diffDays === 1) return `${dateStr} (ÊòéÂ§©)`;
            if (diffDays <= 3) return `${dateStr} (${diffDays}Â§©Âêé)`;
            return dateStr;
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('zh-CN', {
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ËøáÊª§‰ªªÂä°/ÂàáÊç¢Tab
        function filterTasks(filter) {
            currentFilter = filter;
            saveLoginState();  // ‰øùÂ≠òTabÁä∂ÊÄÅ
            
            // Êõ¥Êñ∞TabÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ÊøÄÊ¥ªÂØπÂ∫îTab
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            if (filter === 'manager' && tabs[0] && tabContents[0]) {
                tabs[0].classList.add('active');
                document.getElementById('manager-tab').classList.add('active');
            } else if (filter === 'self' && tabs[1] && tabContents[1]) {
                tabs[1].classList.add('active');
                document.getElementById('self-tab').classList.add('active');
            } else if (filter === 'unavailable' && tabs[2] && tabContents[2]) {
                tabs[2].classList.add('active');
                document.getElementById('unavailable-tab').classList.add('active');
            }
        }

        // Êé•Âèó‰ªªÂä°
        async function acceptTask(id) {
            if (!confirm('Á°ÆËÆ§Êé•ÂèóÊ≠§‰ªªÂä°ÂêóÔºü')) return;

            try {
                await fetch(`${API_BASE}/assignments/${id}/accept`, { method: 'POST' });
                await loadTasks();
                showTaskPage();
                showScheduleUpdateReminder('Êé•Âèó‰ªªÂä°');
            } catch (err) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + err.message);
            }
        }

        // ÊãíÁªù‰ªªÂä°
        async function rejectTask(id) {
            const reason = prompt('ËØ∑ËæìÂÖ•ÊãíÁªùÁêÜÁî±Ôºö');
            if (!reason) return;

            try {
                await fetch(`${API_BASE}/assignments/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                await loadTasks();
                showTaskPage();
            } catch (err) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + err.message);
            }
        }

        // ÂàáÊç¢È°µÈù¢
        function switchPage(page) {
            currentPage = page;
            if (page === 'tasks') {
                showTaskPage();
            } else if (page === 'workload') {
                showWorkloadPage();
            } else if (page === 'schedule') {
                showSchedulePage();
            } else if (page === 'work') {
                showWorkPage();
            }
        }

        // ========== ÂºÄÂßãÂ∑•‰ΩúÊ®°Âùó ==========
        
        // ÊòæÁ§∫ÂºÄÂßãÂ∑•‰ΩúÈ°µÈù¢
        async function showWorkPage() {
            document.body.className = '';
            currentPage = 'work';
            saveLoginState();
            
            // ËÆæÁΩÆÂΩìÂâçÊó•Êúü
            const today = new Date().toISOString().split('T')[0];
            if (!currentWorkDate) {
                currentWorkDate = today;
            }
            
            // ÂÖàÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div class="work-page-header">
                        <div class="header-content">
                            <div>
                                <h1>üöÄ ÂºÄÂßãÂ∑•‰Ωú</h1>
                                <p>${currentUser.name} ¬∑ ‰ªäÊó•‰ªªÂä°ÂÆâÊéí</p>
                            </div>
                            <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                        </div>
                    </div>
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                        Âä†ËΩΩ‰ªäÊó•‰ªªÂä°...
                    </div>
                </div>
                ${renderBottomNav()}
            `;
            
            // Âä†ËΩΩÂ∑•‰Ωú‰ºöËØùÊï∞ÊçÆ
            await loadWorkSessionData();
            renderWorkPage();
        }
        
        // Âä†ËΩΩÂ∑•‰Ωú‰ºöËØùÊï∞ÊçÆ
        async function loadWorkSessionData() {
            try {
                const response = await fetch(`${API_BASE}/work-sessions/today/${currentUser.id}`);
                if (response.ok) {
                    workSessionData = await response.json();
                    console.log('Â∑•‰Ωú‰ºöËØùÊï∞ÊçÆ:', workSessionData);
                } else {
                    console.error('Âä†ËΩΩÂ∑•‰Ωú‰ºöËØùÂ§±Ë¥•');
                    workSessionData = { success: false, todayTasks: [], futureTasks: [] };
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∑•‰Ωú‰ºöËØùÈîôËØØ:', error);
                workSessionData = { success: false, todayTasks: [], futureTasks: [] };
            }
        }
        
        // Ê∏≤ÊüìÂºÄÂßãÂ∑•‰ΩúÈ°µÈù¢
        function renderWorkPage() {
            const today = new Date().toISOString().split('T')[0];
            
            // Ê£ÄÊü•ÊòØÂê¶ÂÆåÂÖ®Ê≤°ÊúâÂ∑≤Êé•ÂèóÁöÑÊó•Á®ãÔºàËøôÊó∂ÊâçÈúÄË¶ÅÂºïÂØºÔºâ
            if (!workSessionData?.success && !workSessionData?.hasPendingSchedule) {
                document.getElementById('app').innerHTML = `
                    <div class="main-content">
                        <div class="work-page-header">
                            <div class="header-content">
                                <div>
                                    <h1>üöÄ ÂºÄÂßãÂ∑•‰Ωú</h1>
                                    <p>${currentUser.name} ¬∑ ‰ªäÊó•‰ªªÂä°ÂÆâÊéí</p>
                                </div>
                                <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                            </div>
                        </div>
                        <div style="padding: 40px 20px; text-align: center;">
                            <div style="background: #f3f4f6; padding: 30px; border-radius: 16px; max-width: 350px; margin: 0 auto;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìã</div>
                                <h3 style="color: #374151; margin-bottom: 10px; font-size: 18px;">ÊöÇÊó†Êó•Á®ãÂÆâÊéí</h3>
                                <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">ËØ∑ÂÖàÂà∞Êó•Á®ãÂà∂ÂÆöÊ®°ÂùóÁîüÊàêÂπ∂Êé•ÂèóÊó•Á®ã</p>
                                <button onclick="switchPage('schedule')" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    padding: 12px 24px;
                                    border-radius: 10px;
                                    font-size: 14px;
                                    font-weight: 600;
                                    cursor: pointer;
                                ">ÂéªÂà∂ÂÆöÊó•Á®ã ‚Üí</button>
                            </div>
                        </div>
                    </div>
                    ${renderBottomNav()}
                `;
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÊéíÁ®ãÔºàÂèØÈÄâÊèêÁ§∫Ôºâ
            let needsUpdateHtml = '';
            if (workSessionData?.needsScheduleUpdate) {
                needsUpdateHtml = `
                    <div style="margin: 10px 15px; padding: 12px 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 1px solid #fcd34d; display: flex; align-items: center; justify-content: space-between;">
                        <div style="flex: 1;">
                            <div style="font-size: 13px; font-weight: 600; color: #92400e;">üîî ÊúâÊñ∞‰ªªÂä°ÔºåÂèØÊõ¥Êñ∞Êó•Á®ã</div>
                            <div style="font-size: 11px; color: #b45309; margin-top: 2px;">${workSessionData.updateReason || 'ÊúâÊñ∞‰ªªÂä°ÈúÄË¶ÅÊéíÁ®ã'}</div>
                        </div>
                        <button onclick="switchPage('schedule')" style="
                            background: #f59e0b;
                            color: white;
                            border: none;
                            padding: 8px 12px;
                            border-radius: 6px;
                            font-size: 12px;
                            font-weight: 600;
                            cursor: pointer;
                            white-space: nowrap;
                        ">ÂéªÊõ¥Êñ∞</button>
                    </div>
                `;
            }
            
            const dates = workSessionData?.dates || [today];
            
            // ËÆ°ÁÆóÊØèÂ§©ÁöÑ‰ªªÂä°Êï∞Èáè
            const todayTasks = workSessionData?.todayTasks || [];
            const futureTasks = workSessionData?.futureTasks || [];
            
            // ÊåâÊó•ÊúüÂàÜÁªÑÊú™Êù•‰ªªÂä°
            const futureDateTasks = {};
            futureTasks.forEach(task => {
                if (!futureDateTasks[task.date]) {
                    futureDateTasks[task.date] = [];
                }
                futureDateTasks[task.date].push(task);
            });
            
            // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠Êó•ÊúüÁöÑ‰ªªÂä°
            let currentTasks = [];
            let unavailableTimes = [];
            
            if (currentWorkDate === today) {
                currentTasks = todayTasks;
                unavailableTimes = workSessionData?.unavailableTimes || [];
            } else {
                currentTasks = futureDateTasks[currentWorkDate] || [];
            }
            
            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div class="work-page-header">
                        <div class="header-content">
                            <div>
                                <h1>üöÄ ÂºÄÂßãÂ∑•‰Ωú</h1>
                                <p>${currentUser.name} ¬∑ ${formatDateLabel(currentWorkDate)}</p>
                            </div>
                            <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                        </div>
                    </div>
                    
                    ${needsUpdateHtml}
                    
                    <div class="work-date-section">
                        <div class="work-date-tabs">
                            ${dates.map((date, idx) => {
                                const taskCount = date === today ? todayTasks.length : (futureDateTasks[date]?.length || 0);
                                const isToday = date === today;
                                const isActive = date === currentWorkDate;
                                return `
                                    <div class="work-date-tab ${isActive ? 'active' : ''} ${isToday ? 'today' : ''}" 
                                         onclick="switchWorkDate('${date}')">
                                        <div style="font-weight: 600;">${isToday ? '‰ªäÂ§©' : formatShortDate(date)}</div>
                                        <div style="font-size: 11px; color: ${isActive ? '#059669' : '#9ca3af'};">
                                            ${taskCount}‰∏™‰ªªÂä°
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="work-task-list">
                            ${renderWorkTaskList(currentTasks, unavailableTimes, currentWorkDate === today)}
                        </div>
                    </div>
                </div>
                ${renderBottomNav()}
            `;
            
            // Â¶ÇÊûúÊúâÊ≠£Âú®ËøõË°åÁöÑ‰ªªÂä°ÔºåÂêØÂä®ËÆ°Êó∂Âô®
            startWorkTimerIfNeeded();
        }
        
        // Ê∏≤Êüì‰ªªÂä°ÂàóË°®
        function renderWorkTaskList(tasks, unavailableTimes, isToday) {
            if (tasks.length === 0 && unavailableTimes.length === 0) {
                return `
                    <div class="work-empty">
                        <div class="work-empty-icon">üì≠</div>
                        <div class="work-empty-text">ÊöÇÊó†‰ªªÂä°ÂÆâÊéí</div>
                        <div style="margin-top: 10px; font-size: 12px;">
                            ËØ∑ÂÖàÂú®"Êó•Á®ãÂà∂ÂÆö"Ê®°ÂùóÁîüÊàêÊéíÁ®ã
                        </div>
                    </div>
                `;
            }
            
            let html = '';
            
            // ÊòæÁ§∫‰∏çÂèØÁî®Êó∂Èó¥
            unavailableTimes.forEach(ut => {
                html += `
                    <div class="work-unavailable-card">
                        <div class="work-unavailable-title">
                            üö´ ${ut.reasonTypeLabel}
                        </div>
                        <div class="work-unavailable-time">
                            ${ut.startTime} - ${ut.endTime}Ôºà${ut.durationHours}Â∞èÊó∂Ôºâ
                            ${ut.note ? `<div style="margin-top: 5px; font-size: 12px; color: #78716c;">${ut.note}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            // ÊòæÁ§∫‰ªªÂä°
            tasks.forEach(task => {
                html += renderWorkTaskCard(task, isToday);
            });
            
            return html;
        }
        
        // Ê∏≤ÊüìÂçï‰∏™‰ªªÂä°Âç°Áâá
        function renderWorkTaskCard(task, isToday) {
            const statusClass = task.status;
            const overtimeStatus = task.overtimeStatus;
            
            // Áä∂ÊÄÅÂæΩÁ´†
            let statusBadge = '';
            if (task.status === 'completed') {
                statusBadge = '<span class="work-status-badge completed">‚úì Â∑≤ÂÆåÊàê</span>';
            } else if (overtimeStatus === 'overtime') {
                statusBadge = '<span class="work-status-badge overtime">‚ö†Ô∏è Â∑≤Ë∂ÖÊó∂</span>';
            } else if (overtimeStatus === 'overwork') {
                statusBadge = '<span class="work-status-badge overwork">üî• Âä†Áè≠‰∏≠</span>';
            } else if (task.status === 'working') {
                statusBadge = '<span class="work-status-badge working">‚óè ËøõË°å‰∏≠</span>';
            } else if (task.status === 'paused') {
                statusBadge = '<span class="work-status-badge paused">‚è∏ Â∑≤ÊöÇÂÅú</span>';
            } else {
                statusBadge = '<span class="work-status-badge pending">‚óã ÂæÖÂºÄÂßã</span>';
            }
            
            // ËÆ°Êó∂Âô®ÂíåËøõÂ∫¶
            let timerSection = '';
            if (isToday && task.status !== 'pending') {
                const workedSeconds = task.totalWorkedSeconds || 0;
                const plannedSeconds = task.plannedSeconds || (task.plannedHours * 3600);
                const progress = Math.min(100, (workedSeconds / plannedSeconds) * 100);
                const progressClass = progress > 100 ? 'danger' : (progress > 80 ? 'warning' : '');
                const timerClass = task.overtimeStatus === 'overtime' ? 'overtime' : (task.overtimeStatus === 'overwork' ? 'overwork' : '');
                
                timerSection = `
                    <div class="work-timer-section">
                        <div class="work-timer-display">
                            <div class="work-timer ${timerClass}" data-session-id="${task.id}" data-started="${task.status === 'working'}">
                                ${formatTime(workedSeconds)}
                            </div>
                            <div class="work-planned">
                                ËÆ°Âàí: ${task.plannedHours}Â∞èÊó∂
                            </div>
                        </div>
                        <div class="work-progress-bar">
                            <div class="work-progress-fill ${progressClass}" style="width: ${Math.min(100, progress)}%"></div>
                        </div>
                        ${renderWorkActions(task, isToday)}
                    </div>
                `;
                
                // ‰∏≠Êñ≠ËÆ∞ÂΩï
                if (task.interruptions && task.interruptions.length > 0) {
                    timerSection += `
                        <div class="work-interruptions">
                            <div class="work-interruptions-title">üìã ‰∏≠Êñ≠ËÆ∞ÂΩïÔºà${task.interruptions.length}Ê¨°Ôºâ</div>
                            ${task.interruptions.map(i => `
                                <div class="work-interruption-item">
                                    <span>${i.reason}</span>
                                    <span>${i.durationMinutes ? i.durationMinutes + 'ÂàÜÈíü' : 'ËøõË°å‰∏≠'}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else if (isToday) {
                // ÂæÖÂºÄÂßãÁä∂ÊÄÅÊòæÁ§∫ÂºÄÂßãÊåâÈíÆ
                timerSection = `
                    <div class="work-timer-section">
                        <div class="work-actions">
                            <button class="work-btn work-btn-start" onclick="startWork(${JSON.stringify(task).replace(/"/g, '&quot;')})">
                                ‚ñ∂Ô∏è ÂºÄÂßãÂ∑•‰Ωú
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="work-task-card ${statusClass}">
                    <div class="work-task-header">
                        <div class="work-task-info">
                            <span class="work-task-type ${task.taskType}">
                                ${task.taskTypeLabel}
                            </span>
                            <div class="work-task-name">${task.taskName}</div>
                            <div class="work-task-meta">
                                ${task.deadline ? `Êà™Ê≠¢: ${task.deadline.split('T')[0]}` : ''}
                                ¬∑ ‰ªäÊó•ÂÆâÊéí: ${task.plannedHours}h
                            </div>
                        </div>
                        <div class="work-task-status">
                            ${statusBadge}
                        </div>
                    </div>
                    ${timerSection}
                </div>
            `;
        }
        
        // Ê∏≤ÊüìÊìç‰ΩúÊåâÈíÆ
        function renderWorkActions(task, isToday) {
            if (!isToday || task.status === 'completed') return '';
            
            if (task.status === 'working') {
                return `
                    <div class="work-actions">
                        <button class="work-btn work-btn-pause" onclick="pauseWork(${task.id})">
                            ‚è∏ ‰∏≠Êñ≠
                        </button>
                        <button class="work-btn work-btn-complete" onclick="completeWork(${task.id})">
                            ‚úì ÂÆåÊàê
                        </button>
                    </div>
                `;
            } else if (task.status === 'paused') {
                return `
                    <div class="work-actions">
                        <button class="work-btn work-btn-resume" onclick="resumeWork(${task.id})">
                            ‚ñ∂Ô∏è ÊÅ¢Â§ç
                        </button>
                        <button class="work-btn work-btn-complete" onclick="completeWork(${task.id})">
                            ‚úì ÂÆåÊàê
                        </button>
                    </div>
                `;
            }
            
            return '';
        }
        
        // ÂàáÊç¢Â∑•‰ΩúÊó•Êúü
        function switchWorkDate(date) {
            currentWorkDate = date;
            renderWorkPage();
        }
        
        // ÂºÄÂßãÂ∑•‰Ωú
        async function startWork(task) {
            try {
                const response = await fetch(`${API_BASE}/work-sessions/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_id: currentUser.id,
                        schedule_item_id: task.scheduleItemId,
                        task_type: task.taskType,
                        task_id: task.taskId,
                        task_name: task.taskName,
                        date: task.date,
                        planned_hours: task.plannedHours,
                        is_today_only: task.isTodayOnly,
                        deadline: task.deadline
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                    await loadWorkSessionData();
                    renderWorkPage();
                } else {
                    alert(result.message || 'ÂºÄÂßãÂ∑•‰ΩúÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂºÄÂßãÂ∑•‰ΩúÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÊöÇÂÅú/‰∏≠Êñ≠Â∑•‰Ωú
        function pauseWork(sessionId) {
            // ÊòæÁ§∫‰∏≠Êñ≠ÂéüÂõ†ËæìÂÖ•ÂºπÁ™ó
            const modalHtml = `
                <div class="pause-modal" id="pauseModal">
                    <div class="pause-modal-content">
                        <div class="pause-modal-header">
                            ‚è∏ ‰∏≠Êñ≠‰ªªÂä°
                        </div>
                        <div class="pause-modal-body">
                            <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                ËØ∑ËØ¥Êòé‰∏≠Êñ≠ÂéüÂõ†ÔºàÂ¶ÇÔºö‰∏¥Êó∂‰ºöËÆÆ„ÄÅÁ¥ßÊÄ•‰∫ãÂä°Á≠âÔºâ
                            </p>
                            <textarea class="pause-reason-input" id="pauseReason" placeholder="ËØ∑ËæìÂÖ•‰∏≠Êñ≠ÂéüÂõ†..."></textarea>
                        </div>
                        <div class="pause-modal-footer">
                            <button class="work-btn" style="background: #e5e7eb; color: #4b5563;" onclick="closePauseModal()">
                                ÂèñÊ∂à
                            </button>
                            <button class="work-btn work-btn-pause" onclick="confirmPause(${sessionId})">
                                Á°ÆËÆ§‰∏≠Êñ≠
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // ÂÖ≥Èó≠‰∏≠Êñ≠ÂºπÁ™ó
        function closePauseModal() {
            const modal = document.getElementById('pauseModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Á°ÆËÆ§‰∏≠Êñ≠
        async function confirmPause(sessionId) {
            const reason = document.getElementById('pauseReason').value.trim();
            
            if (!reason) {
                alert('ËØ∑ËæìÂÖ•‰∏≠Êñ≠ÂéüÂõ†');
                return;
            }
            
            closePauseModal();
            
            try {
                const response = await fetch(`${API_BASE}/work-sessions/${sessionId}/pause`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    stopWorkTimer();
                    await loadWorkSessionData();
                    renderWorkPage();
                } else {
                    alert(result.message || 'ÊöÇÂÅúÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÊöÇÂÅúÂ∑•‰ΩúÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÊÅ¢Â§çÂ∑•‰Ωú
        async function resumeWork(sessionId) {
            try {
                const response = await fetch(`${API_BASE}/work-sessions/${sessionId}/resume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadWorkSessionData();
                    renderWorkPage();
                } else {
                    alert(result.message || 'ÊÅ¢Â§çÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÊÅ¢Â§çÂ∑•‰ΩúÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÂÆåÊàêÂ∑•‰Ωú
        async function completeWork(sessionId) {
            if (!confirm('Á°ÆËÆ§ÂÆåÊàêËØ•‰ªªÂä°ÂêóÔºü')) return;
            
            try {
                const response = await fetch(`${API_BASE}/work-sessions/${sessionId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    stopWorkTimer();
                    
                    const session = result.session;
                    const stats = result.statistics;
                    
                    // ÊòæÁ§∫ÂÆåÊàêÁªüËÆ°ÂíåÂ°´ÂÜôÂÆåÊàêÊÉÖÂÜµÁöÑÈÄâÈ°π
                    showCompletionDialog(session, stats);
                    
                    await loadWorkSessionData();
                    renderWorkPage();
                } else {
                    alert(result.message || 'ÂÆåÊàêÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂÆåÊàêÂ∑•‰ΩúÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÊòæÁ§∫ÂÆåÊàêÊÉÖÂÜµÂ°´ÂÜôÂºπÁ™ó
        function showCompletionDialog(session, stats) {
            const escapedTaskName = session.taskName.replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const modalHtml = `
                <div class="pause-modal" id="completionModal">
                    <div class="pause-modal-content" style="max-width: 450px;">
                        <div class="pause-modal-header" style="background: #22c55e;">
                            üéâ ‰ªªÂä°ÂÆåÊàêÔºÅ
                        </div>
                        <div class="pause-modal-body">
                            <div class="work-complete-stats" style="margin: 0 0 15px 0;">
                                <div class="work-complete-title">${session.taskName}</div>
                                <div class="work-complete-row">
                                    <span>ËÆ°ÂàíÁî®Êó∂</span>
                                    <span>${stats.plannedHours}Â∞èÊó∂</span>
                                </div>
                                <div class="work-complete-row">
                                    <span>ÂÆûÈôÖÁî®Êó∂</span>
                                    <span>${stats.workedHours}Â∞èÊó∂</span>
                                </div>
                                <div class="work-complete-row">
                                    <span>Â∑•‰ΩúÊïàÁéá</span>
                                    <span>${stats.efficiency > 100 ? '‚ö°' : ''}${Math.min(stats.efficiency, 999)}%</span>
                                </div>
                                <div class="work-complete-row">
                                    <span>‰∏≠Êñ≠Ê¨°Êï∞</span>
                                    <span>${stats.interruptions}Ê¨°</span>
                                </div>
                            </div>
                            <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
                                ÊòØÂê¶ÈúÄË¶ÅÂ°´ÂÜôÂÆåÊàêÊÉÖÂÜµÔºüÔºà${session.taskType === 'manager' ? 'ÁªèÁêÜ‰ªªÂä°ÈúÄÊèê‰∫§' : 'Ëá™‰∏ª‰ªªÂä°ÂèØ‰øùÂ≠ò'}Ôºâ
                            </p>
                        </div>
                        <div class="pause-modal-footer">
                            <button class="work-btn" style="background: #e5e7eb; color: #4b5563;" onclick="closeCompletionModal()">
                                Á®çÂêéÂ°´ÂÜô
                            </button>
                            <button class="work-btn work-btn-complete" onclick="goToFillCompletion('${session.taskType}', ${session.taskId}, ${stats.workedHours}, '${escapedTaskName}')">
                                Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // ÂÖ≥Èó≠ÂÆåÊàêÊÉÖÂÜµÂºπÁ™ó
        function closeCompletionModal() {
            const modal = document.getElementById('completionModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Ë∑≥ËΩ¨Âà∞Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµÈ°µÈù¢
        function goToFillCompletion(taskType, taskId, actualHours, taskName = '') {
            closeCompletionModal();
            // ‰øùÂ≠òÂèÇÊï∞Âà∞ÂÖ®Â±ÄÂèòÈáè
            window.pendingCompletion = {
                taskType: taskType,
                taskId: taskId,
                actualHours: actualHours,
                taskName: taskName
            };
            // Ë∑≥ËΩ¨Âà∞ÊàëÁöÑ‰ªªÂä°È°µÈù¢
            currentFilter = taskType === 'manager' ? 'manager' : 'self';
            switchPage('tasks');
            // Âª∂ËøüÊòæÁ§∫Â°´ÂÜôÂºπÁ™ó
            setTimeout(() => {
                showFillCompletionModal(taskType, taskId, actualHours, taskName);
            }, 300);
        }
        
        // ÊòæÁ§∫Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµÁöÑÂºπÁ™ó
        function showFillCompletionModal(taskType, taskId, actualHours, taskName = '') {
            const isManagerTask = taskType === 'manager';
            
            // Â¶ÇÊûúÊ≤°Êúâ‰º†ÂÖ•‰ªªÂä°ÂêçÁß∞ÔºåÂ∞ùËØï‰ªéÊï∞ÊçÆ‰∏≠Êü•Êâæ
            if (!taskName) {
                if (isManagerTask) {
                    const task = allTasks.find(t => t.id === taskId);
                    taskName = task ? task.name : 'Êú™Áü•‰ªªÂä°';
                } else {
                    const task = allSelfTasks.find(t => t.id === taskId);
                    taskName = task ? task.name : 'Êú™Áü•‰ªªÂä°';
                }
            }
            
            const modalHtml = `
                <div class="pause-modal" id="fillCompletionModal">
                    <div class="pause-modal-content" style="max-width: 450px;">
                        <div class="pause-modal-header" style="background: ${isManagerTask ? '#8b5cf6' : '#f59e0b'};">
                            üìù Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµ
                        </div>
                        <div class="pause-modal-body">
                            <div style="margin-bottom: 15px; padding: 12px; background: ${isManagerTask ? '#f5f3ff' : '#fffbeb'}; border-radius: 8px; border: 1px solid ${isManagerTask ? '#ddd6fe' : '#fef3c7'};">
                                <div style="font-size: 12px; color: ${isManagerTask ? '#7c3aed' : '#b45309'}; margin-bottom: 5px;">
                                    ${isManagerTask ? 'üìå ÁªèÁêÜ‰ªªÂä°' : 'üìù Ëá™‰∏ª‰ªªÂä°'}
                                </div>
                                <div style="font-size: 15px; font-weight: 600; color: #1f2937;">${taskName}</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 8px;">
                                    ÂÆûÈôÖÁî®Êó∂ÔºàÂ∞èÊó∂Ôºâ
                                </label>
                                <input type="number" id="completionHours" step="0.5" min="0" 
                                       value="${actualHours || ''}" 
                                       style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 8px;">
                                    ÂÆåÊàêÊÉÖÂÜµËØ¥Êòé
                                </label>
                                <textarea id="completionNote" placeholder="ËØ∑ÊèèËø∞‰ªªÂä°ÂÆåÊàêÊÉÖÂÜµ„ÄÅÈÅáÂà∞ÁöÑÈóÆÈ¢ò„ÄÅÊàêÊûúÁ≠â..."
                                          style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; min-height: 120px; resize: vertical;"></textarea>
                            </div>
                            ${isManagerTask ? `
                                <div style="font-size: 12px; color: #8b5cf6; background: #f5f3ff; padding: 10px; border-radius: 8px;">
                                    üí° Êèê‰∫§ÂêéÔºåÁªèÁêÜÂ∞ÜÂú®ÁÆ°ÁêÜÁ´ØÁúãÂà∞ÊÇ®ÁöÑÂÆåÊàêÊÉÖÂÜµ
                                </div>
                            ` : `
                                <div style="font-size: 12px; color: #b45309; background: #fffbeb; padding: 10px; border-radius: 8px;">
                                    üí° Ëá™‰∏ª‰ªªÂä°ÂÆåÊàêËÆ∞ÂΩï‰ªÖ‰æõ‰∏™‰∫∫Êü•Áúã
                                </div>
                            `}
                        </div>
                        <div class="pause-modal-footer">
                            <button class="work-btn" style="background: #e5e7eb; color: #4b5563;" onclick="closeFillCompletionModal()">
                                ÂèñÊ∂à
                            </button>
                            <button class="work-btn" style="background: ${isManagerTask ? '#8b5cf6' : '#f59e0b'}; color: white;" 
                                    onclick="submitCompletion('${taskType}', ${taskId})">
                                ${isManagerTask ? 'Êèê‰∫§' : '‰øùÂ≠ò'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // ÂÖ≥Èó≠Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµÂºπÁ™ó
        function closeFillCompletionModal() {
            const modal = document.getElementById('fillCompletionModal');
            if (modal) {
                modal.remove();
            }
            window.pendingCompletion = null;
        }
        
        // Êèê‰∫§ÂÆåÊàêÊÉÖÂÜµ
        async function submitCompletion(taskType, taskId) {
            const actualHours = parseFloat(document.getElementById('completionHours').value) || 0;
            const completionNote = document.getElementById('completionNote').value.trim();
            
            if (!completionNote) {
                alert('ËØ∑Â°´ÂÜôÂÆåÊàêÊÉÖÂÜµËØ¥Êòé');
                return;
            }
            
            try {
                let url, body;
                if (taskType === 'manager') {
                    url = `${API_BASE}/assignments/${taskId}/complete`;
                    body = {
                        actual_hours: actualHours,
                        completion_note: completionNote
                    };
                } else {
                    url = `${API_BASE}/self-tasks/${taskId}/complete`;
                    body = {
                        actual_hours: actualHours,
                        completion_note: completionNote
                    };
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeFillCompletionModal();
                    alert(taskType === 'manager' ? '‚úÖ ÂÆåÊàêÊÉÖÂÜµÂ∑≤Êèê‰∫§ÔºÅ' : '‚úÖ ÂÆåÊàêËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÔºÅ');
                    // Âà∑Êñ∞‰ªªÂä°ÂàóË°®
                    await loadTasks();
                    await loadAllSelfTasks();
                    showTaskPage();
                } else {
                    alert(result.message || 'Êèê‰∫§Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Êèê‰∫§ÂÆåÊàêÊÉÖÂÜµÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÂêØÂä®ËÆ°Êó∂Âô®ÔºàÂ¶ÇÊûúÊúâÊ≠£Âú®ËøõË°åÁöÑ‰ªªÂä°Ôºâ
        function startWorkTimerIfNeeded() {
            const workingTask = (workSessionData?.todayTasks || []).find(t => t.status === 'working');
            
            if (workingTask && workingTask.id) {
                startWorkTimer(workingTask);
            }
        }
        
        // ÂêØÂä®ËÆ°Êó∂Âô®
        function startWorkTimer(task) {
            stopWorkTimer();  // ÂÖàÂÅúÊ≠¢‰πãÂâçÁöÑËÆ°Êó∂Âô®
            
            const sessionId = task.id;
            let workedSeconds = task.totalWorkedSeconds || 0;
            const plannedSeconds = task.plannedSeconds || (task.plannedHours * 3600);
            
            // ËÆ°ÁÆó‰ªé‰∏äÊ¨°ÊÅ¢Â§ç/ÂºÄÂßãÂà∞Áé∞Âú®ÁöÑÊó∂Èó¥
            let lastResumeTime = task.startedAt ? new Date(task.startedAt) : new Date();
            
            // Â¶ÇÊûúÊúâ‰∏≠Êñ≠ËÆ∞ÂΩïÔºåÊâæÊúÄÂêé‰∏ÄÊ¨°ÊÅ¢Â§çÊó∂Èó¥
            if (task.interruptions && task.interruptions.length > 0) {
                const lastInterruption = task.interruptions[task.interruptions.length - 1];
                if (lastInterruption.resumedAt) {
                    lastResumeTime = new Date(lastInterruption.resumedAt);
                }
            }
            
            const now = new Date();
            const additionalSeconds = Math.floor((now - lastResumeTime) / 1000);
            workedSeconds += additionalSeconds;
            
            // Êõ¥Êñ∞ËÆ°Êó∂Âô®ÊòæÁ§∫
            const timerElement = document.querySelector(`.work-timer[data-session-id="${sessionId}"]`);
            if (timerElement) {
                timerElement.textContent = formatTime(workedSeconds);
            }
            
            // ÊØèÁßíÊõ¥Êñ∞
            workTimerInterval = setInterval(() => {
                workedSeconds++;
                
                const timerEl = document.querySelector(`.work-timer[data-session-id="${sessionId}"]`);
                if (timerEl) {
                    timerEl.textContent = formatTime(workedSeconds);
                    
                    // Êõ¥Êñ∞Ë∂ÖÊó∂Áä∂ÊÄÅ
                    if (workedSeconds > plannedSeconds) {
                        timerEl.classList.add(task.isTodayOnly ? 'overtime' : 'overwork');
                    }
                }
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                const progressFill = document.querySelector(`.work-task-card.working .work-progress-fill`);
                if (progressFill) {
                    const progress = Math.min(100, (workedSeconds / plannedSeconds) * 100);
                    progressFill.style.width = progress + '%';
                    
                    if (progress > 100) {
                        progressFill.classList.add('danger');
                    } else if (progress > 80) {
                        progressFill.classList.add('warning');
                    }
                }
            }, 1000);
            
            // ÊØè60ÁßíÂêåÊ≠•Âà∞ÊúçÂä°Âô®
            workTimer = setInterval(async () => {
                try {
                    await fetch(`${API_BASE}/work-sessions/${sessionId}/update-time`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ additional_seconds: 60 })
                    });
                } catch (error) {
                    console.error('ÂêåÊ≠•Â∑•‰ΩúÊó∂Èó¥Â§±Ë¥•:', error);
                }
            }, 60000);
        }
        
        // ÂÅúÊ≠¢ËÆ°Êó∂Âô®
        function stopWorkTimer() {
            if (workTimerInterval) {
                clearInterval(workTimerInterval);
                workTimerInterval = null;
            }
            if (workTimer) {
                clearInterval(workTimer);
                workTimer = null;
            }
        }
        
        // Ê†ºÂºèÂåñÊó∂Èó¥ÔºàÁßí -> HH:MM:SSÔºâ
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        // Ê†ºÂºèÂåñÊó•ÊúüÊ†áÁ≠æ
        function formatDateLabel(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const targetDate = new Date(date);
            targetDate.setHours(0, 0, 0, 0);
            
            const diff = (targetDate - today) / (1000 * 60 * 60 * 24);
            
            if (diff === 0) return '‰ªäÂ§©';
            if (diff === 1) return 'ÊòéÂ§©';
            if (diff === 2) return 'ÂêéÂ§©';
            
            const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
            return `${date.getMonth() + 1}Êúà${date.getDate()}Êó• ${weekdays[date.getDay()]}`;
        }
        
        // Ê†ºÂºèÂåñÁü≠Êó•Êúü
        function formatShortDate(dateStr) {
            const date = new Date(dateStr);
            const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            return `${date.getMonth() + 1}/${date.getDate()} Âë®${weekdays[date.getDay()]}`;
        }

        // ÊòæÁ§∫Ë¥üËΩΩÈ°µÈù¢
        async function showWorkloadPage() {
            document.body.className = '';
            currentPage = 'workload';
            saveLoginState();  // ‰øùÂ≠òÁôªÂΩïÁä∂ÊÄÅ

            // ÂÖàÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div class="workload-header">
                        <div class="header-content">
                            <div>
                                <h1>üìä ÊàëÁöÑË¥üËΩΩ</h1>
                                <p>${currentUser.name} ¬∑ Êú¨Âë®Â∑•‰ΩúË¥üËΩΩ</p>
                            </div>
                            <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 50px; color: #666;">
                        Âä†ËΩΩ‰∏≠...
                    </div>
                </div>
                <div class="bottom-nav">
                    <div class="nav-item" onclick="switchPage('tasks')">
                        <div class="nav-icon">üìã</div>
                        <div class="nav-label">ÊàëÁöÑ‰ªªÂä°</div>
                    </div>
                    <div class="nav-item active" onclick="switchPage('workload')">
                        <div class="nav-icon">üìä</div>
                        <div class="nav-label">ÊàëÁöÑË¥üËΩΩ</div>
                    </div>
                    <div class="nav-item" onclick="switchPage('schedule')">
                        <div class="nav-icon">üìÖ</div>
                        <div class="nav-label">Êó•Á®ãÂà∂ÂÆö</div>
                    </div>
                </div>
            `;

            // Âä†ËΩΩË¥üËΩΩÊï∞ÊçÆ
            await loadWorkloadData();
            renderWorkloadPage();
        }

        // Âä†ËΩΩË¥üËΩΩÊï∞ÊçÆ
        async function loadWorkloadData() {
            try {
                const response = await fetch(`${API_BASE}/workload/${currentUser.id}`);
                if (response.ok) {
                    workloadData = await response.json();
                    selfTasks = workloadData.selfTasks || [];
                    unavailableTimes = workloadData.unavailableTimes || [];
                }
            } catch (error) {
                console.error('Âä†ËΩΩË¥üËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
                workloadData = null;
            }
        }
        
        // Âä†ËΩΩÊâÄÊúâËá™‰∏ª‰ªªÂä°Ôºà‰∏çÈôêÊú¨Âë®Ôºâ
        async function loadAllSelfTasks() {
            try {
                const response = await fetch(`${API_BASE}/self-tasks?employee_id=${currentUser.id}`);
                if (response.ok) {
                    allSelfTasks = await response.json();
                }
            } catch (error) {
                console.error('Âä†ËΩΩËá™‰∏ª‰ªªÂä°Â§±Ë¥•:', error);
                allSelfTasks = [];
            }
        }
        
        // Âä†ËΩΩÊâÄÊúâ‰∏çÂèØÁî®Êó∂Èó¥Ôºà‰∏çÈôêÊú¨Âë®Ôºâ
        async function loadAllUnavailableTimes() {
            try {
                const response = await fetch(`${API_BASE}/unavailable-times?employee_id=${currentUser.id}`);
                if (response.ok) {
                    allUnavailableTimes = await response.json();
                }
            } catch (error) {
                console.error('Âä†ËΩΩ‰∏çÂèØÁî®Êó∂Èó¥Â§±Ë¥•:', error);
                allUnavailableTimes = [];
            }
        }
        
        // Âä†ËΩΩ‰ªªÂä°È°µÈù¢ÊâÄÈúÄÁöÑÊâÄÊúâÊï∞ÊçÆ
        async function loadTaskPageData() {
            await Promise.all([
                loadWorkloadData(),
                loadAllSelfTasks(),
                loadAllUnavailableTimes()
            ]);
        }

        // Ê∏≤ÊüìË¥üËΩΩÈ°µÈù¢
        function renderWorkloadPage() {
            if (!workloadData) {
                document.getElementById('app').innerHTML = `
                    <div class="main-content">
                        <div class="workload-header">
                            <div class="header-content">
                                <div>
                                    <h1>üìä ÊàëÁöÑË¥üËΩΩ</h1>
                                    <p>${currentUser.name}</p>
                                </div>
                                <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                            </div>
                        </div>
                        <div style="text-align: center; padding: 50px; color: #999;">
                            Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï
                        </div>
                    </div>
                    ${renderBottomNav()}
                `;
                return;
            }

            const stats = workloadData.statistics;
            const gaugeLevel = stats.workloadLevel;
            const workloadColor = getWorkloadColor(gaugeLevel);

            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div class="workload-header">
                        <div class="header-content">
                            <div>
                                <h1>üìä ÊàëÁöÑË¥üËΩΩ</h1>
                                <p>${currentUser.name} ¬∑ ${formatDateRange(workloadData.dateRange.startDate, workloadData.dateRange.endDate)}</p>
                            </div>
                            <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                        </div>
                    </div>

                    <!-- Ë¥üËΩΩÊåáÁ§∫Âô®ÔºàÂúÜÁéØÔºâ -->
                    <div class="workload-indicator">
                        ${renderWorkloadCircle(stats.workloadRatio, workloadColor, stats.workloadLabel)}
                        
                        <div style="margin-top: 20px; text-align: left;">
                            <div class="workload-detail-row">
                                <span class="workload-detail-label">Êú¨Âë®Â∑•‰ΩúÊó•</span>
                                <span class="workload-detail-value">${stats.workDays} Â§©</span>
                            </div>
                            <div class="workload-detail-row">
                                <span class="workload-detail-label">ÊÄªÂèØÁî®Â∑•Êó∂</span>
                                <span class="workload-detail-value">${stats.totalAvailableHours}h</span>
                            </div>
                            <div class="workload-detail-row">
                                <span class="workload-detail-label">‰∏çÂèØÁî®Êó∂Èó¥</span>
                                <span class="workload-detail-value" style="color: #ef4444;">-${stats.unavailableHours}h</span>
                            </div>
                            <div class="workload-detail-row">
                                <span class="workload-detail-label">ÂÆûÈôÖÂèØÁî®Â∑•Êó∂</span>
                                <span class="workload-detail-value" style="color: #3b82f6;">${stats.actualAvailableHours}h</span>
                            </div>
                            <div class="workload-detail-row" style="border-top: 2px solid #e5e7eb; padding-top: 12px; margin-top: 5px;">
                                <span class="workload-detail-label">Êú¨Âë®‰ªªÂä°Â∑•Êó∂</span>
                                <span class="workload-detail-value" style="color: ${workloadColor};">${stats.totalTaskHoursWeek}h</span>
                            </div>
                        </div>
                    </div>

                    <!-- ÂõæË°®Âå∫Âüü -->
                    <div class="charts-container">
                        <!-- È•ºÂõæÔºöÊó∂Èó¥Âç†Áî®ÂàÜÂ∏É -->
                        <div class="chart-card">
                            <div class="chart-title">üìä Êú¨Âë®Êó∂Èó¥ÂàÜÈÖç</div>
                            ${renderPieChart(workloadData.pieChartData)}
                        </div>
                        
                        <!-- Êü±Áä∂ÂõæÔºöÊØèÊó•Ë¥üËΩΩ -->
                        <div class="chart-card">
                            <div class="chart-title">üìà ÊØèÊó•Â∑•‰ΩúË¥üËΩΩ</div>
                            ${renderBarChart(workloadData.dailyWorkload)}
                        </div>
                    </div>

                    <!-- ÁªüËÆ°Âç°Áâá -->
                    <div class="workload-stats">
                        <div class="workload-stat-card">
                            <div class="workload-stat-value" style="color: #8b5cf6;">${stats.managerTaskHoursWeek}h</div>
                            <div class="workload-stat-label">ÁªèÁêÜ‰ªªÂä°(Êú¨Âë®)</div>
                        </div>
                        <div class="workload-stat-card">
                            <div class="workload-stat-value" style="color: #10b981;">${stats.selfTaskHoursWeek}h</div>
                            <div class="workload-stat-label">Ëá™‰∏ª‰ªªÂä°(Êú¨Âë®)</div>
                        </div>
                        <div class="workload-stat-card">
                            <div class="workload-stat-value" style="color: #667eea;">${stats.managerTaskHoursTotal}h</div>
                            <div class="workload-stat-label">ÁªèÁêÜ‰ªªÂä°(ÊÄªËÆ°)</div>
                        </div>
                        <div class="workload-stat-card">
                            <div class="workload-stat-value" style="color: #059669;">${stats.selfTaskHoursTotal}h</div>
                            <div class="workload-stat-label">Ëá™‰∏ª‰ªªÂä°(ÊÄªËÆ°)</div>
                        </div>
                    </div>

                    <!-- ‰ªªÂä°ËØ¶ÊÉÖÂàóË°® -->
                    <div class="workload-section">
                        <div class="section-header">
                            <div class="section-title">üìå Êú¨Âë®‰ªªÂä°ÂàÜÊëäËØ¶ÊÉÖ</div>
                        </div>
                        ${renderWorkloadTaskDetails()}
                    </div>
                </div>

                ${renderBottomNav()}
            `;
        }

        // Ê∏≤ÊüìË¥üËΩΩÂúÜÁéØ
        function renderWorkloadCircle(percentage, color, label) {
            const radius = 54;
            const circumference = 2 * Math.PI * radius;
            const displayPercentage = Math.min(percentage, 100);
            const offset = circumference - (displayPercentage / 100) * circumference;
            
            return `
                <div class="workload-circle">
                    <svg width="140" height="140">
                        <circle class="workload-circle-bg" cx="70" cy="70" r="${radius}"/>
                        <circle class="workload-circle-fill" cx="70" cy="70" r="${radius}"
                            stroke="${color}"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${offset}"/>
                    </svg>
                    <div class="workload-circle-text">
                        <div class="workload-percentage" style="color: ${color};">${percentage}%</div>
                        <div class="workload-status">${label}</div>
                    </div>
                </div>
            `;
        }

        // Ê∏≤ÊüìÈ•ºÂõæ
        function renderPieChart(data) {
            const total = data.managerTaskHours + data.selfTaskHours + data.unavailableHours + data.freeHours;
            if (total === 0) {
                return '<div class="empty-section"><p>ÊöÇÊó†Êï∞ÊçÆ</p></div>';
            }
            
            // ËÆ°ÁÆóËßíÂ∫¶
            const managerAngle = (data.managerTaskHours / total) * 360;
            const selfAngle = (data.selfTaskHours / total) * 360;
            const unavailableAngle = (data.unavailableHours / total) * 360;
            const freeAngle = (data.freeHours / total) * 360;
            
            // ÁîüÊàêÈ•ºÂõæÊ∏êÂèò
            let gradient = '';
            let currentAngle = 0;
            
            if (managerAngle > 0) {
                gradient += `#8b5cf6 ${currentAngle}deg ${currentAngle + managerAngle}deg, `;
                currentAngle += managerAngle;
            }
            if (selfAngle > 0) {
                gradient += `#10b981 ${currentAngle}deg ${currentAngle + selfAngle}deg, `;
                currentAngle += selfAngle;
            }
            if (unavailableAngle > 0) {
                gradient += `#ef4444 ${currentAngle}deg ${currentAngle + unavailableAngle}deg, `;
                currentAngle += unavailableAngle;
            }
            if (freeAngle > 0) {
                gradient += `#e5e7eb ${currentAngle}deg ${currentAngle + freeAngle}deg, `;
            }
            
            gradient = gradient.slice(0, -2);  // ÁßªÈô§ÊúÄÂêéÁöÑÈÄóÂè∑ÂíåÁ©∫Ê†º
            
            return `
                <div class="pie-chart-container">
                    <div class="pie-chart" style="background: conic-gradient(${gradient});"></div>
                    <div class="pie-legend">
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #8b5cf6;"></span>
                            <span>ÁªèÁêÜ‰ªªÂä° ${data.managerTaskHours}h</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #10b981;"></span>
                            <span>Ëá™‰∏ª‰ªªÂä° ${data.selfTaskHours}h</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #ef4444;"></span>
                            <span>‰∏çÂèØÁî® ${data.unavailableHours}h</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #e5e7eb;"></span>
                            <span>Á©∫Èó≤ ${data.freeHours}h</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Ê∏≤ÊüìÊü±Áä∂Âõæ
        function renderBarChart(dailyData) {
            // Âè™ÊòæÁ§∫Â∑•‰ΩúÊó•
            const workdayData = dailyData.filter(d => d.isWorkday);
            if (workdayData.length === 0) {
                return '<div class="empty-section"><p>ÊöÇÊó†Êï∞ÊçÆ</p></div>';
            }
            
            // ÊâæÂá∫ÊúÄÂ§ßÂÄºÁî®‰∫éËÆ°ÁÆóÈ´òÂ∫¶ÊØî‰æã
            const maxHours = Math.max(
                ...workdayData.map(d => Math.max(d.availableHours, d.totalTaskHours + d.unavailableHours))
            );
            const scale = maxHours > 0 ? 100 / maxHours : 1;
            
            const bars = workdayData.map(d => {
                const availableHeight = d.availableHours * scale;
                const managerHeight = d.managerTaskHours * scale;
                const selfHeight = d.selfTaskHours * scale;
                const unavailableHeight = d.unavailableHours * scale;
                
                return `
                    <div class="bar-group">
                        <div class="bar-wrapper">
                            <div class="bar bar-available" style="height: ${availableHeight}px;" title="ÂèØÁî®: ${d.availableHours}h"></div>
                            <div class="bar bar-manager" style="height: ${managerHeight}px;" title="ÁªèÁêÜ‰ªªÂä°: ${d.managerTaskHours}h"></div>
                            <div class="bar bar-self" style="height: ${selfHeight}px;" title="Ëá™‰∏ª‰ªªÂä°: ${d.selfTaskHours}h"></div>
                            <div class="bar bar-unavailable" style="height: ${unavailableHeight}px;" title="‰∏çÂèØÁî®: ${d.unavailableHours}h"></div>
                        </div>
                        <div class="bar-label">${d.dayLabel}</div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="bar-chart">
                    ${bars}
                </div>
                <div class="bar-legend">
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #3b82f6;"></span>
                        <span>ÂèØÁî®</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #8b5cf6;"></span>
                        <span>ÁªèÁêÜ‰ªªÂä°</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #10b981;"></span>
                        <span>Ëá™‰∏ª‰ªªÂä°</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #ef4444;"></span>
                        <span>‰∏çÂèØÁî®</span>
                    </div>
                </div>
            `;
        }

        // Ê†ºÂºèÂåñÊó•ÊúüËåÉÂõ¥
        function formatDateRange(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const startStr = `${startDate.getMonth() + 1}Êúà${startDate.getDate()}Êó•`;
            const endStr = `${endDate.getMonth() + 1}Êúà${endDate.getDate()}Êó•`;
            return `${startStr} - ${endStr}`;
        }

        // Ëé∑ÂèñË¥üËΩΩÈ¢úËâ≤
        function getWorkloadColor(level) {
            const colors = {
                'low': '#10b981',
                'medium': '#f59e0b',
                'high': '#f97316',
                'overload': '#ef4444'
            };
            return colors[level] || '#666';
        }

        // Ê∏≤ÊüìÂ∫ïÈÉ®ÂØºËà™
        function renderBottomNav() {
            return `
                <div class="bottom-nav">
                    <div class="nav-item ${currentPage === 'work' ? 'active' : ''}" onclick="switchPage('work')">
                        <div class="nav-icon">üöÄ</div>
                        <div class="nav-label">ÂºÄÂßãÂ∑•‰Ωú</div>
                    </div>
                    <div class="nav-item ${currentPage === 'tasks' ? 'active' : ''}" onclick="switchPage('tasks')">
                        <div class="nav-icon">üìã</div>
                        <div class="nav-label">ÊàëÁöÑ‰ªªÂä°</div>
                    </div>
                    <div class="nav-item ${currentPage === 'workload' ? 'active' : ''}" onclick="switchPage('workload')">
                        <div class="nav-icon">üìä</div>
                        <div class="nav-label">ÊàëÁöÑË¥üËΩΩ</div>
                    </div>
                    <div class="nav-item ${currentPage === 'schedule' ? 'active' : ''}" onclick="switchPage('schedule')">
                        <div class="nav-icon">üìÖ</div>
                        <div class="nav-label">Êó•Á®ãÂà∂ÂÆö</div>
                    </div>
                </div>
            `;
        }

        // Ê∏≤ÊüìË¥üËΩΩÈ°µÈù¢ÁöÑ‰ªªÂä°ÂàÜÊëäËØ¶ÊÉÖ
        function renderWorkloadTaskDetails() {
            let html = '';
            
            // ÁªèÁêÜ‰ªªÂä°
            if (workloadData.managerTasks && workloadData.managerTasks.length > 0) {
                html += `<div style="padding: 10px 15px; background: #f8fafc; font-weight: 600; color: #8b5cf6; border-bottom: 1px solid #e5e7eb;">üìå ÁªèÁêÜÂàÜÈÖçÁöÑ‰ªªÂä°</div>`;
                html += workloadData.managerTasks.map(task => `
                <div class="workload-item">
                    <div class="workload-item-info">
                        <div class="workload-item-name">
                            ${task.taskName}
                            ${task.weekHours > 0 ? `<span class="week-hours-badge">Êú¨Âë®${task.weekHours}h</span>` : ''}
                        </div>
                        <div class="workload-item-meta">
                            <span>‚≠ê ${task.importance || 5}ÂàÜ</span>
                            <span>üìÖ ${task.taskDeadline ? formatDate(task.taskDeadline) : 'Êó†Êà™Ê≠¢Êó•Êúü'}</span>
                            <span class="type-badge type-project">${task.status === 'accepted' ? 'ËøõË°å‰∏≠' : 'ÂæÖÂ§ÑÁêÜ'}</span>
                        </div>
                    </div>
                    <div class="workload-item-hours">${task.estimatedHours || 0}h</div>
                </div>
            `).join('');
        }

            // Ëá™‰∏ª‰ªªÂä°
            if (selfTasks && selfTasks.length > 0) {
                html += `<div style="padding: 10px 15px; background: #f8fafc; font-weight: 600; color: #10b981; border-bottom: 1px solid #e5e7eb; border-top: 1px solid #e5e7eb;">üìù ÊàëÁöÑËá™‰∏ª‰ªªÂä°</div>`;
                html += selfTasks.map(task => `
                <div class="workload-item">
                    <div class="workload-item-info">
                        <div class="workload-item-name">
                            ${task.name}
                            ${task.weekHours > 0 ? `<span class="week-hours-badge">Êú¨Âë®${task.weekHours}h</span>` : ''}
                        </div>
                        <div class="workload-item-meta">
                            <span class="type-badge type-${task.taskType}">${task.taskTypeLabel}</span>
                            <span>üìÖ ${task.deadline ? formatDate(task.deadline) : 'Êó†Êà™Ê≠¢Êó•Êúü'}</span>
                        </div>
                    </div>
                    <div class="workload-item-hours">${task.estimatedHours}h</div>
                </div>
            `).join('');
        }

            // ‰∏çÂèØÁî®Êó∂Èó¥
            if (unavailableTimes && unavailableTimes.length > 0) {
                html += `<div style="padding: 10px 15px; background: #f8fafc; font-weight: 600; color: #ef4444; border-bottom: 1px solid #e5e7eb; border-top: 1px solid #e5e7eb;">üö´ ‰∏çÂèØÁî®Êó∂Èó¥</div>`;
                html += unavailableTimes.map(time => `
                <div class="workload-item">
                    <div class="workload-item-info">
                        <div class="workload-item-name">${time.reasonTypeLabel}${time.note ? ' - ' + time.note : ''}</div>
                        <div class="workload-item-meta">
                            <span>üìÖ ${time.date}</span>
                            <span>üïê ${time.startTime} - ${time.endTime}</span>
                        </div>
                    </div>
                        <div class="workload-item-hours" style="color: #ef4444;">-${time.durationHours}h</div>
                </div>
            `).join('');
            }
            
            if (!html) {
                return `<div class="empty-section"><p>ÊöÇÊó†‰ªªÂä°ÂíåÊó∂Èó¥ÂÆâÊéí</p></div>`;
            }
            
            return html;
        }

        // ========== Êó•Á®ãÂà∂ÂÆöÈ°µÈù¢ ==========
        
        // ÊòæÁ§∫Êó•Á®ãÂà∂ÂÆöÈ°µÈù¢
        async function showSchedulePage() {
            document.body.className = '';
            currentPage = 'schedule';
            saveLoginState();
            
            // ÂÖàÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div class="schedule-header">
                        <div class="header-content">
                            <div>
                                <h1>üìÖ Êó•Á®ãÂà∂ÂÆö</h1>
                                <p>${currentUser.name} ¬∑ Êô∫ËÉΩ‰ªªÂä°ÊéíÁ®ã</p>
                            </div>
                            <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 50px; color: #666;">
                        Âä†ËΩΩ‰∏≠...
                    </div>
                </div>
                ${renderBottomNav()}
            `;
            
            // Âä†ËΩΩÊï∞ÊçÆ
            await Promise.all([
                loadTaskPageData(),
                loadScheduleData()
            ]);
            
            renderSchedulePage();
        }
        
        // Âä†ËΩΩÊó•Á®ãÊï∞ÊçÆ
        async function loadScheduleData() {
            try {
                const response = await fetch(`${API_BASE}/schedule/${currentUser.id}`);
                if (response.ok) {
                    scheduleData = await response.json();
                } else {
                    scheduleData = null;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊó•Á®ãÊï∞ÊçÆÂ§±Ë¥•:', error);
                scheduleData = null;
            }
        }
        
        // ÊùÉÈáçÈÖçÁΩÆÈªòËÆ§ÂÄº
        let scheduleWeights = {
            urgency: 40,
            importance: 40,
            continuity: 20
        };
        let activeWeightType = 'urgency';  // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊùÉÈáçÁ±ªÂûã
        
        // ÊùÉÈáçÈ¢úËâ≤ÈÖçÁΩÆ
        const weightColors = {
            urgency: '#ef4444',     // Á∫¢Ëâ≤ - Á¥ßÊÄ•Â∫¶
            importance: '#8b5cf6',  // Á¥´Ëâ≤ - ÈáçË¶ÅÂ∫¶
            continuity: '#10b981'   // ÁªøËâ≤ - ËøûÁª≠ÊÄß
        };
        
        // ÊòØÂê¶Â§Ñ‰∫éÊõ¥Êñ∞Êó•Á®ãÊ®°Âºè
        let isUpdateScheduleMode = false;
        
        // Ê∏≤ÊüìÊó•Á®ãÂà∂ÂÆöÈ°µÈù¢
        function renderSchedulePage() {
            const managerTasks = allTasks.filter(t => t.status === 'pending' || t.status === 'accepted');
            const pendingSelfTasks = allSelfTasks.filter(t => t.status === 'pending');
            const totalTasks = managerTasks.length + pendingSelfTasks.length;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊó•Á®ã
            const hasSchedule = scheduleData?.schedule?.id;
            const hasAcceptedSchedule = scheduleData?.schedule?.isAccepted;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÂÜÖÂÆπÈúÄË¶ÅÊõ¥Êñ∞
            if (hasSchedule) {
                checkScheduleNeedsUpdate().then(info => {
                    if (info && info.needsUpdate) {
                        const updateBanner = document.getElementById('schedule-update-banner');
                        if (updateBanner) {
                            updateBanner.style.display = 'block';
                            updateBanner.innerHTML = `
                                <div style="font-size: 13px; font-weight: 600; color: #92400e; margin-bottom: 5px;">üîî ÊúâÊñ∞ÂÜÖÂÆπÈúÄË¶ÅÊõ¥Êñ∞Êó•Á®ã</div>
                                <div style="font-size: 12px; color: #b45309;">${info.reason}</div>
                            `;
                        }
                    }
                });
            }
            
            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div class="schedule-header">
                        <div class="header-content">
                            <div>
                                <h1>üìÖ Êó•Á®ãÂà∂ÂÆö</h1>
                                <p>${currentUser.name} ¬∑ ÂÖ± ${totalTasks} ‰∏™ÂæÖÊéí‰ªªÂä°</p>
                            </div>
                            <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫</button>
                        </div>
                    </div>
                    
                    <!-- Êõ¥Êñ∞ÊèêÁ§∫Ê®™ÂπÖ -->
                    <div id="schedule-update-banner" style="display: none; margin: 10px 15px; padding: 12px 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 1px solid #fcd34d;"></div>
                    
                    ${hasSchedule && !isUpdateScheduleMode ? `
                        <!-- Â∑≤ÊúâÊó•Á®ãÔºåÊòæÁ§∫Áä∂ÊÄÅÂíåÊõ¥Êñ∞ÂÖ•Âè£ -->
                        <div style="margin: 10px 15px; padding: 15px; background: linear-gradient(135deg, ${hasAcceptedSchedule ? '#ecfdf5 0%, #d1fae5' : '#fef3c7 0%, #fde68a'} 100%); border-radius: 12px; border: 1px solid ${hasAcceptedSchedule ? '#86efac' : '#fcd34d'};">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    ${hasAcceptedSchedule ? `
                                        <div style="font-size: 14px; font-weight: 600; color: #166534;">‚úÖ ÂΩìÂâçÊó•Á®ãÂ∑≤ÁîüÊïà</div>
                                        <div style="font-size: 12px; color: #15803d; margin-top: 3px;">Êé•Âèó‰∫é ${formatDateTime(scheduleData.schedule.acceptedAt)}</div>
                                    ` : `
                                        <div style="font-size: 14px; font-weight: 600; color: #92400e;">üìã Â∑≤ÁîüÊàêÊó•Á®ãÔºàÂæÖÊé•ÂèóÔºâ</div>
                                        <div style="font-size: 12px; color: #b45309; margin-top: 3px;">ÁîüÊàê‰∫é ${formatDateTime(scheduleData.schedule.createdAt)}</div>
                                    `}
                                </div>
                                <button onclick="enterUpdateScheduleMode()" style="
                                    background: ${hasAcceptedSchedule ? '#059669' : '#f59e0b'};
                                    color: white;
                                    border: none;
                                    padding: 10px 15px;
                                    border-radius: 8px;
                                    font-size: 13px;
                                    font-weight: 600;
                                    cursor: pointer;
                                ">üîÑ Êõ¥Êñ∞Êó•Á®ã</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${isUpdateScheduleMode ? `
                        <!-- Êõ¥Êñ∞Êó•Á®ãÊ®°Âºè -->
                        <div style="margin: 10px 15px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 1px solid #fcd34d;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div style="font-size: 14px; font-weight: 600; color: #92400e;">üîÑ Êõ¥Êñ∞Êó•Á®ãÊ®°Âºè</div>
                                <button onclick="exitUpdateScheduleMode()" style="
                                    background: transparent;
                                    border: 1px solid #b45309;
                                    color: #b45309;
                                    padding: 5px 10px;
                                    border-radius: 5px;
                                    font-size: 12px;
                                    cursor: pointer;
                                ">ÂèñÊ∂àÊõ¥Êñ∞</button>
                            </div>
                            <div style="font-size: 12px; color: #b45309; margin-bottom: 15px;">
                                üí° ÂãæÈÄâ‰∏ãÊñπÊó•Á®ã‰∏≠ÊÉ≥Ë¶Å‰øùÁïôÁöÑ‰ªªÂä°ÂÆâÊéíÔºåÁÑ∂ÂêéÁÇπÂáª"ÈáçÊñ∞ÊéíÁ®ã"ÔºåÊú™ÈÄâ‰∏≠ÁöÑÂ∞ÜÈáçÊñ∞ÂÆâÊéí„ÄÇ
                            </div>
                            ${renderCurrentScheduleForUpdate()}
                            <div style="margin-top: 15px; text-align: center;">
                                <button onclick="executeUpdateScheduleFromPage()" style="
                                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                                    color: white;
                                    border: none;
                                    padding: 12px 30px;
                                    border-radius: 10px;
                                    font-size: 14px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
                                ">üîÑ ÈáçÊñ∞ÊéíÁ®ãÔºà‰øùÁïôÂ∑≤ÈÄâÈ°πÔºâ</button>
                            </div>
                        </div>
                    ` : `
                        <!-- Ê≠•È™§1: ÊùÉÈáçÈÖçÁΩÆ -->
                        <div style="padding: 15px 15px 0;">
                            <div style="background: #ede9fe; color: #6d28d9; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;">
                                üìã Ê≠•È™§1: ËÆæÁΩÆÊéíÁ®ã‰ºòÂÖàÁ∫ßÊùÉÈáç
                            </div>
                        </div>
                        ${renderWeightConfig()}
                        
                        <!-- Ê≠•È™§2: ‰ªªÂä°ÈáçË¶ÅÊÄßËÆæÁΩÆ -->
                        <div style="padding: 15px 15px 0;">
                            <div style="background: #dbeafe; color: #1d4ed8; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;">
                                üìã Ê≠•È™§2: ËÆæÁΩÆ‰ªªÂä°ÈáçË¶ÅÊÄß
                            </div>
                        </div>
                        ${renderTaskImportanceSection(managerTasks, pendingSelfTasks)}
                        
                        <!-- Ê≠•È™§3: ÁîüÊàêÊó•Á®ã -->
                        <div style="padding: 15px 15px 0;">
                            <div style="background: #d1fae5; color: #065f46; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;">
                                üìã Ê≠•È™§3: ÁîüÊàêÊó•Á®ãÂÆâÊéí
                            </div>
                        </div>
                        <div class="schedule-actions">
                            <button class="schedule-btn" onclick="generateSchedule()" id="generate-btn">
                                ü§ñ ${hasAcceptedSchedule ? 'ÈáçÊñ∞ÁîüÊàêÊó•Á®ã' : 'Ëá™Âä®ÊéíÁ®ã'}ÔºàÊú™Êù•2Âë®Ôºâ
                            </button>
                        </div>
                    `}
                    
                    <!-- Êó•Á®ãÁªìÊûú -->
                    ${!isUpdateScheduleMode ? renderScheduleResult() : ''}
                </div>
                ${renderBottomNav()}
            `;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ÊéíÁ®ã
        async function checkScheduleNeedsUpdate() {
            try {
                const response = await fetch(`${API_BASE}/schedule/check-updates/${currentUser.id}`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log('Ê£ÄÊü•ÊéíÁ®ãÊõ¥Êñ∞Â§±Ë¥•:', e);
            }
            return null;
        }
        
        // ËøõÂÖ•Êõ¥Êñ∞Êó•Á®ãÊ®°Âºè
        function enterUpdateScheduleMode() {
            isUpdateScheduleMode = true;
            selectedLockedItems = [];
            renderSchedulePage();
        }
        
        // ÈÄÄÂá∫Êõ¥Êñ∞Êó•Á®ãÊ®°Âºè
        function exitUpdateScheduleMode() {
            isUpdateScheduleMode = false;
            selectedLockedItems = [];
            renderSchedulePage();
        }
        
        // Ê∏≤ÊüìÂΩìÂâçÊó•Á®ã‰æõÈÄâÊã©‰øùÁïô
        function renderCurrentScheduleForUpdate() {
            if (!scheduleData || !scheduleData.dailySchedule) {
                return '<div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†Êó•Á®ãÊï∞ÊçÆ</div>';
            }
            
            const dailySchedule = scheduleData.dailySchedule || [];
            
            return dailySchedule.map(day => {
                if (day.items.length === 0) return '';
                
                return `
                    <div style="margin-bottom: 12px; background: white; border-radius: 10px; overflow: hidden; border: 1px solid #e5e7eb;">
                        <div style="background: #f9fafb; padding: 10px 12px; font-weight: 600; color: #374151; font-size: 13px; border-bottom: 1px solid #e5e7eb;">
                            ${day.dayLabel} <span style="font-weight: normal; color: #9ca3af;">(${day.taskHours}h)</span>
                        </div>
                        ${day.items.map(item => `
                            <label style="display: flex; align-items: center; padding: 10px 12px; border-bottom: 1px solid #f3f4f6; cursor: pointer;">
                                <input type="checkbox" 
                                       class="lock-item-checkbox"
                                       data-date="${day.date}"
                                       data-task-type="${item.taskType}"
                                       data-task-id="${item.taskId}"
                                       data-task-name="${item.taskName}"
                                       data-planned-hours="${item.plannedHours}"
                                       data-deadline="${item.deadline || ''}"
                                       ${item.isLocked ? 'checked' : ''}
                                       onchange="updateLockedSelection()"
                                       style="width: 16px; height: 16px; margin-right: 10px;"
                                />
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; color: #374151;">
                                        ${item.taskType === 'manager' ? 'üìå' : 'üìù'} ${item.taskName}
                                    </div>
                                    <div style="font-size: 11px; color: #9ca3af; margin-top: 2px;">
                                        ${item.plannedHours}h ${item.deadline ? '¬∑ Êà™Ê≠¢:' + formatDate(item.deadline) : ''}
                                    </div>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }
        
        // ‰ªéÈ°µÈù¢ÊâßË°åÊõ¥Êñ∞ÊéíÁ®ã
        async function executeUpdateScheduleFromPage() {
            updateLockedSelection();  // Á°Æ‰øùÈÄâ‰∏≠È°πÊòØÊúÄÊñ∞ÁöÑ
            
            if (selectedLockedItems.length === 0) {
                if (!confirm('ÊÇ®Ê≤°ÊúâÈÄâÊã©‰ªª‰ΩïË¶Å‰øùÁïôÁöÑÊó•Á®ãÈ°πÔºåÁ°ÆÂÆöË¶ÅÂÆåÂÖ®ÈáçÊñ∞ÊéíÁ®ãÂêóÔºü')) {
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE}/schedule/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_id: currentUser.id,
                        days: 14,
                        daily_hours: 8,
                        urgency_weight: scheduleWeights.urgency,
                        importance_weight: scheduleWeights.importance,
                        continuity_weight: scheduleWeights.continuity,
                        locked_items: selectedLockedItems
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ÊéíÁ®ãÂ∑≤Êõ¥Êñ∞ÔºÅËØ∑Êü•ÁúãÊñ∞ÁöÑÊó•Á®ãÂÆâÊéíÂπ∂Á°ÆËÆ§Êé•Âèó„ÄÇ');
                    isUpdateScheduleMode = false;
                    await loadScheduleData();
                    renderSchedulePage();
                } else {
                    alert(result.message || 'Êõ¥Êñ∞Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊéíÁ®ãÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Ê∏≤ÊüìÊùÉÈáçÈÖçÁΩÆ - ‰∫§‰∫íÂºèÈ•ºÂõæ
        function renderWeightConfig() {
            return `
                <div class="weight-config">
                    <div class="weight-config-title">‚öñÔ∏è ÊéíÁ®ã‰ºòÂÖàÁ∫ßÊùÉÈáç</div>
                    
                    <div class="weight-pie-container">
                        <!-- È•ºÂõæ -->
                        <div class="weight-pie" id="weight-pie" style="${getWeightPieStyle()}">
                            <div class="weight-pie-center">
                                <span class="weight-pie-label">ÊÄªËÆ°</span>
                                <span class="weight-pie-value">100%</span>
                            </div>
                        </div>
                        
                        <!-- ÊéßÂà∂È°π -->
                        <div class="weight-controls">
                            <div class="weight-control-item ${activeWeightType === 'urgency' ? 'active' : ''}" 
                                 onclick="selectWeightType('urgency')">
                                <div class="weight-color-dot" style="background: ${weightColors.urgency}"></div>
                                <div class="weight-control-info">
                                    <div class="weight-control-label">üö® Á¥ßÊÄ•Â∫¶</div>
                                    <div class="weight-control-desc">Êà™Ê≠¢Êó•ÊúüË∂äËøëË∂ä‰ºòÂÖà</div>
                                </div>
                                <div class="weight-control-value">
                                    <button class="weight-btn" onclick="event.stopPropagation(); adjustWeight('urgency', -5)">‚àí</button>
                                    <span class="weight-number" id="weight-urgency-num" style="color: ${weightColors.urgency}">${scheduleWeights.urgency}%</span>
                                    <button class="weight-btn" onclick="event.stopPropagation(); adjustWeight('urgency', 5)">+</button>
                                </div>
                            </div>
                            
                            <div class="weight-control-item ${activeWeightType === 'importance' ? 'active' : ''}"
                                 onclick="selectWeightType('importance')">
                                <div class="weight-color-dot" style="background: ${weightColors.importance}"></div>
                                <div class="weight-control-info">
                                    <div class="weight-control-label">‚≠ê ÈáçË¶ÅÂ∫¶</div>
                                    <div class="weight-control-desc">ÈáçË¶ÅÊÄßËØÑÂàÜË∂äÈ´òË∂ä‰ºòÂÖà</div>
                                </div>
                                <div class="weight-control-value">
                                    <button class="weight-btn" onclick="event.stopPropagation(); adjustWeight('importance', -5)">‚àí</button>
                                    <span class="weight-number" id="weight-importance-num" style="color: ${weightColors.importance}">${scheduleWeights.importance}%</span>
                                    <button class="weight-btn" onclick="event.stopPropagation(); adjustWeight('importance', 5)">+</button>
                                </div>
                            </div>
                            
                            <div class="weight-control-item ${activeWeightType === 'continuity' ? 'active' : ''}"
                                 onclick="selectWeightType('continuity')">
                                <div class="weight-color-dot" style="background: ${weightColors.continuity}"></div>
                                <div class="weight-control-info">
                                    <div class="weight-control-label">üîó ËøûÁª≠ÊÄß</div>
                                    <div class="weight-control-desc">Âêå‰∏Ä‰ªªÂä°ËøûÁª≠ÂÆåÊàê</div>
                                </div>
                                <div class="weight-control-value">
                                    <button class="weight-btn" onclick="event.stopPropagation(); adjustWeight('continuity', -5)">‚àí</button>
                                    <span class="weight-number" id="weight-continuity-num" style="color: ${weightColors.continuity}">${scheduleWeights.continuity}%</span>
                                    <button class="weight-btn" onclick="event.stopPropagation(); adjustWeight('continuity', 5)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Ëé∑ÂèñÈ•ºÂõæÊ†∑Âºè
        function getWeightPieStyle() {
            const u = scheduleWeights.urgency;
            const i = scheduleWeights.importance;
            const c = scheduleWeights.continuity;
            
            // ËÆ°ÁÆóËßíÂ∫¶
            const uAngle = u * 3.6;  // ÁôæÂàÜÊØîËΩ¨ËßíÂ∫¶
            const iAngle = i * 3.6;
            const cAngle = c * 3.6;
            
            return `background: conic-gradient(
                ${weightColors.urgency} 0deg ${uAngle}deg,
                ${weightColors.importance} ${uAngle}deg ${uAngle + iAngle}deg,
                ${weightColors.continuity} ${uAngle + iAngle}deg 360deg
            );`;
        }
        
        // ÈÄâÊã©ÊùÉÈáçÁ±ªÂûã
        function selectWeightType(type) {
            activeWeightType = type;
            // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.weight-control-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
        
        // Ë∞ÉÊï¥ÊùÉÈáçÔºà‰øùÊåÅÊÄªÂíå100%Ôºâ
        function adjustWeight(type, delta) {
            const types = ['urgency', 'importance', 'continuity'];
            const otherTypes = types.filter(t => t !== type);
            
            const currentValue = scheduleWeights[type];
            let newValue = currentValue + delta;
            
            // ÈôêÂà∂ËåÉÂõ¥
            if (newValue < 0) newValue = 0;
            if (newValue > 100) newValue = 100;
            
            const actualDelta = newValue - currentValue;
            if (actualDelta === 0) return;
            
            // ‰ªéÂÖ∂‰ªñ‰∏§‰∏™Á±ªÂûã‰∏≠ÂùáÂåÄÊâ£Èô§/Â¢ûÂä†
            const otherDelta = -actualDelta / 2;
            
            // Ê£ÄÊü•ÊòØÂê¶ÂèØË°å
            let canAdjust = true;
            otherTypes.forEach(t => {
                const newOther = scheduleWeights[t] + otherDelta;
                if (newOther < 0 || newOther > 100) canAdjust = false;
            });
            
            if (!canAdjust) {
                // Â∞ùËØïÂè™‰ªé‰∏Ä‰∏™Á±ªÂûãÊâ£Èô§
                for (let t of otherTypes) {
                    const newOther = scheduleWeights[t] - actualDelta;
                    if (newOther >= 0 && newOther <= 100) {
                        scheduleWeights[type] = newValue;
                        scheduleWeights[t] = newOther;
                        updateWeightDisplay();
                        return;
                    }
                }
                return;
            }
            
            // Â∫îÁî®ÂèòÂåñ
            scheduleWeights[type] = newValue;
            otherTypes.forEach(t => {
                scheduleWeights[t] = Math.round(scheduleWeights[t] + otherDelta);
            });
            
            // ‰øÆÊ≠£ËàçÂÖ•ËØØÂ∑Æ
            const total = scheduleWeights.urgency + scheduleWeights.importance + scheduleWeights.continuity;
            if (total !== 100) {
                scheduleWeights[otherTypes[0]] += (100 - total);
            }
            
            updateWeightDisplay();
        }
        
        // Êõ¥Êñ∞ÊùÉÈáçÊòæÁ§∫
        function updateWeightDisplay() {
            // Êõ¥Êñ∞Êï∞Â≠ó
            document.getElementById('weight-urgency-num').textContent = scheduleWeights.urgency + '%';
            document.getElementById('weight-importance-num').textContent = scheduleWeights.importance + '%';
            document.getElementById('weight-continuity-num').textContent = scheduleWeights.continuity + '%';
            
            // Êõ¥Êñ∞È•ºÂõæ
            const pie = document.getElementById('weight-pie');
            if (pie) {
                pie.style = getWeightPieStyle();
            }
        }
        
        // Ê∏≤Êüì‰ªªÂä°ÈáçË¶ÅÊÄßËÆæÁΩÆÂå∫Âüü
        function renderTaskImportanceSection(managerTasks, selfTasks) {
            let html = '';
            
            // ÁªèÁêÜ‰ªªÂä°ÈáçË¶ÅÊÄßËÆæÁΩÆ
            if (managerTasks.length > 0) {
                html += `
                    <div class="task-importance-section">
                        <div class="task-importance-header">
                            <span>üìå ÁªèÁêÜ‰ªªÂä°ÈáçË¶ÅÊÄß</span>
                            <span style="font-size: 12px; color: #999; font-weight: normal;">${managerTasks.length} ‰∏™</span>
                        </div>
                        ${managerTasks.map(task => `
                            <div class="task-importance-item" id="manager-task-${task.id}">
                                <div class="task-importance-name">${task.name}</div>
                                <div class="task-importance-meta">
                                    <span>‚è±Ô∏è ${task.estimatedHours || '?'}h</span>
                                    <span>üìÖ ${task.deadline ? formatDeadline(task.deadline) : 'Êó†Êà™Ê≠¢Êó•Êúü'}</span>
                                    <span style="color: #8b5cf6;">ÁªèÁêÜËØÑÂÆö: ${task.managerImportance || 5}ÂàÜ</span>
                                </div>
                                <div class="importance-slider-container">
                                    <span style="font-size: 12px; color: #666;">ÊàëÁöÑËØÑÂÆö:</span>
                                    <input type="range" class="importance-slider" min="1" max="10" 
                                           value="${task.employeeImportance || task.managerImportance || 5}"
                                           data-type="manager" data-id="${task.id}"
                                           oninput="updateImportancePreview(this)">
                                    <span class="importance-value" id="importance-manager-${task.id}">${task.employeeImportance || task.managerImportance || 5}</span>
                                    <button onclick="saveTaskImportance('manager', ${task.id}, this)" 
                                            style="background: #8b5cf6; color: white; border: none; padding: 4px 10px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                        ‰øùÂ≠ò
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Ëá™‰∏ª‰ªªÂä°ÈáçË¶ÅÊÄßËÆæÁΩÆ
            if (selfTasks.length > 0) {
                html += `
                    <div class="task-importance-section">
                        <div class="task-importance-header">
                            <span>üìù Ëá™‰∏ª‰ªªÂä°ÈáçË¶ÅÊÄß</span>
                            <span style="font-size: 12px; color: #999; font-weight: normal;">${selfTasks.length} ‰∏™</span>
                        </div>
                        ${selfTasks.map(task => `
                            <div class="task-importance-item" id="self-task-${task.id}">
                                <div class="task-importance-name">${task.name}</div>
                                <div class="task-importance-meta">
                                    <span>‚è±Ô∏è ${task.estimatedHours}h</span>
                                    <span>üìÖ ${task.deadline ? formatDeadline(task.deadline) : 'Êó†Êà™Ê≠¢Êó•Êúü'}</span>
                                    <span class="type-badge type-${task.taskType}">${task.taskTypeLabel}</span>
                                </div>
                                <div class="importance-slider-container">
                                    <span style="font-size: 12px; color: #666;">ÈáçË¶ÅÁ®ãÂ∫¶:</span>
                                    <input type="range" class="importance-slider" min="1" max="10" 
                                           value="${task.importance || 5}"
                                           data-type="self" data-id="${task.id}"
                                           oninput="updateImportancePreview(this)">
                                    <span class="importance-value" id="importance-self-${task.id}">${task.importance || 5}</span>
                                    <button onclick="saveTaskImportance('self', ${task.id}, this)"
                                            style="background: #10b981; color: white; border: none; padding: 4px 10px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                                        ‰øùÂ≠ò
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (!html) {
                html = `
                    <div class="schedule-info-card" style="text-align: center; color: #999;">
                        <p>ÊöÇÊó†ÂæÖÊéí‰ªªÂä°</p>
                        <p style="font-size: 12px;">ËØ∑ÂÖàÂú®"ÊàëÁöÑ‰ªªÂä°"‰∏≠Ê∑ªÂä†‰ªªÂä°</p>
                    </div>
                `;
            }
            
            return html;
        }
        
        // Êõ¥Êñ∞ÈáçË¶ÅÊÄßÈ¢ÑËßà
        function updateImportancePreview(slider) {
            const type = slider.dataset.type;
            const id = slider.dataset.id;
            const value = slider.value;
            document.getElementById(`importance-${type}-${id}`).textContent = value;
        }
        
        // ‰øùÂ≠ò‰ªªÂä°ÈáçË¶ÅÊÄß
        async function saveTaskImportance(type, taskId, btn) {
            const slider = document.querySelector(`input[data-type="${type}"][data-id="${taskId}"]`);
            const importance = parseInt(slider.value);
            
            btn.textContent = '‰øùÂ≠ò‰∏≠...';
            btn.disabled = true;
            
            try {
                let url, body;
                if (type === 'manager') {
                    url = `${API_BASE}/assignments/${taskId}/employee-importance`;
                    body = { employee_importance: importance };
                } else {
                    url = `${API_BASE}/self-tasks/${taskId}/importance`;
                    body = { importance: importance };
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    btn.textContent = '‚úì Â∑≤‰øùÂ≠ò';
                    btn.style.background = '#10b981';
                    
                    // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
                    if (type === 'manager') {
                        const task = allTasks.find(t => t.id === taskId);
                        if (task) task.employeeImportance = importance;
                    } else {
                        const task = allSelfTasks.find(t => t.id === taskId);
                        if (task) task.importance = importance;
                    }
                    
                    setTimeout(() => {
                        btn.textContent = '‰øùÂ≠ò';
                        btn.style.background = type === 'manager' ? '#8b5cf6' : '#10b981';
                        btn.disabled = false;
                    }, 1500);
                } else {
                    throw new Error('‰øùÂ≠òÂ§±Ë¥•');
                }
            } catch (error) {
                btn.textContent = 'Â§±Ë¥•';
                btn.style.background = '#ef4444';
                setTimeout(() => {
                    btn.textContent = '‰øùÂ≠ò';
                    btn.style.background = type === 'manager' ? '#8b5cf6' : '#10b981';
                    btn.disabled = false;
                }, 1500);
            }
        }
        
        // ÁîüÊàêÊó•Á®ã
        async function generateSchedule() {
            const btn = document.getElementById('generate-btn');
            btn.textContent = 'üîÑ Ê≠£Âú®ÁîüÊàê...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/schedule/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_id: currentUser.id,
                        days: 14,
                        daily_hours: 8,
                        urgency_weight: scheduleWeights.urgency,
                        importance_weight: scheduleWeights.importance,
                        continuity_weight: scheduleWeights.continuity
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadScheduleData();
                    renderSchedulePage();
                    // ÊªöÂä®Âà∞Êó•Á®ãÁªìÊûú
                    setTimeout(() => {
                        const resultEl = document.querySelector('.schedule-info-card');
                        if (resultEl) resultEl.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                } else {
                    throw new Error(result.error || 'ÁîüÊàêÂ§±Ë¥•');
                }
            } catch (error) {
                alert('ÁîüÊàêÂ§±Ë¥•: ' + error.message);
            } finally {
                btn.textContent = 'ü§ñ Ëá™Âä®ÊéíÁ®ãÔºàÊú™Êù•2Âë®Ôºâ';
                btn.disabled = false;
            }
        }
        
        // Ê∏≤ÊüìÊó•Á®ãÁªìÊûú
        function renderScheduleResult() {
            if (!scheduleData || !scheduleData.success || !scheduleData.dailySchedule) {
                return `
                    <div class="schedule-info-card" style="text-align: center;">
                        <p style="font-size: 48px; margin-bottom: 15px;">üìÖ</p>
                        <p style="color: #666; margin-bottom: 10px;">ÊöÇÊó†Êó•Á®ãÂÆâÊéí</p>
                        <p style="font-size: 12px; color: #999;">ËÆæÁΩÆÂ•ΩÊùÉÈáçÂíå‰ªªÂä°ÈáçË¶ÅÊÄßÂêéÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆËá™Âä®ÁîüÊàê</p>
                    </div>
                `;
            }
            
            const schedule = scheduleData.schedule;
            const dailySchedule = scheduleData.dailySchedule;
            const delayRisks = scheduleData.delay_risks || [];
            
            let html = `
                <div class="schedule-info-card">
                    <div class="schedule-info-row">
                        <span style="color: #666;">ÊéíÁ®ãÂë®Êúü</span>
                        <span style="font-weight: 600;">${schedule.startDate} ~ ${schedule.endDate}</span>
                    </div>
                    <div class="schedule-info-row">
                        <span style="color: #666;">ÊØèÊó•Â∑•Êó∂</span>
                        <span style="font-weight: 600;">${schedule.dailyHours} Â∞èÊó∂</span>
                    </div>
                    <div class="schedule-info-row">
                        <span style="color: #666;">ÁîüÊàêÊó∂Èó¥</span>
                        <span style="font-weight: 600;">${formatDateTime(schedule.createdAt)}</span>
                    </div>
                </div>
            `;
            
            // Ê∏≤ÊüìÊØèÊó•ÂÆâÊéí
            if (dailySchedule.length > 0) {
                html += dailySchedule.map(day => `
                    <div class="schedule-day">
                        <div class="schedule-day-header">
                            <span class="schedule-day-title">${day.dayLabel}</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${day.unavailableHours > 0 ? `<span style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 8px; font-size: 11px;">üö´ ${day.unavailableHours}h</span>` : ''}
                                <span class="schedule-day-hours">${day.taskHours}h</span>
                            </div>
                        </div>
                        
                        ${(day.unavailable || []).map(u => `
                            <div class="schedule-unavailable">
                                <div class="schedule-unavailable-info">
                                    <span class="schedule-unavailable-icon">üö´</span>
                                    <span class="schedule-unavailable-text">
                                        ${u.reason}${u.note ? ' - ' + u.note : ''} 
                                        <span style="color: #999;">(${u.startTime}-${u.endTime})</span>
                                    </span>
                                </div>
                                <span class="schedule-unavailable-hours">-${u.hours}h</span>
                            </div>
                        `).join('')}
                        
                        ${day.items.map(item => `
                            <div class="schedule-task">
                                <div class="schedule-task-info">
                                    <div class="schedule-task-name">
                                        ${item.taskType === 'manager' ? 'üìå' : 'üìù'} ${item.taskName}
                                    </div>
                                    <div class="schedule-task-meta">
                                        <span>${item.taskTypeLabel}</span>
                                        ${item.deadline ? `<span>Êà™Ê≠¢: ${formatDate(item.deadline)}</span>` : ''}
                                        <span>Á¥ØËÆ°: ${item.cumulativeHours}/${item.totalHours}h</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    ${renderProgressRing(item.progress)}
                                    <div class="schedule-task-hours">${item.plannedHours}h</div>
                                </div>
                            </div>
                        `).join('')}
                        
                        ${day.items.length === 0 && (day.unavailable || []).length === 0 ? 
                            `<div style="padding: 20px; text-align: center; color: #999; font-size: 13px;">ÊöÇÊó†ÂÆâÊéí</div>` : ''}
                    </div>
                `).join('');
            } else {
                html += `
                    <div class="schedule-warning">
                        ‚ö†Ô∏è ÂΩìÂâçÊ≤°ÊúâÂèØÊéíÁ®ãÁöÑ‰ªªÂä°
                    </div>
                `;
            }
            
            // ÊÄªÊòØÊòæÁ§∫Âª∂ÊúüÁªüËÆ°ÔºàÂç≥‰ΩøÊ≤°ÊúâÈ£éÈô©È°π‰πüÊòæÁ§∫ÁªüËÆ°Ôºâ
            html += renderDelayRisks(delayRisks);
            
            // Êé•ÂèóÊó•Á®ãÊåâÈíÆ
            const isAccepted = schedule.isAccepted;
            html += `
                <div style="margin-top: 20px; padding: 20px; background: ${isAccepted ? '#ecfdf5' : 'white'}; border-radius: 12px; border: 1px solid ${isAccepted ? '#bbf7d0' : '#e5e7eb'};">
                    ${isAccepted ? `
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-size: 14px; color: #166534; font-weight: 600; margin-bottom: 5px;">Êó•Á®ãÂ∑≤Êé•Âèó</div>
                            <div style="font-size: 12px; color: #6b7280;">Êé•ÂèóÊó∂Èó¥: ${formatDateTime(schedule.acceptedAt)}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 10px;">Âú®"ÂºÄÂßãÂ∑•‰Ωú"Ê®°Âùó‰∏≠ÊåâÊ≠§Êó•Á®ãÊâßË°å‰ªªÂä°</div>
                        </div>
                    ` : `
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                                Á°ÆËÆ§Êé•ÂèóÊ≠§Êó•Á®ãÂêéÔºå"ÂºÄÂßãÂ∑•‰Ωú"Ê®°ÂùóÂ∞ÜÊåâÊ≠§ÂÆâÊéíÊòæÁ§∫ÊØèÊó•‰ªªÂä°
                            </div>
                            <button onclick="acceptSchedule(${schedule.id})" style="
                                background: linear-gradient(135deg, #059669 0%, #047857 100%);
                                color: white;
                                border: none;
                                padding: 15px 40px;
                                border-radius: 10px;
                                font-size: 16px;
                                font-weight: 600;
                                cursor: pointer;
                                box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
                            ">
                                ‚úì Êé•ÂèóÊ≠§Êó•Á®ã
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            return html;
        }
        
        // Êé•ÂèóÊó•Á®ã
        async function acceptSchedule(scheduleId) {
            if (!confirm('Á°ÆËÆ§Êé•ÂèóÊ≠§Êó•Á®ãÂêóÔºüÊé•ÂèóÂêé"ÂºÄÂßãÂ∑•‰Ωú"Ê®°ÂùóÂ∞ÜÊåâÊ≠§ÂÆâÊéíÊâßË°å„ÄÇ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/schedule/${scheduleId}/accept`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Êó•Á®ãÂ∑≤Êé•ÂèóÔºÅÁé∞Âú®ÂèØ‰ª•Âéª"ÂºÄÂßãÂ∑•‰Ωú"Ê®°ÂùóÊâßË°å‰ªªÂä°‰∫Ü„ÄÇ');
                    await loadScheduleData();
                    showSchedulePage();
                } else {
                    alert(result.message || 'Êìç‰ΩúÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Êé•ÂèóÊó•Á®ãÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Â≠òÂÇ®ÈÄâ‰∏≠ÁöÑ‰øùÁïôÈ°π
        let selectedLockedItems = [];
        
        // ÊèêÈÜíÊõ¥Êñ∞Êó•Á®ã
        function showScheduleUpdateReminder(action = 'Êìç‰Ωú') {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊó•Á®ã
            if (!scheduleData?.schedule?.id) return;
            
            // ÂàõÂª∫ÊèêÈÜítoast
            const toast = document.createElement('div');
            toast.id = 'schedule-reminder-toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                border: 1px solid #fcd34d;
                padding: 12px 20px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 9999;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideUp 0.3s ease;
            `;
            toast.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-size: 13px; font-weight: 600; color: #92400e;">üìÖ ${action}ÊàêÂäü</div>
                    <div style="font-size: 12px; color: #b45309; margin-top: 2px;">Âª∫ËÆÆÊõ¥Êñ∞Êó•Á®ã‰ª•ÂåÖÂê´ÊúÄÊñ∞ÂèòÂä®</div>
                </div>
                <button onclick="goToUpdateSchedule()" style="
                    background: #f59e0b;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 12px;
                    font-weight: 600;
                    cursor: pointer;
                    white-space: nowrap;
                ">ÂéªÊõ¥Êñ∞</button>
                <button onclick="dismissScheduleReminder()" style="
                    background: transparent;
                    border: none;
                    color: #92400e;
                    font-size: 18px;
                    cursor: pointer;
                    padding: 0 5px;
                ">√ó</button>
            `;
            
            // ÁßªÈô§Â∑≤ÊúâÁöÑÊèêÈÜí
            const existing = document.getElementById('schedule-reminder-toast');
            if (existing) existing.remove();
            
            document.body.appendChild(toast);
            
            // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
            if (!document.getElementById('toast-animation-style')) {
                const style = document.createElement('style');
                style.id = 'toast-animation-style';
                style.textContent = `
                    @keyframes slideUp {
                        from { transform: translateX(-50%) translateY(20px); opacity: 0; }
                        to { transform: translateX(-50%) translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 10ÁßíÂêéËá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                dismissScheduleReminder();
            }, 10000);
        }
        
        function dismissScheduleReminder() {
            const toast = document.getElementById('schedule-reminder-toast');
            if (toast) toast.remove();
        }
        
        function goToUpdateSchedule() {
            dismissScheduleReminder();
            switchPage('schedule');
        }
        
        // ÊòæÁ§∫Êõ¥Êñ∞ÊéíÁ®ãÂºπÁ™ó
        async function showUpdateScheduleModal() {
            await loadScheduleData();
            
            if (!scheduleData || !scheduleData.dailySchedule) {
                alert('ÊöÇÊó†Â∑≤ÁîüÊàêÁöÑÊó•Á®ãÔºåËØ∑ÂÖàÂéª"Êó•Á®ãÂà∂ÂÆö"ÁîüÊàêÊó•Á®ã');
                switchPage('schedule');
                return;
            }
            
            selectedLockedItems = [];
            const dailySchedule = scheduleData.dailySchedule || [];
            
            let itemsHtml = dailySchedule.map(day => {
                const items = day.items.length > 0 ? day.items.map(item => `
                    <label style="display:flex;align-items:center;padding:12px;background:${item.isLocked?'#fef3c7':'#f9fafb'};border:1px solid ${item.isLocked?'#fcd34d':'#e5e7eb'};border-radius:10px;margin-bottom:8px;cursor:pointer;">
                        <input type="checkbox" class="lock-item-checkbox" data-date="${day.date}" data-task-type="${item.taskType}" data-task-id="${item.taskId}" data-task-name="${item.taskName}" data-planned-hours="${item.plannedHours}" data-deadline="${item.deadline||''}" ${item.isLocked?'checked':''} onchange="updateLockedSelection()" style="width:18px;height:18px;margin-right:12px;"/>
                        <div style="flex:1;">
                            <div style="font-size:14px;color:#374151;">${item.taskType==='manager'?'üìå':'üìù'} ${item.taskName}</div>
                            <div style="font-size:12px;color:#9ca3af;margin-top:3px;">${item.taskTypeLabel} ¬∑ ${item.plannedHours}h${item.deadline?' ¬∑ Êà™Ê≠¢:'+formatDate(item.deadline):''}</div>
                        </div>
                        ${item.isLocked?'<span style="background:#f59e0b;color:white;padding:2px 8px;border-radius:4px;font-size:11px;">Â∑≤ÈîÅÂÆö</span>':''}
                    </label>
                `).join('') : '<div style="padding:15px;text-align:center;color:#9ca3af;font-size:13px;">ËØ•Êó•ÊöÇÊó†‰ªªÂä°ÂÆâÊéí</div>';
                
                return `<div style="margin-bottom:15px;">
                    <div style="font-weight:600;color:#374151;margin-bottom:10px;font-size:14px;">${day.dayLabel} <span style="font-weight:normal;color:#9ca3af;font-size:12px;">(${day.taskHours}h ‰ªªÂä°)</span></div>
                    ${items}
                </div>`;
            }).join('');
            
            const modal = document.createElement('div');
            modal.id = 'update-schedule-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:flex-end;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;width:100%;max-width:500px;max-height:85vh;border-radius:20px 20px 0 0;overflow:hidden;display:flex;flex-direction:column;">
                    <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div><h3 style="margin:0;color:white;font-size:18px;">üìÖ Êõ¥Êñ∞ÊéíÁ®ã</h3><p style="margin:5px 0 0;font-size:12px;color:rgba(255,255,255,0.8);">ÈÄâÊã©Ë¶Å‰øùÁïôÁöÑÊó•Á®ãÈ°π</p></div>
                            <button onclick="closeUpdateScheduleModal()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;">√ó</button>
                        </div>
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:15px;">
                        <div style="margin-bottom:15px;padding:12px;background:#f0fdf4;border-radius:8px;font-size:13px;color:#166534;">üí° ÂãæÈÄâÊÇ®ÊÉ≥‰øùÁïôÁöÑ‰ªªÂä°ÂÆâÊéíÔºåËøô‰∫õ‰ªªÂä°Â∞Ü‰øùÊåÅÂú®ÂéüÊù•ÁöÑÊó∂Èó¥ÊÆµ„ÄÇ</div>
                        ${itemsHtml}
                    </div>
                    <div style="padding:15px;border-top:1px solid #e5e7eb;background:#f9fafb;">
                        <div style="text-align:center;margin-bottom:10px;font-size:13px;color:#666;">Â∑≤ÈÄâÊã© <span id="locked-count">0</span> ‰∏™Ë¶Å‰øùÁïôÁöÑÊó•Á®ãÈ°π</div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeUpdateScheduleModal()" style="flex:1;padding:12px;border:1px solid #e5e7eb;background:white;border-radius:10px;font-size:14px;cursor:pointer;">ÂèñÊ∂à</button>
                            <button onclick="executeUpdateSchedule()" style="flex:2;padding:12px;border:none;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">üîÑ ÈáçÊñ∞ÊéíÁ®ã</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            updateLockedSelection();
        }
        
        function updateLockedSelection() {
            const checkboxes = document.querySelectorAll('.lock-item-checkbox:checked');
            selectedLockedItems = Array.from(checkboxes).map(cb => ({
                date: cb.dataset.date,
                task_type: cb.dataset.taskType,
                task_id: parseInt(cb.dataset.taskId),
                task_name: cb.dataset.taskName,
                planned_hours: parseFloat(cb.dataset.plannedHours),
                deadline: cb.dataset.deadline || null
            }));
            const countEl = document.getElementById('locked-count');
            if (countEl) countEl.textContent = selectedLockedItems.length;
        }
        
        function closeUpdateScheduleModal() {
            const modal = document.getElementById('update-schedule-modal');
            if (modal) modal.remove();
        }
        
        async function executeUpdateSchedule() {
            try {
                const response = await fetch(`${API_BASE}/schedule/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_id: currentUser.id,
                        days: 14,
                        daily_hours: 8,
                        urgency_weight: scheduleWeights.urgency,
                        importance_weight: scheduleWeights.importance,
                        continuity_weight: scheduleWeights.continuity,
                        locked_items: selectedLockedItems
                    })
                });
                const result = await response.json();
                if (result.success) {
                    closeUpdateScheduleModal();
                    alert('‚úÖ ÊéíÁ®ãÂ∑≤Êõ¥Êñ∞ÔºÅËØ∑Êü•ÁúãÊñ∞ÁöÑÊó•Á®ãÂÆâÊéí„ÄÇ');
                    switchPage('schedule');
                } else {
                    alert(result.message || 'Êõ¥Êñ∞Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊéíÁ®ãÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }
        
        // Ê∏≤ÊüìËøõÂ∫¶ÁéØ
        function renderProgressRing(progress) {
            const radius = 16;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (progress / 100) * circumference;
            
            // Ê†πÊçÆËøõÂ∫¶Á°ÆÂÆöÈ¢úËâ≤
            let color = '#10b981';  // ÁªøËâ≤
            if (progress < 30) color = '#ef4444';  // Á∫¢Ëâ≤
            else if (progress < 70) color = '#f59e0b';  // ÈªÑËâ≤
            
            return `
                <div class="progress-ring">
                    <svg width="40" height="40">
                        <circle class="progress-ring-bg" cx="20" cy="20" r="${radius}"/>
                        <circle class="progress-ring-fill" cx="20" cy="20" r="${radius}"
                            stroke="${color}"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${offset}"/>
                    </svg>
                    <span class="progress-ring-text">${Math.round(progress)}%</span>
                </div>
            `;
        }
        
        // Ê∏≤ÊüìÂª∂ÊúüÈ£éÈô©ÂíåÁªüËÆ°
        function renderDelayRisks(risks) {
            const stats = scheduleData.delay_statistics || {};
            const riskLabels = {
                'overdue': 'Â∑≤ÈÄæÊúü',
                'high': 'È´òÈ£éÈô©',
                'medium': '‰∏≠È£éÈô©',
                'low': '‰ΩéÈ£éÈô©'
            };
            
            const hasRisks = stats.delayed_tasks > 0 || stats.high_risk_tasks > 0;
            const bgColor = hasRisks ? 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)' : 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
            const titleColor = hasRisks ? '#991b1b' : '#065f46';
            
            // Âª∂ÊúüÁªüËÆ°Âç°Áâá
            let html = `
                <div class="delay-risks-section" style="margin-bottom: 0; ${risks.length > 0 ? 'border-radius: 12px 12px 0 0;' : ''}">
                    <div class="delay-risks-header" style="background: ${bgColor}; color: ${titleColor};">
                        <span>üìä ÊåâÊ≠§Êó•Á®ãÊâßË°åÁöÑÂª∂ÊúüÊÉÖÂÜµ</span>
                    </div>
                    <div style="padding: 15px;">
                        <!-- Âª∂ÊúüÁéáÁªüËÆ° -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <div style="flex: 1; background: ${hasRisks ? '#fef2f2' : '#ecfdf5'}; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold; color: ${hasRisks ? '#dc2626' : '#10b981'};">${stats.delay_rate || 0}%</div>
                                <div style="font-size: 12px; color: ${hasRisks ? '#991b1b' : '#065f46'};">Âª∂ÊúüÁéá</div>
                            </div>
                            <div style="flex: 1; background: ${stats.risk_rate > 0 ? '#fff7ed' : '#ecfdf5'}; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 28px; font-weight: bold; color: ${stats.risk_rate > 0 ? '#ea580c' : '#10b981'};">${stats.risk_rate || 0}%</div>
                                <div style="font-size: 12px; color: ${stats.risk_rate > 0 ? '#9a3412' : '#065f46'};">È£éÈô©Áéá</div>
                            </div>
                        </div>
                        
                        ${!hasRisks && stats.risk_rate === 0 ? `
                            <div style="background: #ecfdf5; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                                <div style="font-size: 32px; margin-bottom: 5px;">üéâ</div>
                                <div style="color: #065f46; font-weight: 600;">Â§™Ê£í‰∫ÜÔºÅÊâÄÊúâ‰ªªÂä°ÈÉΩËÉΩÊåâÊó∂ÂÆåÊàê</div>
                            </div>
                        ` : ''}
                        
                        <!-- ËØ¶ÁªÜÁªüËÆ° -->
                        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; font-size: 13px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">‰ªªÂä°ÊÄªÊï∞</span>
                                <span style="font-weight: 600;">${stats.total_tasks || 0} ‰∏™</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: ${stats.delayed_tasks > 0 ? '#dc2626' : '#666'};">Â∑≤Âª∂Êúü‰ªªÂä°</span>
                                <span style="font-weight: 600; color: ${stats.delayed_tasks > 0 ? '#dc2626' : '#10b981'};">${stats.delayed_tasks || 0} ‰∏™</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: ${stats.high_risk_tasks > 0 ? '#ea580c' : '#666'};">È´òÈ£éÈô©‰ªªÂä°</span>
                                <span style="font-weight: 600; color: ${stats.high_risk_tasks > 0 ? '#ea580c' : '#10b981'};">${stats.high_risk_tasks || 0} ‰∏™</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #666;">Êú™ÊéíÂ∑•Êó∂</span>
                                <span style="font-weight: 600; color: ${stats.total_delay_hours > 0 ? '#dc2626' : '#10b981'};">${stats.total_delay_hours || 0} Â∞èÊó∂</span>
                            </div>
                        </div>
            `;
            
            // ÊòæÁ§∫ÂÖ∑‰ΩìÂª∂ÊúüÂ§©Êï∞
            if (stats.delay_days_info && stats.delay_days_info.length > 0) {
                html += `
                        <div style="margin-top: 15px;">
                            <div style="font-size: 13px; font-weight: 600; color: #dc2626; margin-bottom: 10px;">üìõ Âª∂Êúü‰ªªÂä°ËØ¶ÊÉÖÔºàÂª∂ÊúüÂ§©Êï∞ & Ââ©‰ΩôÂ∑•Êó∂Ôºâ</div>
                            ${stats.delay_days_info.map(d => `
                                <div style="background: #fee2e2; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px; color: #991b1b; flex: 1;">${d.name}</span>
                                    <div style="text-align: right; white-space: nowrap;">
                                        <span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">
                                            Âª∂Êúü ${d.days} Â§©
                                        </span>
                                        <span style="color: #991b1b; font-size: 11px; margin-left: 5px;">
                                            Ââ©‰Ωô ${d.hours}h
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // È£éÈô©ÂàóË°®
            if (risks.length > 0) {
                html += `
                    <div class="delay-risks-section" style="margin-top: 0; border-radius: 0 0 12px 12px; border-top: 1px solid #e5e7eb;">
                        <div class="delay-risks-header">
                            <span>‚ö†Ô∏è È£éÈô©È¢ÑË≠¶ÂàóË°®</span>
                            <span style="font-size: 12px; font-weight: normal;">${risks.length} È°π</span>
                        </div>
                        ${risks.map(risk => `
                            <div class="delay-risk-item">
                                <div class="delay-risk-name">
                                    ${risk.type === 'manager' ? 'üìå' : 'üìù'} ${risk.name}
                                </div>
                                <div class="delay-risk-meta">
                                    <span>${risk.typeLabel}</span>
                                    ${risk.deadline ? `<span>Êà™Ê≠¢: ${formatDate(risk.deadline)}</span>` : '<span>Êó†Êà™Ê≠¢Êó•Êúü</span>'}
                                    <span>ËøõÂ∫¶: ${risk.progress}%</span>
                                    <span>Â∑≤Êéí: ${risk.scheduled_hours}/${risk.estimated_hours}h</span>
                                </div>
                                <div class="delay-risk-reason risk-${risk.risk_level}">
                                    <strong>${riskLabels[risk.risk_level] || risk.risk_level}</strong>: ${risk.risk_reason}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return html;
        }
        
        // Ê†ºÂºèÂåñÊó•ÊúüÊó∂Èó¥
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return `${date.getMonth() + 1}Êúà${date.getDate()}Êó• ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            } catch {
                return dateStr;
            }
        }

        // ÊòæÁ§∫Ê∑ªÂä†Ëá™‰∏ª‰ªªÂä°Ê®°ÊÄÅÊ°Ü
        function showAddSelfTaskModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'self-task-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Ê∑ªÂä†Ëá™‰∏ª‰ªªÂä°</h3>
                        <button class="modal-close" onclick="closeModal('self-task-modal')">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>‰ªªÂä°ÂêçÁß∞ *</label>
                            <input type="text" id="self-task-name" placeholder="‰æãÂ¶ÇÔºöÂáÜÂ§áÂë®Êä•ÊùêÊñô">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>È¢ÑËÆ°ËÄóÊó∂ÔºàÂ∞èÊó∂Ôºâ *</label>
                                <input type="number" id="self-task-hours" placeholder="‰æãÂ¶ÇÔºö2" min="0.5" step="0.5">
                            </div>
                            <div class="form-group">
                                <label>Êà™Ê≠¢Êó•Êúü</label>
                                <input type="date" id="self-task-deadline">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‰ªªÂä°Á±ªÂûã *</label>
                            <select id="self-task-type">
                                <option value="">ËØ∑ÈÄâÊã©</option>
                                <option value="project">È°πÁõÆÁ±ª‰ªªÂä°Ôºà‰∏é‰∏ªÂ∑•‰ΩúÁõ∏ÂÖ≥Ôºâ</option>
                                <option value="temporary">‰∏¥Êó∂‰∫ãÂä°ÔºàÂ∏ÆÂêå‰∫ãÂ§ÑÁêÜÁ≠âÔºâ</option>
                                <option value="learning">‰∏™‰∫∫Â≠¶‰π†/ÂáÜÂ§á</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>‰ªªÂä°ÊèèËø∞</label>
                            <textarea id="self-task-desc" placeholder="ÔºàÈÄâÂ°´Ôºâ‰ªªÂä°ËØ¶ÁªÜËØ¥Êòé" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal('self-task-modal')">ÂèñÊ∂à</button>
                        <button class="btn btn-primary" onclick="submitSelfTask()">Á°ÆËÆ§Ê∑ªÂä†</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ÊòæÁ§∫Ê∑ªÂä†‰∏çÂèØÁî®Êó∂Èó¥Ê®°ÊÄÅÊ°Ü
        function showAddUnavailableTimeModal() {
            const today = new Date().toISOString().split('T')[0];
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'unavailable-time-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Ê∑ªÂä†‰∏çÂèØÁî®Êó∂Èó¥</h3>
                        <button class="modal-close" onclick="closeModal('unavailable-time-modal')">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Êó•Êúü *</label>
                            <input type="date" id="unavailable-date" value="${today}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ÂºÄÂßãÊó∂Èó¥ *</label>
                                <input type="time" id="unavailable-start" value="09:00">
                            </div>
                            <div class="form-group">
                                <label>ÁªìÊùüÊó∂Èó¥ *</label>
                                <input type="time" id="unavailable-end" value="18:00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ÂéüÂõ†Á±ªÂûã *</label>
                            <select id="unavailable-type">
                                <option value="">ËØ∑ÈÄâÊã©</option>
                                <option value="meeting">‰ºöËÆÆ</option>
                                <option value="travel">Âá∫Â∑Æ</option>
                                <option value="training">ÂüπËÆ≠</option>
                                <option value="leave">ËØ∑ÂÅá</option>
                                <option value="other">ÂÖ∂‰ªñ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Â§áÊ≥®ËØ¥Êòé</label>
                            <textarea id="unavailable-note" placeholder="ÔºàÈÄâÂ°´ÔºâÂÖ∑‰ΩìËØ¥Êòé" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal('unavailable-time-modal')">ÂèñÊ∂à</button>
                        <button class="btn btn-primary" onclick="submitUnavailableTime()">Á°ÆËÆ§Ê∑ªÂä†</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Êèê‰∫§Ëá™‰∏ª‰ªªÂä°
        async function submitSelfTask() {
            const name = document.getElementById('self-task-name').value.trim();
            const hours = document.getElementById('self-task-hours').value;
            const deadline = document.getElementById('self-task-deadline').value;
            const taskType = document.getElementById('self-task-type').value;
            const description = document.getElementById('self-task-desc').value.trim();

            if (!name || !hours || !taskType) {
                alert('ËØ∑Â°´ÂÜôÂøÖÂ°´È°π');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/self-tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_id: currentUser.id,
                        name: name,
                        estimated_hours: parseFloat(hours),
                        deadline: deadline || null,
                        task_type: taskType,
                        description: description || null
                    })
                });

                if (response.ok) {
                    closeModal('self-task-modal');
                    // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÂπ∂Âà∑Êñ∞ÂΩìÂâçÈ°µÈù¢
                    await loadAllSelfTasks();
                    await loadWorkloadData();
                    if (currentPage === 'tasks') {
                        renderSelfTasksList();
                        // Êõ¥Êñ∞ÁªüËÆ°
                        const statItems = document.querySelectorAll('.stat-item');
                        if (statItems[2]) {
                            statItems[2].querySelector('.stat-number').textContent = allSelfTasks.length;
                        }
                        // Êõ¥Êñ∞TabËÆ°Êï∞
                        const tabs = document.querySelectorAll('.tab');
                        if (tabs[1]) {
                            tabs[1].textContent = `Ëá™‰∏ª‰ªªÂä° (${allSelfTasks.length})`;
                        }
                    } else {
                    renderWorkloadPage();
                    }
                    alert('‚úÖ Ëá™‰∏ª‰ªªÂä°Ê∑ªÂä†ÊàêÂäüÔºÅ');
                    showScheduleUpdateReminder('Ê∑ªÂä†Ëá™‰∏ª‰ªªÂä°');
                } else {
                    const error = await response.json();
                    alert('Ê∑ªÂä†Â§±Ë¥•: ' + (error.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (err) {
                alert('Ê∑ªÂä†Â§±Ë¥•: ' + err.message);
            }
        }

        // Êèê‰∫§‰∏çÂèØÁî®Êó∂Èó¥
        async function submitUnavailableTime() {
            const date = document.getElementById('unavailable-date').value;
            const startTime = document.getElementById('unavailable-start').value;
            const endTime = document.getElementById('unavailable-end').value;
            const reasonType = document.getElementById('unavailable-type').value;
            const note = document.getElementById('unavailable-note').value.trim();

            if (!date || !startTime || !endTime || !reasonType) {
                alert('ËØ∑Â°´ÂÜôÂøÖÂ°´È°π');
                return;
            }

            if (startTime >= endTime) {
                alert('ÁªìÊùüÊó∂Èó¥ÂøÖÈ°ªÊôö‰∫éÂºÄÂßãÊó∂Èó¥');
                return;
            }

            try {
                console.log('Êèê‰∫§‰∏çÂèØÁî®Êó∂Èó¥:', { date, startTime, endTime, reasonType, note });
                
                const response = await fetch(`${API_BASE}/unavailable-times`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_id: currentUser.id,
                        date: date,
                        start_time: startTime,
                        end_time: endTime,
                        reason_type: reasonType,
                        note: note || null
                    })
                });

                console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Ê∑ªÂä†ÊàêÂäü:', result);
                    closeModal('unavailable-time-modal');
                    // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÂπ∂Âà∑Êñ∞ÂΩìÂâçÈ°µÈù¢
                    await loadAllUnavailableTimes();
                    await loadWorkloadData();
                    if (currentPage === 'tasks') {
                        renderUnavailableTimesList();
                        // Êõ¥Êñ∞TabËÆ°Êï∞
                        const tabs = document.querySelectorAll('.tab');
                        if (tabs[2]) {
                            tabs[2].textContent = `‰∏çÂèØÁî®Êó∂Èó¥ (${allUnavailableTimes.length})`;
                        }
                    } else {
                    renderWorkloadPage();
                    }
                    alert('‚úÖ ‰∏çÂèØÁî®Êó∂Èó¥Ê∑ªÂä†ÊàêÂäüÔºÅ');
                    showScheduleUpdateReminder('Ê∑ªÂä†‰∏çÂèØÁî®Êó∂Èó¥');
                } else {
                    const error = await response.json();
                    console.error('Ê∑ªÂä†Â§±Ë¥•:', error);
                    alert('Ê∑ªÂä†Â§±Ë¥•: ' + (error.error || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (err) {
                console.error('ËØ∑Ê±ÇÂºÇÂ∏∏:', err);
                alert('Ê∑ªÂä†Â§±Ë¥•: ' + err.message);
            }
        }

        // Âà†Èô§Ëá™‰∏ª‰ªªÂä°
        async function deleteSelfTask(taskId) {
            if (!confirm('Á°ÆËÆ§Âà†Èô§Ê≠§‰ªªÂä°ÂêóÔºü')) return;

            try {
                const response = await fetch(`${API_BASE}/self-tasks/${taskId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadAllSelfTasks();
                    await loadWorkloadData();
                    if (currentPage === 'tasks') {
                        renderSelfTasksList();
                        // Êõ¥Êñ∞ÁªüËÆ°ÂíåTabËÆ°Êï∞
                        const statItems = document.querySelectorAll('.stat-item');
                        if (statItems[2]) {
                            statItems[2].querySelector('.stat-number').textContent = allSelfTasks.length;
                        }
                        const tabs = document.querySelectorAll('.tab');
                        if (tabs[1]) {
                            tabs[1].textContent = `Ëá™‰∏ª‰ªªÂä° (${allSelfTasks.length})`;
                        }
                    } else {
                    renderWorkloadPage();
                    }
                    showScheduleUpdateReminder('Âà†Èô§‰ªªÂä°');
                } else {
                    alert('Âà†Èô§Â§±Ë¥•');
                }
            } catch (err) {
                alert('Âà†Èô§Â§±Ë¥•: ' + err.message);
            }
        }

        // Âà†Èô§‰∏çÂèØÁî®Êó∂Èó¥
        async function deleteUnavailableTime(timeId) {
            if (!confirm('Á°ÆËÆ§Âà†Èô§Ê≠§Êó∂Èó¥ÊÆµÂêóÔºü')) return;

            try {
                const response = await fetch(`${API_BASE}/unavailable-times/${timeId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadAllUnavailableTimes();
                    await loadWorkloadData();
                    if (currentPage === 'tasks') {
                        renderUnavailableTimesList();
                        // Êõ¥Êñ∞TabËÆ°Êï∞
                        const tabs = document.querySelectorAll('.tab');
                        if (tabs[2]) {
                            tabs[2].textContent = `‰∏çÂèØÁî®Êó∂Èó¥ (${allUnavailableTimes.length})`;
                        }
                    } else {
                    renderWorkloadPage();
                    }
                    showScheduleUpdateReminder('Âà†Èô§‰∏çÂèØÁî®Êó∂Èó¥');
                } else {
                    alert('Âà†Èô§Â§±Ë¥•');
                }
            } catch (err) {
                alert('Âà†Èô§Â§±Ë¥•: ' + err.message);
            }
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            if (confirm('Á°ÆËÆ§ÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                currentUser = null;
                allTasks = [];
                currentFilter = 'manager';
                currentPage = 'tasks';
                workloadData = null;
                allSelfTasks = [];
                allUnavailableTimes = [];
                clearLoginState();  // Ê∏ÖÈô§ÁôªÂΩïÁä∂ÊÄÅ
                showLogin();
            }
        }

        // ÂàùÂßãÂåñ
        async function init() {
            // Â∞ùËØïÊÅ¢Â§çÁôªÂΩïÁä∂ÊÄÅ
            if (loadLoginState()) {
                console.log('ÊÅ¢Â§çÁôªÂΩïÁä∂ÊÄÅ:', currentUser.name);
                try {
                    // È™åËØÅÁî®Êà∑ÊòØÂê¶‰ªçÁÑ∂ÊúâÊïà
                    const response = await fetch(`${API_BASE}/employees`);
                    const employees = await response.json();
                    const employee = employees.find(e => e.dingtalk_id === currentUser.dingtalk_id);
                    
                    if (employee) {
                        currentUser = employee;
                        await loadTasks();
                        if (currentPage === 'workload') {
                            showWorkloadPage();
                        } else if (currentPage === 'schedule') {
                            showSchedulePage();
                        } else {
                            showTaskPage();
                        }
                        return;
                    }
                } catch (err) {
                    console.error('È™åËØÅÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', err);
                }
                // È™åËØÅÂ§±Ë¥•ÔºåÊ∏ÖÈô§Áä∂ÊÄÅ
                clearLoginState();
            }
            
            // ÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢
        showLogin();
        }
        
        init();

        // ÂÆöÊúüÂà∑Êñ∞ÔºàÊØè30ÁßíÔºâ
        setInterval(() => {
            if (currentUser) {
                loadTasks().then(() => {
                    const container = document.getElementById(currentFilter + '-tasks');
                    if (container) renderTasks();
                });
            }
        }, 30000);
    </script>
</body>
</html>
