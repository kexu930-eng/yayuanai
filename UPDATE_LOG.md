# 任务分配系统 - 功能更新日志

## 更新日期：2025-12-07（v2 - 自动分配功能）

---

## 零、智能自动任务分配功能 🤖

### 0.1 功能概述

在管理员端"任务分配"模块新增**智能自动分配**功能，基于现有数据自动推荐最佳任务分配方案。

### 0.2 自动分配算法

#### 任务排序规则
```
1. 按任务重要性排序（高优先）
2. 同等重要性按截止时间近的优先
```

#### 员工筛选条件
```
1. 技能匹配度 ≥ 阈值（默认80%）
   - 匹配度 = 员工具备的技能数 / 任务所需技能数 × 100%
   
2. 当前负载指数 < 阈值（默认85%）
   - 基于分摊法计算的本周负载
```

#### 员工评分算法（总分100分）
| 维度 | 权重 | 计算方式 |
|------|------|----------|
| 技能匹配度 | 40% | (匹配度/100) × 40 |
| 技能评分 | 20% | (平均评分/10) × 20 |
| 负载指数 | 25% | ((100-负载)/100) × 25，负载越低分越高 |
| 工时匹配 | 15% | 剩余可用工时能否覆盖任务耗时 |

#### 分配流程
```
1. 获取所有未分配/已拒绝的任务
2. 按重要性+截止时间排序
3. 对每个任务：
   a. 筛选符合条件的候选员工
   b. 计算每个候选员工的评分
   c. 选择评分最高的员工
   d. 实时更新该员工的负载数据（模拟）
4. 可选：检测负载差异，提示手动调整
5. 生成分配预览，等待管理员确认
6. 确认后创建分配记录并发送钉钉通知
```

### 0.3 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 技能匹配阈值 | 80% | 低于此阈值的员工不参与候选 |
| 负载阈值 | 85% | 负载超过此阈值的员工不参与候选 |
| 负载平衡 | 开启 | 检测负载差异超过30%时提示 |

### 0.4 API接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/auto-assign` | POST | 运行自动分配算法，返回分配预览 |
| `/api/auto-assign/confirm` | POST | 确认分配结果，创建记录并发送通知 |

#### 请求参数示例
```json
{
  "manager_dingtalk_id": "xxx",
  "skill_match_threshold": 80,
  "workload_threshold": 85,
  "enable_balance": true
}
```

#### 响应示例
```json
{
  "success": true,
  "message": "自动分配完成，共匹配 3 个任务",
  "assignments": [
    {
      "task": { "id": 1, "name": "任务A", "importance": 9 },
      "employee": { "id": 2, "name": "张三" },
      "score": 85.5,
      "score_details": {
        "skill_match": 32,
        "skill_rating": 16,
        "workload": 22.5,
        "hours_match": 15
      },
      "match_ratio": 80,
      "workload_before": 30,
      "workload_after": 45
    }
  ],
  "unassigned_reasons": [
    { "task_id": 4, "task_name": "任务D", "reason": "没有符合条件的候选员工" }
  ],
  "statistics": {
    "total_tasks": 4,
    "assigned_tasks": 3,
    "unassigned_tasks": 1
  }
}
```

### 0.5 前端界面

#### 操作入口
- 位置：管理员端 → 任务分配 → **页面最下方**"智能自动分配"区域
- 配置：支持调整技能匹配阈值、负载阈值、是否启用负载平衡

#### 结果展示
- **统计卡片**：待分配任务数、成功匹配数、未能匹配数、延期风险数
- **员工负载变化预览**：显示每个员工分配前后的负载变化，含进度条和等级标签
- **任务延期风险预警**：显示有延期风险的任务，含风险等级和原因说明
- **分配详情**：每条分配显示任务信息、员工信息、评分明细、候选人列表
- **未分配提示**：显示未能分配的任务及原因
- **负载平衡警告**：负载差异过大时提示手动调整

#### 员工负载变化展示
| 信息 | 说明 |
|------|------|
| 分配前负载 | 带颜色进度条和百分比 |
| 分配后负载 | 带颜色进度条和百分比 |
| 负载变化 | 变化值，正值红色/负值绿色 |
| 负载等级 | 较轻(<50%)/中等(50-80%)/高负载(80-100%)/超负荷(>100%) |
| 分配任务数 | 被分配的任务数量和总工时 |

#### 任务延期风险等级
| 等级 | 颜色 | 触发条件 |
|------|------|----------|
| 已逾期 | 红色 | 截止日期已过 |
| 紧急 | 红色 | 今日截止 |
| 高风险 | 橙色 | 任务耗时 > 剩余工作时间 |
| 中风险 | 橙色 | 员工负载>90% 或 剩余≤3天 |

#### 操作按钮
- **移除**：可移除单条不满意的分配
- **取消**：清空所有分配结果
- **确认并发送通知**：创建分配记录并发送钉钉通知

---

## 一、管理员端（人工任务分配）改进

### 1.1 任务字段新增
任务创建时新增以下字段：
- **预计耗时**（小时）- 必填
- **重要程度**（1-10分）- 滑块选择，带颜色指示
- **重要度说明** - 选填

### 1.2 管理员信息显示
- 页面头部显示当前登录管理员名字
- 新增退出登录按钮

---

## 二、员工端（我的任务管理）- 负载采集与可视化

### 2.1 新增数据模型

#### SelfTask（员工自主任务表）
```
位置：models.py → class SelfTask
数据库表：self_tasks

字段：
- id: 主键
- employee_id: 员工ID（外键）
- name: 任务名称
- estimated_hours: 预计耗时（小时）
- deadline: 截止日期
- task_type: 任务类型（project/temporary/learning）
- description: 任务描述
- status: 状态（pending/completed）
- created_at: 创建时间
```

#### UnavailableTime（员工不可用时间表）
```
位置：models.py → class UnavailableTime
数据库表：unavailable_times

字段：
- id: 主键
- employee_id: 员工ID（外键）
- date: 日期（YYYY-MM-DD）
- start_time: 开始时间（HH:MM）
- end_time: 结束时间（HH:MM）
- reason_type: 原因类型（meeting/travel/training/leave/other）
- note: 备注说明
```

### 2.2 负载计算算法 - 分摊法

#### 核心逻辑
```
传统做法问题：只统计截止日期在本周内的任务，会遗漏跨周任务。

分摊法解决方案：
1. 确定任务周期（开始日期 → 截止日期）
2. 计算任务周期内的工作日数量
3. 将任务总耗时均匀分摊到每个工作日
4. 只累加本周内的分摊时长
```

#### 计算公式
```
每日分摊工时 = 任务总耗时 / 任务周期工作日数

本周任务工时 = Σ(本周每天的分摊工时)

本周可用工时 = 工作日数 × 8h - 不可用时间

负载指数 = (本周任务工时 / 本周可用工时) × 100%
```

#### 示例
```
任务：总耗时 20h，周期 12月2日-12月13日（10个工作日）
每日分摊：20h ÷ 10天 = 2h/天

本周（12月2日-6日，5个工作日）分摊：2h × 5 = 10h
```

#### 负载等级
| 负载比例 | 等级 | 颜色 |
|---------|------|------|
| < 50% | 较轻 | 绿色 |
| 50-80% | 中等 | 黄色 |
| 80-100% | 高负载 | 橙色 |
| > 100% | 超负荷 | 红色 |

### 2.3 API接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/self-tasks` | GET | 获取自主任务列表 |
| `/api/self-tasks` | POST | 创建自主任务 |
| `/api/self-tasks/<id>` | DELETE | 删除自主任务 |
| `/api/unavailable-times` | GET | 获取不可用时间列表 |
| `/api/unavailable-times` | POST | 创建不可用时间 |
| `/api/unavailable-times/<id>` | DELETE | 删除不可用时间 |
| `/api/workload/<employee_id>` | GET | **获取负载数据（核心）** |

### 2.4 前端展示

#### 负载页面组件
- **圆环进度条**：显示负载百分比和等级
- **饼图**：本周时间分配（经理任务/自主任务/不可用/空闲）
- **柱状图**：每日工作负载对比
- **统计卡片**：各类工时汇总
- **详细列表**：显示每个任务的本周分摊工时

#### 任务类型
- 项目类任务（project）
- 临时事务（temporary）
- 个人学习/准备（learning）

#### 不可用时间类型
- 会议（meeting）
- 出差（travel）
- 培训（training）
- 请假（leave）
- 其他（other）

---

## 三、数据库迁移脚本

执行顺序：
```bash
# 1. 任务表新增字段（预计耗时、重要程度）
python3 migrate_add_task_fields.py

# 2. 负载相关表（自主任务、不可用时间）
python3 migrate_add_workload_tables.py
```

---

## 四、文件修改清单

| 文件 | 修改内容 |
|------|----------|
| `models.py` | Task新增3个字段；新增SelfTask、UnavailableTime模型 |
| `app.py` | 任务API处理新字段；新增负载相关API；分摊法计算函数；**新增自动分配API** |
| `admin.html` | 任务表单新增字段；显示管理员名字；**新增智能自动分配界面** |
| `employee.html` | 新增"我的负载"页面；饼图/柱状图可视化 |
| `migrate_add_task_fields.py` | 新建 - 任务表迁移 |
| `migrate_add_workload_tables.py` | 新建 - 负载表迁移 |

---

## 五、自动分配功能新增代码

### 5.1 后端函数 (app.py)

| 函数 | 说明 |
|------|------|
| `calculate_skill_match(task, employee)` | 计算员工与任务的技能匹配度 |
| `get_employee_current_workload(employee_id)` | 获取员工当前负载数据（简化版） |
| `score_employee_for_task(...)` | 给候选员工打分（四维度评分） |
| `auto_assign_tasks()` | 自动分配主逻辑 - POST /api/auto-assign |
| `confirm_auto_assignments()` | 确认分配结果 - POST /api/auto-assign/confirm |

### 5.2 前端函数 (admin.html)

| 函数 | 说明 |
|------|------|
| `runAutoAssign()` | 运行自动分配算法 |
| `renderAutoAssignResult(result)` | 渲染自动分配结果 |
| `removeAutoAssignment(index)` | 移除单个自动分配 |
| `clearAutoAssignResult()` | 清空自动分配结果 |
| `confirmAutoAssign()` | 确认并发送自动分配 |

