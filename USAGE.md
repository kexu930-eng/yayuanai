# 任务分配系统 - 使用指南

## 🎉 系统已部署成功！

### 📍 访问地址

- **管理员端**:http://101.37.168.176:8082
- **员工端**: http://101.37.168.176:8082/employee
- **API文档**: http://101.37.168.176:8082/health

### 🚀 快速开始

#### 1️⃣ 管理员操作流程

**步骤1: 添加员工**
1. 访问管理员端
2. 点击"👥 员工管理"标签
3. 输入员工信息：
   - 员工姓名：例如 张三
   - 钉钉用户ID：例如 0109353429171130295
4. 点击"✅ 添加员工"

**步骤2: 创建任务**
1. 点击"📝 任务库管理"标签
2. 填写任务信息：
   - 任务名称：例如 系统升级任务
   - 任务描述：详细说明任务内容
   - 预计完成时间：可选
3. 点击"✅ 添加到任务库"

**步骤3: 分配任务**
1. 点击"🚀 任务分配"标签
2. 选择任务和对应的员工
3. 如需批量分配，点击"➕ 添加更多"
4. 预览确认后，点击"🚀 确认发送钉钉通知"

**步骤4: 查看反馈**
1. 点击"📊 分配记录"标签
2. 查看所有任务的分配状态：
   - ⏳ 待处理：员工还未响应
   - ✅ 已接受：员工已接受任务
   - ❌ 已拒绝：员工拒绝并说明理由

#### 2️⃣ 员工操作流程

**方式一：通过钉钉通知**
1. 员工收到钉钉消息通知
2. 点击"查看任务详情"链接
3. 查看任务信息
4. 选择操作：
   - 点击"✅ 接受任务"
   - 或点击"❌ 拒绝任务"并填写理由

**方式二：直接访问员工端**
1. 访问员工端: http://101.37.168.176/:8082/employee
2. 输入自己的钉钉用户ID
3. 点击"查询"查看所有分配给自己的任务
4. 点击任务卡片查看详情和操作

### 🔧 服务管理命令

```bash
cd /root/workspace/xk/yayuan/simple_distribute

# 查看服务状态
./manage.sh status

# 重启服务
./manage.sh restart

# 查看实时日志
./manage.sh logs

# 健康检查
./manage.sh health

# 停止服务
./manage.sh stop

# 启动服务
./manage.sh start
```

### 📊 测试API接口

```bash
# 健康检查
curl http://127.0.0.1:8082/health

# 获取所有任务
curl http://127.0.0.1:8082/api/tasks

# 获取所有员工
curl http://127.0.0.1:8082/api/employees

# 获取所有分配记录
curl http://127.0.0.1:8082/api/assignments
```

### 🔥 开放防火墙（公网访问）

如果需要从公网访问，执行：

```bash
sudo firewall-cmd --permanent --add-port=8082/tcp
sudo firewall-cmd --reload

# 验证
sudo firewall-cmd --list-ports
```

### 📁 重要文件位置

```
/root/workspace/xk/yayuan/simple_distribute/
├── admin.html                  # 管理员端页面
├── employee.html               # 员工端页面
├── app.py                      # Flask后端应用
├── models.py                   # 数据库模型
├── task_distribution.db        # SQLite数据库
├── logs/                       # 日志目录
│   ├── access.log             # 访问日志
│   ├── error.log              # 错误日志（实际是gunicorn日志）
│   └── supervisor.log         # Supervisor日志
├── deploy.sh                   # 一键部署脚本
└── manage.sh                   # 服务管理脚本
```

### 🔍 故障排查

#### 问题1: 无法访问页面

```bash
# 检查服务状态
./manage.sh status

# 检查端口监听
netstat -tlnp | grep -E ':(8002|8082)'

# 检查Nginx
sudo systemctl status nginx

# 查看日志
./manage.sh logs
```

#### 问题2: 任务分配失败

```bash
# 查看后端日志
tail -f logs/supervisor.log

# 测试健康检查
curl http://127.0.0.1:8082/health

# 检查数据库
ls -lh task_distribution.db
```

#### 问题3: 钉钉通知未收到

检查：
1. 钉钉用户ID是否正确
2. 钉钉机器人配置：`../dingding/robot.py`
3. 网络连接是否正常

### 🎯 使用建议

1. **首次使用**：先添加1-2个测试员工和任务，验证流程
2. **钉钉ID获取**：从钉钉管理后台或开发者工具获取
3. **定期备份**：定期备份 `task_distribution.db` 数据库文件
4. **日志管理**：定期清理 `logs/` 目录下的日志文件

### 📞 常见场景

**场景1: 批量分配任务**
- 进入任务分配页面
- 点击多次"➕ 添加更多"
- 为不同员工分配不同任务
- 一次性发送所有通知

**场景2: 查看员工反馈**
- 进入分配记录
- 筛选状态（待处理/已接受/已拒绝）
- 对于拒绝的任务，查看拒绝理由
- 考虑重新分配给其他员工

**场景3: 重新部署**
- 修改代码后，运行 `./manage.sh restart`
- 或完整重新部署：`sudo bash deploy.sh`

### ✨ 特色功能

1. **实时同步**：管理员端每5秒自动刷新分配记录状态
2. **批量操作**：支持一次分配多个任务
3. **历史记录**：所有分配和响应都有完整记录
4. **友好界面**：淡灰色背景，现代化UI设计

### 🎨 界面特点

- **管理员端**：淡灰色背景 (#f5f5f5)，四个功能标签
- **员工端**：简洁清晰的任务展示
- **响应式设计**：支持手机、平板、电脑访问

---

**系统版本**: 1.0.0  
**部署日期**: 2024-11-28  
**技术栈**: Flask + SQLite + Gunicorn + Nginx + Supervisor

🎉 **现在就可以开始使用了！**

