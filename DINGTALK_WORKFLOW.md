# é’‰é’‰ä»»åŠ¡é€šçŸ¥å®Œæ•´æµç¨‹

## ğŸ¯ ç³»ç»Ÿæ¶æ„

```
ç®¡ç†å‘˜åˆ†é…ä»»åŠ¡
    â†“
ç³»ç»Ÿå‘é€é’‰é’‰é€šçŸ¥ï¼ˆåŒ…å«3ä¸ªæŒ‰é’®ï¼‰
    â†“
å‘˜å·¥åœ¨é’‰é’‰æ”¶åˆ°æ¶ˆæ¯
    â†“
å‘˜å·¥ç‚¹å‡»æŒ‰é’®æ“ä½œ
    â†“
åç«¯æ¥æ”¶å¹¶å¤„ç†
    â†“
ç®¡ç†å‘˜æŸ¥çœ‹åé¦ˆ
```

## ğŸ“± é’‰é’‰æ¶ˆæ¯æ ¼å¼

å‘˜å·¥ä¼šæ”¶åˆ°å¦‚ä¸‹æ ¼å¼çš„é’‰é’‰æ¶ˆæ¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ”” æ–°ä»»åŠ¡åˆ†é…              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»»åŠ¡åç§°ï¼šç³»ç»Ÿå‡çº§ä»»åŠ¡        â”‚
â”‚                              â”‚
â”‚ ä»»åŠ¡æè¿°ï¼šå‡çº§ç³»ç»Ÿåˆ°æœ€æ–°ç‰ˆæœ¬  â”‚
â”‚                              â”‚
â”‚ è®¡åˆ’æ‰§è¡Œæ—¶é—´ï¼š2024-12-01     â”‚
â”‚              18:00:00        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…] [âˆšæ¥å—] [Ã—æ‹’ç»]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”˜ ä¸‰ä¸ªæŒ‰é’®çš„åŠŸèƒ½

### 1ï¸âƒ£ æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…æŒ‰é’®

**URLæ ¼å¼**: 
```
http://101.37.168.176:8082/employee?id={assignment_id}
```

**åŠŸèƒ½**ï¼š
- è·³è½¬åˆ°å‘˜å·¥ç«¯ä»»åŠ¡è¯¦æƒ…é¡µ
- æ˜¾ç¤ºå®Œæ•´çš„ä»»åŠ¡ä¿¡æ¯
- å¯ä»¥çœ‹åˆ°ä»»åŠ¡æè¿°ã€é¢„è®¡å®Œæˆæ—¶é—´ç­‰
- å¯ä»¥åœ¨é¡µé¢ä¸Šè¿›è¡Œæ¥å—/æ‹’ç»æ“ä½œ

---

### 2ï¸âƒ£ âˆš æ¥å—ä»»åŠ¡æŒ‰é’®

**URLæ ¼å¼**: 
```
http://101.37.168.176:8082/accept?id={assignment_id}
```

**æµç¨‹**ï¼š
1. å‘˜å·¥ç‚¹å‡»"âˆš æ¥å—ä»»åŠ¡"
2. è·³è½¬åˆ°æ¥å—ç¡®è®¤é¡µé¢ (`accept.html`)
3. é¡µé¢è‡ªåŠ¨è°ƒç”¨API: `/api/assignments/{id}/accept`
4. æ˜¾ç¤ºæ¥å—æˆåŠŸæç¤º
5. ä»»åŠ¡çŠ¶æ€å˜æ›´ä¸º"å·²æ¥å—"

**åç«¯å¤„ç†**ï¼š
```python
@app.route('/api/assignments/<int:assignment_id>/accept', methods=['GET', 'POST'])
def accept_assignment(assignment_id):
    assignment = Assignment.query.get_or_404(assignment_id)
    assignment.status = 'accepted'
    assignment.responded_at = datetime.now()
    db.session.commit()
    return jsonify({'message': 'ä»»åŠ¡å·²æ¥å—'})
```

---

### 3ï¸âƒ£ Ã— æ‹’ç»ä»»åŠ¡æŒ‰é’®

**URLæ ¼å¼**: 
```
http://101.37.168.176:8082/reject?id={assignment_id}
```

**æµç¨‹**ï¼š
1. å‘˜å·¥ç‚¹å‡»"Ã— æ‹’ç»ä»»åŠ¡"
2. è·³è½¬åˆ°æ‹’ç»ç†ç”±å¡«å†™é¡µé¢ (`reject.html`)
3. å‘˜å·¥å¡«å†™æ‹’ç»ç†ç”±ï¼ˆå¿…å¡«ï¼Œè‡³å°‘5ä¸ªå­—ç¬¦ï¼‰
4. ç‚¹å‡»"ç¡®è®¤æ‹’ç»"
5. é¡µé¢è°ƒç”¨API: `/api/assignments/{id}/reject`
6. æäº¤æ‹’ç»ç†ç”±
7. æ˜¾ç¤ºæäº¤æˆåŠŸæç¤º
8. ä»»åŠ¡çŠ¶æ€å˜æ›´ä¸º"å·²æ‹’ç»"

**åç«¯å¤„ç†**ï¼š
```python
@app.route('/api/assignments/<int:assignment_id>/reject', methods=['POST'])
def reject_assignment(assignment_id):
    assignment = Assignment.query.get_or_404(assignment_id)
    data = request.json
    assignment.status = 'rejected'
    assignment.reject_reason = data.get('reason', 'æœªæä¾›åŸå› ')
    assignment.responded_at = datetime.now()
    db.session.commit()
    return jsonify({'message': 'ä»»åŠ¡å·²æ‹’ç»'})
```

---

## ğŸ“Š å®Œæ•´ä½¿ç”¨æµç¨‹æ¼”ç¤º

### æ­¥éª¤1: ç®¡ç†å‘˜åˆ†é…ä»»åŠ¡

1. è®¿é—®ç®¡ç†å‘˜ç«¯: http://101.37.168.176:8082
2. è¿›å…¥"å‘˜å·¥ç®¡ç†"ï¼Œæ·»åŠ å‘˜å·¥ï¼š
   ```
   å§“å: å¼ ä¸‰
   é’‰é’‰ID: 0109353429171130295
   ```
3. è¿›å…¥"ä»»åŠ¡åº“ç®¡ç†"ï¼Œåˆ›å»ºä»»åŠ¡ï¼š
   ```
   ä»»åŠ¡åç§°: ç³»ç»Ÿå‡çº§
   æè¿°: å‡çº§ç³»ç»Ÿåˆ°æœ€æ–°ç‰ˆæœ¬
   é¢„è®¡å®Œæˆæ—¶é—´: 2024-12-01 18:00:00
   ```
4. è¿›å…¥"ä»»åŠ¡åˆ†é…"ï¼š
   - é€‰æ‹©ä»»åŠ¡: ç³»ç»Ÿå‡çº§
   - é€‰æ‹©å‘˜å·¥: å¼ ä¸‰
   - ç‚¹å‡»"ç¡®è®¤å‘é€é’‰é’‰é€šçŸ¥"

### æ­¥éª¤2: åç«¯å¤„ç†

ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œï¼š
```python
# ç”ŸæˆURL
detail_url = "http://101.37.168.176:8082/employee?id=1"
accept_url = "http://101.37.168.176:8082/accept?id=1"
reject_url = "http://101.37.168.176:8082/reject?id=1"

# è°ƒç”¨é’‰é’‰APIå‘é€é€šçŸ¥
send_task_notification(
    task_name="ç³»ç»Ÿå‡çº§",
    subtask_name="å‡çº§ç³»ç»Ÿåˆ°æœ€æ–°ç‰ˆæœ¬",
    planned_time="2024-12-01 18:00:00",
    detail_url=detail_url,
    accept_url=accept_url,
    reject_url=reject_url,
    employee_dingtalk_id="0109353429171130295"
)
```

### æ­¥éª¤3: å‘˜å·¥æ”¶åˆ°å¹¶å“åº”

**åœºæ™¯A - å‘˜å·¥æ¥å—ä»»åŠ¡**ï¼š
1. å¼ ä¸‰åœ¨é’‰é’‰æ”¶åˆ°æ¶ˆæ¯
2. ç‚¹å‡»"âˆš æ¥å—ä»»åŠ¡"
3. è‡ªåŠ¨è·³è½¬åˆ°æ¥å—ç¡®è®¤é¡µé¢
4. é¡µé¢æ˜¾ç¤º"ä»»åŠ¡å·²æ¥å—ï¼"
5. æ•°æ®åº“æ›´æ–°ï¼š
   ```
   status: 'accepted'
   responded_at: 2024-11-28 13:45:00
   ```

**åœºæ™¯B - å‘˜å·¥æ‹’ç»ä»»åŠ¡**ï¼š
1. å¼ ä¸‰åœ¨é’‰é’‰æ”¶åˆ°æ¶ˆæ¯
2. ç‚¹å‡»"Ã— æ‹’ç»ä»»åŠ¡"
3. è·³è½¬åˆ°æ‹’ç»ç†ç”±é¡µé¢
4. å¡«å†™ç†ç”±ï¼š"æ—¶é—´å†²çªï¼Œå½“å¤©æœ‰å…¶ä»–ç´§æ€¥ä»»åŠ¡"
5. ç‚¹å‡»"ç¡®è®¤æ‹’ç»"
6. é¡µé¢æ˜¾ç¤º"å·²æäº¤æ‹’ç»"
7. æ•°æ®åº“æ›´æ–°ï¼š
   ```
   status: 'rejected'
   reject_reason: 'æ—¶é—´å†²çªï¼Œå½“å¤©æœ‰å…¶ä»–ç´§æ€¥ä»»åŠ¡'
   responded_at: 2024-11-28 13:45:00
   ```

### æ­¥éª¤4: ç®¡ç†å‘˜æŸ¥çœ‹åé¦ˆ

1. ç®¡ç†å‘˜è¿›å…¥"åˆ†é…è®°å½•"æ ‡ç­¾
2. çœ‹åˆ°ä»»åŠ¡çŠ¶æ€ï¼š
   - âœ… å·²æ¥å—ï¼šæ˜¾ç¤ºç»¿è‰²æ ‡ç­¾
   - âŒ å·²æ‹’ç»ï¼šæ˜¾ç¤ºçº¢è‰²æ ‡ç­¾ï¼Œå¹¶æ˜¾ç¤ºæ‹’ç»ç†ç”±
3. å¦‚æœè¢«æ‹’ç»ï¼Œå¯ä»¥è€ƒè™‘ï¼š
   - é‡æ–°åˆ†é…ç»™å…¶ä»–å‘˜å·¥
   - è°ƒæ•´ä»»åŠ¡è¦æ±‚
   - ä¸å‘˜å·¥æ²Ÿé€šåè°ƒ

---

## ğŸ”§ é…ç½®è¯´æ˜

### é’‰é’‰æœºå™¨äººé…ç½®

æ–‡ä»¶ä½ç½®: `/root/workspace/xk/yayuan/simple_distribute/robot_message/robot.py`

å…³é”®é…ç½®ï¼š
```python
url = "https://api.dingtalk.com/v1.0/robot/oToMessages/batchSend"
headers = {
    "x-acs-dingtalk-access-token": "ä½ çš„access_token",
    "Content-Type": "application/json"
}

payload = {
    "robotCode": "ä½ çš„robotCode",
    "userIds": [employee_dingtalk_id],  # åŠ¨æ€ä¼ å…¥
    "msgKey": "sampleActionCard3",
    "msgParam": json.dumps({
        "title": "æ–°ä»»åŠ¡åˆ†é…",
        "text": text_content,
        "actionTitle1": "æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…",
        "actionURL1": detail_url,
        "actionTitle2": "âˆš æ¥å—ä»»åŠ¡",
        "actionURL2": accept_url,
        "actionTitle3": "Ã— æ‹’ç»ä»»åŠ¡",
        "actionURL3": reject_url
    })
}
```

### URLé…ç½®

æ‰€æœ‰URLéƒ½åœ¨ `app.py` çš„ `send_assignments` å‡½æ•°ä¸­åŠ¨æ€ç”Ÿæˆï¼š

```python
base_url = request.host_url.rstrip('/')  # è‡ªåŠ¨è·å–å½“å‰åŸŸå
detail_url = f"{base_url}/employee?id={assignment.id}"
accept_url = f"{base_url}/accept?id={assignment.id}"
reject_url = f"{base_url}/reject?id={assignment.id}"
```

å¦‚æœæœåŠ¡å™¨IPå˜æ›´ï¼ŒURLä¼šè‡ªåŠ¨é€‚é…ã€‚

---

## ğŸ“ APIæ¥å£æ–‡æ¡£

### 1. æ¥å—ä»»åŠ¡

```http
POST /api/assignments/{id}/accept
GET  /api/assignments/{id}/accept
```

**å“åº”**ï¼š
```json
{
    "message": "ä»»åŠ¡å·²æ¥å—",
    "assignment": {
        "id": 1,
        "status": "accepted",
        "respondedAt": "2024-11-28T13:45:00"
    }
}
```

### 2. æ‹’ç»ä»»åŠ¡

```http
POST /api/assignments/{id}/reject
Content-Type: application/json

{
    "reason": "æ‹’ç»ç†ç”±"
}
```

**å“åº”**ï¼š
```json
{
    "message": "ä»»åŠ¡å·²æ‹’ç»",
    "assignment": {
        "id": 1,
        "status": "rejected",
        "rejectReason": "æ‹’ç»ç†ç”±",
        "respondedAt": "2024-11-28T13:45:00"
    }
}
```

### 3. è·å–ä»»åŠ¡è¯¦æƒ…

```http
GET /api/assignments/{id}
```

**å“åº”**ï¼š
```json
{
    "id": 1,
    "taskName": "ç³»ç»Ÿå‡çº§",
    "taskDescription": "å‡çº§ç³»ç»Ÿåˆ°æœ€æ–°ç‰ˆæœ¬",
    "employeeName": "å¼ ä¸‰",
    "status": "pending",
    "assignedAt": "2024-11-28T13:30:00"
}
```

---

## ğŸ¯ æµ‹è¯•æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
cd /root/workspace/xk/yayuan/simple_distribute
source /root/anaconda3/etc/profile.d/conda.sh
conda activate xk
python test_dingtalk.py
```

### æ–¹æ³•2: é€šè¿‡ç®¡ç†å‘˜ç«¯

1. è®¿é—® http://101.37.168.176:8082
2. æ·»åŠ å‘˜å·¥å’Œä»»åŠ¡
3. è¿›è¡Œä»»åŠ¡åˆ†é…
4. æŸ¥çœ‹é’‰é’‰æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯

### æ–¹æ³•3: ç›´æ¥æµ‹è¯•URL

```bash
# æµ‹è¯•æ¥å—é¡µé¢
curl http://101.37.168.176:8082/accept?id=1

# æµ‹è¯•æ‹’ç»é¡µé¢
curl http://101.37.168.176:8082/reject?id=1
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: é’‰é’‰æ²¡æ”¶åˆ°æ¶ˆæ¯

æ£€æŸ¥ï¼š
1. access_token æ˜¯å¦æ­£ç¡®
2. robotCode æ˜¯å¦æ­£ç¡®
3. å‘˜å·¥é’‰é’‰IDæ˜¯å¦æ­£ç¡®
4. æƒé™ `qyapi_robot_sendmsg` æ˜¯å¦å·²å¼€é€š

æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
./manage.sh logs
```

### é—®é¢˜2: ç‚¹å‡»æŒ‰é’®æ²¡ååº”

æ£€æŸ¥ï¼š
1. URLæ˜¯å¦æ­£ç¡®ç”Ÿæˆ
2. æœåŠ¡å™¨IPå’Œç«¯å£æ˜¯å¦å¯è®¿é—®
3. é˜²ç«å¢™8082ç«¯å£æ˜¯å¦å¼€æ”¾

æµ‹è¯•URLï¼š
```bash
curl http://101.37.168.176:8082/accept?id=1
curl http://101.37.168.176:8082/reject?id=1
```

### é—®é¢˜3: æ‹’ç»ç†ç”±æœªä¿å­˜

æ£€æŸ¥ï¼š
1. æ•°æ®åº“æ˜¯å¦æ­£å¸¸
2. APIæ˜¯å¦æ­£ç¡®è°ƒç”¨
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

---

## ğŸ‰ æ€»ç»“

ç°åœ¨ç³»ç»Ÿå·²ç»å®Œæ•´å®ç°ï¼š

âœ… **ç®¡ç†å‘˜ç«¯åŠŸèƒ½**
- ä»»åŠ¡åº“ç®¡ç†
- å‘˜å·¥ç®¡ç†
- ä»»åŠ¡åˆ†é…
- æŸ¥çœ‹åˆ†é…è®°å½•å’Œæ‹’ç»ç†ç”±

âœ… **é’‰é’‰é›†æˆ**
- è‡ªåŠ¨å‘é€é€šçŸ¥
- ä¸‰ä¸ªäº¤äº’æŒ‰é’®
- åŠ¨æ€å‘˜å·¥ID

âœ… **å‘˜å·¥ç«¯åŠŸèƒ½**
- æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
- ä¸€é”®æ¥å—ä»»åŠ¡
- å¡«å†™æ‹’ç»ç†ç”±

âœ… **æ•°æ®é—­ç¯**
- æ‰€æœ‰æ“ä½œéƒ½è®°å½•åˆ°æ•°æ®åº“
- ç®¡ç†å‘˜å¯æŸ¥çœ‹æ‰€æœ‰åé¦ˆ
- çŠ¶æ€å®æ—¶æ›´æ–°

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2024-11-28  
**è®¿é—®åœ°å€**: http://101.37.168.176:8082

