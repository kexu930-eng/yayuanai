<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡åˆ†é…ç³»ç»Ÿ - ç®¡ç†å‘˜ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .tab:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .panel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .task-list,
        .employee-list {
            margin-top: 30px;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .list-header h3 {
            color: #333;
            font-size: 20px;
        }

        .count-badge {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .item-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .item-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .item-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .item-desc {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 10px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 16px;
        }

        .distribute-section {
            margin-bottom: 30px;
        }

        .distribute-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .distribute-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            margin-bottom: 15px;
            align-items: end;
        }

        .assignment-preview {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed #667eea;
        }

        .assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .assignment-item:last-child {
            margin-bottom: 0;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-accepted {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-completed {
            background: #bbf7d0;
            color: #166534;
        }

        .record-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .record-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .record-time {
            color: #999;
            font-size: 13px;
        }

        .record-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .record-field {
            font-size: 14px;
        }

        .record-field strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .reject-reason {
            background: #fee2e2;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ef4444;
        }

        .reject-reason strong {
            color: #991b1b;
            display: block;
            margin-bottom: 8px;
        }

        .reject-reason p {
            color: #7f1d1d;
            font-size: 14px;
            line-height: 1.6;
        }

        .notification-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 0 5px;
        }

        .notification-success {
            background: #d1fae5;
            color: #065f46;
        }

        .notification-failed {
            background: #fee2e2;
            color: #991b1b;
            cursor: help;
        }

        .notification-unknown {
            background: #fef3c7;
            color: #92400e;
        }

        .notification-error {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #f59e0b;
        }

        .notification-error strong {
            color: #92400e;
            display: block;
            margin-bottom: 8px;
        }

        .notification-error p {
            color: #78350f;
            font-size: 13px;
            line-height: 1.6;
        }

        .employee-card {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .employee-card:hover {
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .employee-id {
            font-size: 13px;
            color: #999;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
            display: none;
        }

        .success-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2,
            .distribute-row {
                grid-template-columns: 1fr;
            }
        }
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .login-tip {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .login-btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn-primary {
            background: linear-gradient(135deg, #00b96b 0%, #00a854 100%);
            color: white;
        }

        .login-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 185, 107, 0.4);
        }

        .login-btn-secondary {
            background: #667eea;
            color: white;
        }

        .login-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .login-divider {
            text-align: center;
            margin: 15px 0;
            color: #999;
            font-size: 14px;
        }

        .login-error {
            color: #ff4d4f;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            min-height: 20px;
        }

        .login-success {
            color: #00b96b;
        }

        .admin-container {
            display: none;
        }

        .admin-container.show {
            display: block;
        }

        /* æŠ€èƒ½ç –å—æ ·å¼ */
        .skill-brick {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
            user-select: none;
        }

        .skill-brick:hover {
            background: #bbdefb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
        }

        .skill-brick.selected {
            background: #1976d2;
            color: white;
            border-color: #0d47a1;
        }

        .skill-brick .delete-btn {
            margin-left: 8px;
            cursor: pointer;
            opacity: 0.7;
            font-weight: bold;
        }

        .skill-brick .delete-btn:hover {
            opacity: 1;
            color: #d32f2f;
        }

        .skill-brick.selected .close-icon {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: #d32f2f;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .skill-brick.selected .close-icon:hover {
            background: #c62828;
        }

        /* å‘˜å·¥æŠ€èƒ½è¡Œæ ·å¼ */
        .employee-skill-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .employee-skill-row select {
            flex: 1;
            min-width: 150px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .employee-skill-row .rating-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .employee-skill-row .rating-slider {
            flex: 1;
            min-width: 100px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 3px;
            outline: none;
        }

        .employee-skill-row .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #1976d2;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(25, 118, 210, 0.4);
        }

        .employee-skill-row .rating-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #1976d2;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .employee-skill-row .rating-value {
            min-width: 40px;
            padding: 5px 10px;
            background: #1976d2;
            color: white;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .employee-skill-row .remove-skill-btn {
            padding: 6px 12px;
            background: #ff4d4f;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .employee-skill-row .remove-skill-btn:hover {
            background: #d32f2f;
        }

        /* ä»»åŠ¡åˆ†é…ä¸­çš„æŠ€èƒ½æ˜¾ç¤º */
        .skill-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 8px;
            min-height: 40px;
        }

        .skill-display .skill-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .skill-display .skill-tag.task-skill {
            background: #fff3e0;
            color: #e65100;
        }

        .skill-display .skill-tag.employee-skill {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .skill-display .skill-tag .rating {
            margin-left: 5px;
            padding: 2px 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
    
    <!-- å¼•å…¥é’‰é’‰ JSAPI -->
    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.10.3/dingtalk.open.js"></script>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page" class="login-page">
        <div class="login-container">
            <h1 class="login-title">ğŸ” ç®¡ç†å‘˜ç™»å½•</h1>
            <div class="login-tip" id="login-tip">è¯·é€‰æ‹©ç™»å½•æ–¹å¼</div>
            <div class="login-btn-group" id="login-buttons">
                <!-- åŠ¨æ€ç”Ÿæˆç™»å½•æŒ‰é’® -->
            </div>
            <div class="login-error" id="login-error"></div>
        </div>
    </div>

    <!-- ç®¡ç†ç•Œé¢ -->
    <div class="admin-container" id="admin-container">
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ ä»»åŠ¡åˆ†é…ç³»ç»Ÿ</h1>
            <p>ç®¡ç†å‘˜æ§åˆ¶å° - è½»æ¾ç®¡ç†ä»»åŠ¡ä¸å‘˜å·¥</p>
            <div id="admin-info" style="margin-top: 15px; display: none;">
                <div style="display: inline-flex; align-items: center; background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 25px;">
                    <span style="font-size: 20px; margin-right: 8px;">ğŸ‘¤</span>
                    <span style="font-weight: 600;">å½“å‰ç®¡ç†å‘˜ï¼š</span>
                    <span id="admin-name" style="margin-left: 5px; font-weight: 700;"></span>
                    <button onclick="logout()" style="margin-left: 15px; background: rgba(255,255,255,0.3); border: none; color: white; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 13px;">é€€å‡º</button>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('skills')">
                ğŸ¯ æŠ€èƒ½æ± æ„å»º
            </button>
            <button class="tab" onclick="switchTab('tasks')">
                ğŸ“ ä»»åŠ¡åº“ç®¡ç†
            </button>
            <button class="tab" onclick="switchTab('employees')">
                ğŸ‘¥ å‘˜å·¥ç®¡ç†
            </button>
            <button class="tab" onclick="switchTab('distribute')">
                ğŸš€ ä»»åŠ¡åˆ†é…
            </button>
            <button class="tab" onclick="switchTab('records')">
                ğŸ“Š åˆ†é…è®°å½•
            </button>
        </div>

        <!-- æŠ€èƒ½æ± ç®¡ç†é¢æ¿ -->
        <div id="skills-panel" class="panel active">
            <h2 style="margin-bottom: 20px; color: #333;">â• æ·»åŠ æ–°æŠ€èƒ½</h2>
            
            <div id="skill-success" class="success-message"></div>
            
            <form id="skill-form">
                <div class="form-group">
                    <label>æŠ€èƒ½åç§° *</label>
                    <input type="text" id="skill-name" placeholder="ä¾‹å¦‚ï¼šPythonç¼–ç¨‹ã€æ•°æ®åˆ†æã€é¡¹ç›®ç®¡ç†..." required>
                    <small style="color: #666; display: block; margin-top: 8px;">
                        ğŸ’¡ æ‚¨éƒ¨é—¨çš„ä»»åŠ¡å¯¹å‘˜å·¥å®Œæˆæ—¶éœ€è¦çš„æŠ€èƒ½ï¼Œæ³¨æ„éœ€è¦å’Œå‘˜å·¥åº“çš„æŠ€èƒ½é¢—ç²’åº¦ä¸€è‡´
                    </small>
                </div>
                
                <button type="submit" class="btn">
                    âœ… æ·»åŠ åˆ°æŠ€èƒ½æ± 
                </button>
            </form>

            <div class="task-list">
                <div class="list-header">
                    <h3>æŠ€èƒ½æ± </h3>
                    <span class="count-badge" id="skill-count">0 ä¸ªæŠ€èƒ½</span>
                </div>
                <div id="skills-container" style="padding: 15px; display: flex; flex-wrap: wrap; gap: 10px; min-height: 100px;">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <p>æš‚æ— æŠ€èƒ½ï¼Œè¯·æ·»åŠ æŠ€èƒ½</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡åº“ç®¡ç†é¢æ¿ -->
        <div id="tasks-panel" class="panel">
            <h2 id="task-form-title" style="margin-bottom: 20px; color: #333;">â• æ·»åŠ æ–°ä»»åŠ¡</h2>
            
            <div id="task-success" class="success-message"></div>
            
            <form id="task-form">
                <div class="grid-2">
                    <div class="form-group">
                        <label>ä»»åŠ¡åç§° *</label>
                        <input type="text" id="task-name" placeholder="ä¾‹å¦‚ï¼šç³»ç»Ÿå‡çº§ä»»åŠ¡" required>
                    </div>
                    <div class="form-group">
                        <label>é¢„è®¡å®Œæˆæ—¶é—´</label>
                        <input type="datetime-local" id="task-deadline">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ä»»åŠ¡æè¿° *</label>
                    <textarea id="task-desc" placeholder="è¯¦ç»†æè¿°ä»»åŠ¡å†…å®¹ã€è¦æ±‚å’Œæ³¨æ„äº‹é¡¹..." required></textarea>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>é¢„è®¡è€—æ—¶ï¼ˆå°æ—¶ï¼‰ *</label>
                        <input type="number" id="task-estimated-hours" placeholder="ä¾‹å¦‚ï¼š8" min="0.5" step="0.5" required>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ğŸ’¡ å®Œæˆæ­¤ä»»åŠ¡é¢„è®¡éœ€è¦çš„å·¥æ—¶
                        </small>
                    </div>
                    <div class="form-group">
                        <label>é‡è¦ç¨‹åº¦ *</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="task-importance" min="1" max="10" value="5" 
                                   style="flex: 1; height: 8px;" oninput="updateImportanceDisplay(this.value)">
                            <span id="importance-value" style="min-width: 50px; padding: 8px 15px; background: #667eea; color: white; border-radius: 8px; text-align: center; font-weight: 600;">5</span>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ğŸ’¡ 1åˆ†æœ€ä½ï¼Œ10åˆ†æœ€é«˜
                        </small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>é‡è¦åº¦è¯´æ˜</label>
                    <textarea id="task-importance-note" placeholder="ï¼ˆé€‰å¡«ï¼‰è¯´æ˜ä¸ºä»€ä¹ˆè¿™ä¸ªä»»åŠ¡å…·æœ‰æ­¤é‡è¦ç¨‹åº¦..." style="min-height: 60px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>æ‰€éœ€æŠ€èƒ½ * <span style="color: #ef4444; font-weight: normal; font-size: 12px;">ï¼ˆå¿…é€‰ï¼‰</span></label>
                    <div id="task-skills-selector" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; min-height: 80px; transition: all 0.3s;">
                        <!-- åŠ¨æ€åŠ è½½æŠ€èƒ½ç –å— -->
                    </div>
                    <input type="hidden" id="selected-skills" value="">
                    <small style="color: #666; display: block; margin-top: 8px;">
                        ğŸ’¡ ç‚¹å‡»æŠ€èƒ½ç –å—è¿›è¡Œé€‰æ‹©ï¼Œå†æ¬¡ç‚¹å‡»å–æ¶ˆé€‰æ‹©ã€‚<span style="color: #ef4444;">å¿…é¡»è‡³å°‘é€‰æ‹©ä¸€ä¸ªæŠ€èƒ½</span>
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" id="task-submit-btn" class="btn">
                        âœ… æ·»åŠ åˆ°ä»»åŠ¡åº“
                    </button>
                    <button type="button" id="task-cancel-btn" class="btn" style="background: #6b7280; display: none;" onclick="resetTaskForm()">
                        âŒ å–æ¶ˆç¼–è¾‘
                    </button>
                </div>
            </form>
            
            <style>
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            </style>

            <div class="task-list">
                <div class="list-header">
                    <h3>ä»»åŠ¡åº“</h3>
                    <span class="count-badge" id="task-count">0 ä¸ªä»»åŠ¡</span>
                </div>
                <div id="tasks-container">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>æš‚æ— ä»»åŠ¡ï¼Œè¯·æ·»åŠ æ–°ä»»åŠ¡</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å‘˜å·¥ç®¡ç†é¢æ¿ -->
        <div id="employees-panel" class="panel">
            <h2 id="employee-form-title" style="margin-bottom: 20px; color: #333;">â• æ·»åŠ å‘˜å·¥</h2>
            
            <div id="employee-success" class="success-message"></div>
            
            <form id="employee-form">
                <div class="grid-2">
                    <div class="form-group">
                        <label>å‘˜å·¥å§“å *</label>
                        <input type="text" id="employee-name" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰" required>
                    </div>
                    <div class="form-group">
                        <label>é’‰é’‰ç”¨æˆ·ID *</label>
                        <input type="text" id="employee-dingtalk-id" placeholder="ä¾‹å¦‚ï¼š0109353429171130295" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å‘˜å·¥æŠ€èƒ½</label>
                    <div id="employee-skills-container">
                        <!-- åŠ¨æ€æ·»åŠ æŠ€èƒ½è¡Œ -->
                    </div>
                    <button type="button" class="btn" style="background: #00b96b; margin-top: 10px;" onclick="addEmployeeSkillRow()">
                        â• æ·»åŠ æŠ€èƒ½
                    </button>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ğŸ’¡ é€‰æ‹©æŠ€èƒ½å¹¶è®¾ç½®è¯„åˆ†ï¼ˆ1-10åˆ†ï¼‰
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" id="employee-submit-btn" class="btn">
                        âœ… æ·»åŠ å‘˜å·¥
                    </button>
                    <button type="button" id="employee-cancel-btn" class="btn" style="background: #6b7280; display: none;" onclick="resetEmployeeForm()">
                        âŒ å–æ¶ˆç¼–è¾‘
                    </button>
                </div>
            </form>

            <div class="employee-list">
                <div class="list-header">
                    <h3>å‘˜å·¥åˆ—è¡¨</h3>
                    <span class="count-badge" id="employee-count">0 åå‘˜å·¥</span>
                </div>
                <div id="employees-container">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p>æš‚æ— å‘˜å·¥ï¼Œè¯·æ·»åŠ å‘˜å·¥ä¿¡æ¯</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ†é…é¢æ¿ -->
        <div id="distribute-panel" class="panel">
            <div id="distribute-success" class="success-message"></div>
            
            <!-- ä»»åŠ¡çŠ¶æ€æ¦‚è§ˆ -->
            <div class="distribute-section">
                <h3>ğŸ“Š ä»»åŠ¡çŠ¶æ€æ¦‚è§ˆ</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 28px; font-weight: bold; color: #3b82f6;" id="unassigned-count">0</div>
                        <div style="color: #666; font-size: 14px;">æœªåˆ†é…ä»»åŠ¡</div>
                    </div>
                    <div style="background: #fef3c7; padding: 20px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 28px; font-weight: bold; color: #f59e0b;" id="pending-count">0</div>
                        <div style="color: #666; font-size: 14px;">å¾…å¤„ç†ä»»åŠ¡</div>
                    </div>
                    <div style="background: #d1fae5; padding: 20px; border-radius: 10px; border-left: 4px solid #10b981;">
                        <div style="font-size: 28px; font-weight: bold; color: #10b981;" id="accepted-count">0</div>
                        <div style="color: #666; font-size: 14px;">å·²æ¥å—ä»»åŠ¡</div>
                    </div>
                    <div style="background: #fee2e2; padding: 20px; border-radius: 10px; border-left: 4px solid #ef4444;">
                        <div style="font-size: 28px; font-weight: bold; color: #ef4444;" id="rejected-count">0</div>
                        <div style="color: #666; font-size: 14px;">å·²æ‹’ç»ä»»åŠ¡</div>
                    </div>
                </div>

                <!-- ä»»åŠ¡è¯¦ç»†åˆ—è¡¨ -->
                <div id="task-status-list" style="margin-bottom: 30px;"></div>
            </div>
            
            <div class="distribute-section">
                <h3>ğŸ“Œ é…ç½®ä»»åŠ¡åˆ†é…</h3>
                <p style="color: #666; margin-bottom: 20px;">é€‰æ‹©ä»»åŠ¡å’Œå¯¹åº”çš„å‘˜å·¥ï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªåˆ†é…</p>
                
                <div id="distribute-rows">
                    <div class="distribute-row" data-row-id="0">
                        <div class="form-group" style="margin-bottom: 0; flex: 1;">
                            <label>é€‰æ‹©ä»»åŠ¡</label>
                            <select class="task-select" onchange="onTaskSelectChange(this)" required>
                                <option value="">è¯·é€‰æ‹©ä»»åŠ¡</option>
                            </select>
                            <div class="skill-display task-skills-display" style="display: none;">
                                <span style="color: #e65100; font-size: 12px; margin-right: 5px;">ğŸ“‹ ä»»åŠ¡æ‰€éœ€æŠ€èƒ½:</span>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex: 1;">
                            <label>é€‰æ‹©å‘˜å·¥</label>
                            <select class="employee-select" onchange="onEmployeeSelectChange(this)" required>
                                <option value="">è¯·é€‰æ‹©å‘˜å·¥</option>
                            </select>
                            <div class="skill-display employee-skills-display" style="display: none;">
                                <span style="color: #2e7d32; font-size: 12px; margin-right: 5px;">ğŸ§‘â€ğŸ’¼ å‘˜å·¥æŠ€èƒ½:</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-small" onclick="addDistributeRow()">
                            â• æ·»åŠ æ›´å¤š
                        </button>
                    </div>
                </div>

                <div class="assignment-preview" id="preview-section" style="display: none;">
                    <h4 style="margin-bottom: 15px; color: #333;">ğŸ“‹ é¢„è§ˆå¾…å‘é€çš„åˆ†é…</h4>
                    <div id="preview-list"></div>
                    <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="sendAssignments()">
                        ğŸš€ ç¡®è®¤å‘é€é’‰é’‰é€šçŸ¥
                    </button>
                </div>
            </div>
            
            <!-- æ™ºèƒ½è‡ªåŠ¨åˆ†é…åŒºåŸŸï¼ˆæ”¾åœ¨æœ€ä¸‹é¢ï¼‰ -->
            <div class="distribute-section" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 25px; border-radius: 12px; margin-top: 30px; border: 2px solid #667eea30;">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ¤– æ™ºèƒ½è‡ªåŠ¨åˆ†é…</h3>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                    åŸºäºä»»åŠ¡é‡è¦æ€§ã€æŠ€èƒ½åŒ¹é…åº¦ã€å‘˜å·¥è´Ÿè½½ç­‰å› ç´ ï¼Œæ™ºèƒ½æ¨èæœ€ä½³åˆ†é…æ–¹æ¡ˆ
                </p>
                
                <!-- å‚æ•°é…ç½® -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 13px;">æŠ€èƒ½åŒ¹é…é˜ˆå€¼</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="skill-match-threshold" min="50" max="100" value="80" 
                                   style="flex: 1;" oninput="document.getElementById('skill-threshold-value').textContent = this.value + '%'">
                            <span id="skill-threshold-value" style="min-width: 45px; padding: 5px 10px; background: #667eea; color: white; border-radius: 6px; text-align: center; font-size: 13px;">80%</span>
                        </div>
                        <small style="color: #999; font-size: 11px;">å‘˜å·¥æŠ€èƒ½è¦†ç›–ä»»åŠ¡æ‰€éœ€æŠ€èƒ½çš„æ¯”ä¾‹</small>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 13px;">è´Ÿè½½é˜ˆå€¼</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="workload-threshold" min="50" max="100" value="85" 
                                   style="flex: 1;" oninput="document.getElementById('workload-threshold-value').textContent = this.value + '%'">
                            <span id="workload-threshold-value" style="min-width: 45px; padding: 5px 10px; background: #f59e0b; color: white; border-radius: 6px; text-align: center; font-size: 13px;">85%</span>
                        </div>
                        <small style="color: #999; font-size: 11px;">æ’é™¤è´Ÿè½½è¶…è¿‡æ­¤é˜ˆå€¼çš„å‘˜å·¥</small>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 13px;">è´Ÿè½½å¹³è¡¡</label>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="checkbox" id="enable-balance" checked style="width: 20px; height: 20px; cursor: pointer;">
                            <span style="color: #666; font-size: 13px;">å¯ç”¨è´Ÿè½½å‡è¡¡æ£€æµ‹</span>
                        </div>
                        <small style="color: #999; font-size: 11px;">é¿å…ä¸ªåˆ«å‘˜å·¥è´Ÿæ‹…è¿‡é‡</small>
                    </div>
                </div>
                
                <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%;" onclick="runAutoAssign()">
                    ğŸš€ è¿è¡Œè‡ªåŠ¨åˆ†é…ç®—æ³•
                </button>
            </div>
            
            <!-- è‡ªåŠ¨åˆ†é…ç»“æœå±•ç¤º -->
            <div id="auto-assign-result" style="display: none; margin-top: 30px;">
                <div class="distribute-section" style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #10b981; margin: 0;">ğŸ“‹ è‡ªåŠ¨åˆ†é…ç»“æœé¢„è§ˆ</h3>
                        <div>
                            <button class="btn btn-small" style="background: #ef4444; margin-right: 10px;" onclick="clearAutoAssignResult()">
                                âŒ å–æ¶ˆ
                            </button>
                            <button class="btn btn-small btn-success" onclick="confirmAutoAssign()">
                                âœ… ç¡®è®¤å¹¶å‘é€é€šçŸ¥
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div id="auto-assign-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    </div>
                    
                    <!-- å‘˜å·¥è´Ÿè½½å˜åŒ–é¢„è§ˆ -->
                    <div id="employee-workload-preview" style="margin-bottom: 25px; padding: 20px; background: white; border-radius: 10px; border: 1px solid #e0e0e0;">
                        <h4 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">ğŸ“Š</span> å‘˜å·¥è´Ÿè½½å˜åŒ–é¢„è§ˆ
                        </h4>
                        <div id="workload-change-list" style="display: grid; gap: 12px;">
                        </div>
                    </div>
                    
                    <!-- ä»»åŠ¡å»¶æœŸé£é™©é¢„è­¦ -->
                    <div id="task-delay-warning" style="display: none; margin-bottom: 25px; padding: 20px; background: #fff7ed; border-radius: 10px; border: 1px solid #fed7aa;">
                        <h4 style="color: #c2410c; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">â°</span> ä»»åŠ¡å»¶æœŸé£é™©é¢„è­¦
                        </h4>
                        <div id="delay-risk-list" style="display: grid; gap: 10px;">
                        </div>
                    </div>
                    
                    <!-- åˆ†é…è¯¦æƒ…åˆ—è¡¨ -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">ğŸ“</span> åˆ†é…è¯¦æƒ…
                        </h4>
                        <div id="auto-assign-list">
                        </div>
                    </div>
                    
                    <!-- æœªåˆ†é…ä»»åŠ¡ -->
                    <div id="auto-assign-unassigned" style="display: none; margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">âš ï¸ æœªèƒ½è‡ªåŠ¨åˆ†é…çš„ä»»åŠ¡</h4>
                        <div id="unassigned-list"></div>
                    </div>
                    
                    <!-- è´Ÿè½½å¹³è¡¡æç¤º -->
                    <div id="balance-warning" style="display: none; margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">âš–ï¸ è´Ÿè½½å¹³è¡¡æç¤º</h4>
                        <p id="balance-message" style="color: #78350f; font-size: 14px;"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†é…è®°å½•é¢æ¿ -->
        <div id="records-panel" class="panel">
            <div class="list-header">
                <h3>ğŸ“Š ä»»åŠ¡åˆ†é…è®°å½•</h3>
                <span class="count-badge" id="record-count">0 æ¡è®°å½•</span>
            </div>
            
            <div id="records-container">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <p>æš‚æ— åˆ†é…è®°å½•</p>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let tasks = [];
        let employees = [];
        let assignments = [];
        let skills = [];

        // APIåŸºç¡€è·¯å¾„
        const API_BASE = '/api';

        // ç™»å½•çŠ¶æ€å’Œé’‰é’‰é…ç½®
        let isLoggedIn = false;
        let currentAdmin = null;
        let dingtalkConfig = null;
        let isDingTalkEnv = false;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initLoginPage();
        };

        // åˆå§‹åŒ–ç™»å½•é¡µé¢
        async function initLoginPage() {
            // æ£€æµ‹é’‰é’‰ç¯å¢ƒ
            isDingTalkEnv = typeof dd !== 'undefined' && dd.env && dd.env.platform !== 'notInDingTalk';
            
            const loginTip = document.getElementById('login-tip');
            const loginButtons = document.getElementById('login-buttons');
            
            if (isDingTalkEnv) {
                loginTip.textContent = 'ğŸ’¡ æ¨èä½¿ç”¨é’‰é’‰å…å¯†ç™»å½•';
                
                // åœ¨é’‰é’‰ç¯å¢ƒä¸­ï¼Œæ˜¾ç¤ºå…å¯†ç™»å½•æŒ‰é’®
                loginButtons.innerHTML = `
                    <button class="login-btn login-btn-primary" onclick="handleDingTalkLogin()">
                        ğŸ” é’‰é’‰å…å¯†ç™»å½•
                    </button>
                    <div class="login-divider">æˆ–</div>
                    <button class="login-btn login-btn-secondary" onclick="handleManualLogin()">
                        ğŸ”‘ ç®¡ç†å‘˜å¯†ç ç™»å½•ï¼ˆå¼€å‘ä¸­ï¼‰
                    </button>
                `;
                
                // åŠ è½½é’‰é’‰é…ç½®
                await loadDingTalkConfig();
            } else {
                loginTip.textContent = 'ğŸ’¡ è¯·åœ¨é’‰é’‰å®¢æˆ·ç«¯ä¸­æ‰“å¼€ä½¿ç”¨å…å¯†ç™»å½•';
                
                // ä¸åœ¨é’‰é’‰ç¯å¢ƒä¸­
                loginButtons.innerHTML = `
                    <button class="login-btn login-btn-secondary" onclick="handleManualLogin()">
                        ğŸ”‘ ç®¡ç†å‘˜å¯†ç ç™»å½•ï¼ˆå¼€å‘ä¸­ï¼‰
                    </button>
                    <div style="margin-top: 15px; font-size: 12px; color: #999; text-align: center;">
                        æˆ–åœ¨é’‰é’‰å®¢æˆ·ç«¯ä¸­æ‰“å¼€ä»¥ä½¿ç”¨å…å¯†ç™»å½•
                    </div>
                `;
            }
        }

        // åŠ è½½é’‰é’‰é…ç½®
        async function loadDingTalkConfig() {
            try {
                const response = await fetch(`${API_BASE}/dingtalk/config?type=admin`);
                dingtalkConfig = await response.json();
                console.log('é’‰é’‰é…ç½®åŠ è½½æˆåŠŸ:', dingtalkConfig);
            } catch (error) {
                console.error('åŠ è½½é’‰é’‰é…ç½®å¤±è´¥:', error);
                showLoginError('é…ç½®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // å¤„ç†é’‰é’‰å…å¯†ç™»å½•
        async function handleDingTalkLogin() {
            const errorDiv = document.getElementById('login-error');
            
            if (!isDingTalkEnv) {
                showLoginError('è¯·åœ¨é’‰é’‰å®¢æˆ·ç«¯ä¸­æ‰“å¼€');
                return;
            }
            
            if (!dingtalkConfig) {
                showLoginError('é’‰é’‰é…ç½®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            try {
                errorDiv.textContent = 'æ­£åœ¨ç™»å½•...';
                errorDiv.className = 'login-error login-success';
                
                // 1. è·å–æˆæƒç 
                console.log('å¼€å§‹è·å–æˆæƒç ...');
                const authCode = await getDingTalkAuthCode();
                console.log('æˆæƒç è·å–æˆåŠŸ:', authCode);
                
                // 2. å‘é€åˆ°åç«¯è¿›è¡Œç™»å½•
                const response = await fetch(`${API_BASE}/dingtalk/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        authCode: authCode,
                        type: 'admin'
                    })
                });
                
                const result = await response.json();
                console.log('ç™»å½•ç»“æœ:', result);
                
                if (result.success) {
                    // ç™»å½•æˆåŠŸ
                    currentAdmin = result.data;
                    isLoggedIn = true;
                    showAdminPanel();
                } else {
                    showLoginError(result.message || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('é’‰é’‰ç™»å½•å¤±è´¥:', error);
                showLoginError('ç™»å½•å¤±è´¥: ' + error.message);
            }
        }

        // è·å–é’‰é’‰æˆæƒç 
        function getDingTalkAuthCode() {
            return new Promise((resolve, reject) => {
                dd.runtime.permission.requestAuthCode({
                    corpId: dingtalkConfig.corpId,
                    onSuccess: function(result) {
                        resolve(result.code);
                    },
                    onFail: function(err) {
                        reject(new Error('è·å–æˆæƒç å¤±è´¥: ' + JSON.stringify(err)));
                    }
                });
            });
        }

        // å¤„ç†æ‰‹åŠ¨ç™»å½•ï¼ˆæš‚æœªå®ç°ï¼‰
        function handleManualLogin() {
            showLoginError('ç®¡ç†å‘˜å¯†ç ç™»å½•åŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·ä½¿ç”¨é’‰é’‰å…å¯†ç™»å½•');
        }

        // æ˜¾ç¤ºç™»å½•é”™è¯¯
        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.className = 'login-error';
        }

        // æ˜¾ç¤ºç®¡ç†é¢æ¿
        function showAdminPanel() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('admin-container').classList.add('show');
            
            console.log('å½“å‰ç®¡ç†å‘˜ä¿¡æ¯:', currentAdmin);
            
            // æ˜¾ç¤ºç®¡ç†å‘˜ä¿¡æ¯
            if (currentAdmin && currentAdmin.name) {
                document.getElementById('admin-name').textContent = currentAdmin.name;
                document.getElementById('admin-info').style.display = 'block';
            }
            
            loadDataFromServer();
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®è®¤é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                currentAdmin = null;
                isLoggedIn = false;
                document.getElementById('admin-container').classList.remove('show');
                document.getElementById('admin-info').style.display = 'none';
                document.getElementById('login-page').style.display = 'flex';
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°é¢æ¿æ˜¾ç¤º
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(tabName + '-panel').classList.add('active');
            
            // å¦‚æœåˆ‡æ¢åˆ°åˆ†é…é¢æ¿ï¼Œæ›´æ–°é€‰æ‹©å™¨å’Œä»»åŠ¡çŠ¶æ€
            if (tabName === 'distribute') {
                updateDistributeSelects();
                updateTaskStatus();
            }
        }

        // ä»»åŠ¡è¡¨å•æäº¤
        // å½“å‰ç¼–è¾‘çš„ä»»åŠ¡IDï¼ˆnullè¡¨ç¤ºæ–°å»ºï¼‰
        let editingTaskId = null;
        
        document.getElementById('task-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // ä»éšè—å­—æ®µè·å–é€‰ä¸­çš„æŠ€èƒ½
            const selectedSkillsInput = document.getElementById('selected-skills');
            const selectedSkills = selectedSkillsInput.value ? 
                selectedSkillsInput.value.split(',').map(id => parseInt(id)).filter(id => !isNaN(id)) : [];
            
            // éªŒè¯ï¼šå¿…é¡»é€‰æ‹©è‡³å°‘ä¸€ä¸ªæŠ€èƒ½
            if (selectedSkills.length === 0) {
                alert('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ‰€éœ€æŠ€èƒ½ï¼\n\nä»»åŠ¡å¿…é¡»å…³è”æŠ€èƒ½ï¼Œä»¥ä¾¿è¿›è¡Œå‘˜å·¥åŒ¹é…ã€‚');
                // é«˜äº®æŠ€èƒ½é€‰æ‹©åŒºåŸŸ
                const skillSelector = document.getElementById('task-skills-selector');
                skillSelector.style.border = '2px solid #ef4444';
                skillSelector.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    skillSelector.style.border = '';
                    skillSelector.style.animation = '';
                }, 2000);
                return;
            }
            
            const task = {
                name: document.getElementById('task-name').value,
                description: document.getElementById('task-desc').value,
                deadline: document.getElementById('task-deadline').value,
                estimated_hours: parseFloat(document.getElementById('task-estimated-hours').value) || null,
                importance: parseInt(document.getElementById('task-importance').value) || 5,
                importance_note: document.getElementById('task-importance-note').value || null,
                skill_ids: selectedSkills
            };
            
            console.log(editingTaskId ? 'æ›´æ–°ä»»åŠ¡' : 'åˆ›å»ºä»»åŠ¡', 'é€‰ä¸­çš„æŠ€èƒ½:', selectedSkills);
            
            try {
                let response;
                if (editingTaskId) {
                    // æ›´æ–°ä»»åŠ¡
                    response = await fetch(`${API_BASE}/tasks/${editingTaskId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(task)
                    });
                } else {
                    // åˆ›å»ºä»»åŠ¡
                    response = await fetch(`${API_BASE}/tasks`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(task)
                    });
                }
                
                if (response.ok) {
                    await loadDataFromServer();
                    showSuccess('task-success', editingTaskId ? 'âœ… ä»»åŠ¡æ›´æ–°æˆåŠŸï¼' : 'âœ… ä»»åŠ¡æ·»åŠ æˆåŠŸï¼');
                    resetTaskForm();
                } else {
                    alert('âŒ æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
            }
        });
        
        // é‡ç½®ä»»åŠ¡è¡¨å•
        function resetTaskForm() {
            document.getElementById('task-form').reset();
            document.getElementById('selected-skills').value = '';
            document.getElementById('task-importance').value = 5;
            updateImportanceDisplay(5);
            updateTaskSkillSelector();
            editingTaskId = null;
            document.getElementById('task-form-title').textContent = 'â• æ·»åŠ æ–°ä»»åŠ¡';
            document.getElementById('task-submit-btn').textContent = 'âœ… æ·»åŠ åˆ°ä»»åŠ¡åº“';
            document.getElementById('task-cancel-btn').style.display = 'none';
        }
        
        // ç¼–è¾‘ä»»åŠ¡
        async function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            editingTaskId = taskId;
            
            // å¡«å……è¡¨å•
            document.getElementById('task-name').value = task.name || '';
            document.getElementById('task-desc').value = task.description || '';
            document.getElementById('task-deadline').value = task.deadline || '';
            document.getElementById('task-estimated-hours').value = task.estimated_hours || '';
            document.getElementById('task-importance').value = task.importance || 5;
            updateImportanceDisplay(task.importance || 5);
            document.getElementById('task-importance-note').value = task.importance_note || '';
            
            // è®¾ç½®é€‰ä¸­çš„æŠ€èƒ½
            const skillIds = task.skills ? task.skills.map(s => s.id) : [];
            document.getElementById('selected-skills').value = skillIds.join(',');
            updateTaskSkillSelector();
            
            // æ›´æ–°è¡¨å•æ ‡é¢˜å’ŒæŒ‰é’®
            document.getElementById('task-form-title').textContent = 'âœï¸ ç¼–è¾‘ä»»åŠ¡';
            document.getElementById('task-submit-btn').textContent = 'âœ… ä¿å­˜ä¿®æ”¹';
            document.getElementById('task-cancel-btn').style.display = 'inline-block';
            
            // æ»šåŠ¨åˆ°è¡¨å•
            document.getElementById('task-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // æ›´æ–°é‡è¦ç¨‹åº¦æ˜¾ç¤º
        function updateImportanceDisplay(value) {
            const display = document.getElementById('importance-value');
            if (display) {
                display.textContent = value;
                // æ ¹æ®åˆ†æ•°æ”¹å˜é¢œè‰²
                if (value >= 8) {
                    display.style.background = '#ef4444';  // çº¢è‰² - éå¸¸é‡è¦
                } else if (value >= 6) {
                    display.style.background = '#f59e0b';  // æ©™è‰² - æ¯”è¾ƒé‡è¦
                } else if (value >= 4) {
                    display.style.background = '#667eea';  // è“è‰² - ä¸€èˆ¬
                } else {
                    display.style.background = '#10b981';  // ç»¿è‰² - ä¸å¤ªé‡è¦
                }
            }
        }

        // æŠ€èƒ½è¡¨å•æäº¤
        document.getElementById('skill-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const skill = {
                name: document.getElementById('skill-name').value,
                manager_dingtalk_id: currentAdmin ? currentAdmin.userid : null  // å…³è”å½“å‰ç®¡ç†å‘˜
            };
            
            console.log('æ·»åŠ æŠ€èƒ½ï¼Œå…³è”ç®¡ç†å‘˜:', skill.manager_dingtalk_id);
            
            try {
                const response = await fetch(`${API_BASE}/skills`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(skill)
                });
                
                if (response.ok) {
                    await loadDataFromServer();
                    showSuccess('skill-success', 'âœ… æŠ€èƒ½æ·»åŠ æˆåŠŸï¼');
                    this.reset();
                } else {
                    alert('âŒ æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                alert('âŒ æ·»åŠ å¤±è´¥: ' + error.message);
            }
        });

        // å‘˜å·¥è¡¨å•æäº¤
        // å½“å‰ç¼–è¾‘çš„å‘˜å·¥IDï¼ˆnullè¡¨ç¤ºæ–°å»ºï¼‰
        let editingEmployeeId = null;
        
        document.getElementById('employee-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // è·å–å‘˜å·¥æŠ€èƒ½æ•°æ®
            const skillsData = getEmployeeSkillsData();
            
            const employee = {
                name: document.getElementById('employee-name').value,
                dingtalk_id: document.getElementById('employee-dingtalk-id').value,
                manager_dingtalk_id: currentAdmin ? currentAdmin.userid : null,
                skills: skillsData
            };
            
            console.log(editingEmployeeId ? 'æ›´æ–°å‘˜å·¥' : 'æ·»åŠ å‘˜å·¥', employee);
            
            try {
                let response;
                if (editingEmployeeId) {
                    // æ›´æ–°å‘˜å·¥
                    response = await fetch(`${API_BASE}/employees/${editingEmployeeId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(employee)
                    });
                } else {
                    // åˆ›å»ºå‘˜å·¥
                    response = await fetch(`${API_BASE}/employees`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(employee)
                    });
                }
                
                if (response.ok) {
                    await loadDataFromServer();
                    showSuccess('employee-success', editingEmployeeId ? 'âœ… å‘˜å·¥ä¿¡æ¯æ›´æ–°æˆåŠŸï¼' : 'âœ… å‘˜å·¥æ·»åŠ æˆåŠŸï¼');
                    resetEmployeeForm();
                } else {
                    const error = await response.json().catch(() => ({}));
                    alert('âŒ æ“ä½œå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
            }
        });
        
        // é‡ç½®å‘˜å·¥è¡¨å•
        function resetEmployeeForm() {
            document.getElementById('employee-form').reset();
            clearEmployeeSkillRows();
            editingEmployeeId = null;
            document.getElementById('employee-form-title').textContent = 'â• æ·»åŠ å‘˜å·¥';
            document.getElementById('employee-submit-btn').textContent = 'âœ… æ·»åŠ å‘˜å·¥';
            document.getElementById('employee-cancel-btn').style.display = 'none';
        }
        
        // ç¼–è¾‘å‘˜å·¥
        function editEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;
            
            editingEmployeeId = employeeId;
            
            // å¡«å……è¡¨å•
            document.getElementById('employee-name').value = employee.name || '';
            document.getElementById('employee-dingtalk-id').value = employee.dingtalk_id || '';
            
            // æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ æŠ€èƒ½è¡Œ
            clearEmployeeSkillRows();
            
            // æ·»åŠ å‘˜å·¥å·²æœ‰çš„æŠ€èƒ½
            if (employee.skills && employee.skills.length > 0) {
                employee.skills.forEach(skill => {
                    addEmployeeSkillRow(skill.skill_id, skill.rating);
                });
            }
            
            // æ›´æ–°è¡¨å•æ ‡é¢˜å’ŒæŒ‰é’®
            document.getElementById('employee-form-title').textContent = 'âœï¸ ç¼–è¾‘å‘˜å·¥';
            document.getElementById('employee-submit-btn').textContent = 'âœ… ä¿å­˜ä¿®æ”¹';
            document.getElementById('employee-cancel-btn').style.display = 'inline-block';
            
            // æ»šåŠ¨åˆ°è¡¨å•
            document.getElementById('employee-form').scrollIntoView({ behavior: 'smooth' });
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks() {
            const container = document.getElementById('tasks-container');
            document.getElementById('task-count').textContent = tasks.length + ' ä¸ªä»»åŠ¡';
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>æš‚æ— ä»»åŠ¡ï¼Œè¯·æ·»åŠ æ–°ä»»åŠ¡</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tasks.map(task => {
                const skillsHtml = task.skills && task.skills.length > 0
                    ? `<div style="margin-top: 10px; font-size: 13px;">
                        <span style="color: #666;">ğŸ¯ æ‰€éœ€æŠ€èƒ½ï¼š</span>
                        ${task.skills.map(skill => `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; margin-right: 5px; display: inline-block; margin-top: 3px;">${skill.name}</span>`).join('')}
                       </div>`
                    : '<div style="margin-top: 10px; font-size: 13px; color: #ef4444;">âš ï¸ æœªè®¾ç½®æ‰€éœ€æŠ€èƒ½</div>';
                
                // é‡è¦ç¨‹åº¦é¢œè‰²
                const importanceColor = getImportanceColor(task.importance || 5);
                const importanceLabel = getImportanceLabel(task.importance || 5);
                
                return `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-title">${task.name}</div>
                            <div class="item-actions">
                                <span style="background: ${importanceColor}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; margin-right: 10px;">
                                    â­ ${task.importance || 5}åˆ† ${importanceLabel}
                                </span>
                                <button class="btn btn-small" style="background: #3b82f6; margin-right: 5px;" onclick="editTask(${task.id})">
                                    âœï¸ ç¼–è¾‘
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>
                        <div class="item-desc">${task.description}</div>
                        <div style="display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
                            ${task.estimated_hours ? `<div style="color: #10b981; font-size: 13px;">â±ï¸ é¢„è®¡è€—æ—¶ï¼š${task.estimated_hours} å°æ—¶</div>` : ''}
                            ${task.deadline ? `<div style="color: #667eea; font-size: 13px;">ğŸ“… é¢„è®¡å®Œæˆï¼š${formatDateTime(task.deadline)}</div>` : ''}
                        </div>
                        ${task.importance_note ? `<div style="color: #666; font-size: 13px; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${importanceColor};">ğŸ’¡ é‡è¦åº¦è¯´æ˜ï¼š${task.importance_note}</div>` : ''}
                        ${skillsHtml}
                    </div>
                `;
            }).join('');
        }
        
        // è·å–é‡è¦ç¨‹åº¦é¢œè‰²
        function getImportanceColor(importance) {
            if (importance >= 8) return '#ef4444';  // çº¢è‰² - éå¸¸é‡è¦
            if (importance >= 6) return '#f59e0b';  // æ©™è‰² - æ¯”è¾ƒé‡è¦
            if (importance >= 4) return '#667eea';  // è“è‰² - ä¸€èˆ¬
            return '#10b981';  // ç»¿è‰² - ä¸å¤ªé‡è¦
        }
        
        // è·å–é‡è¦ç¨‹åº¦æ ‡ç­¾
        function getImportanceLabel(importance) {
            if (importance >= 9) return 'æé«˜';
            if (importance >= 7) return 'å¾ˆé«˜';
            if (importance >= 5) return 'ä¸­ç­‰';
            if (importance >= 3) return 'è¾ƒä½';
            return 'ä½';
        }

        // æ¸²æŸ“æŠ€èƒ½åˆ—è¡¨ï¼ˆç –å—å½¢å¼ï¼‰
        function renderSkills() {
            const container = document.getElementById('skills-container');
            document.getElementById('skill-count').textContent = skills.length + ' ä¸ªæŠ€èƒ½';
            
            if (skills.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 48px; height: 48px; margin-bottom: 10px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <p>æš‚æ— æŠ€èƒ½ï¼Œè¯·æ·»åŠ æŠ€èƒ½</p>
                    </div>
                `;
                updateTaskSkillSelector();
                return;
            }
            
            // æ¸²æŸ“ä¸ºç –å—å½¢å¼
            container.innerHTML = skills.map(skill => `
                <div class="skill-brick">
                    ${skill.name}
                    <span class="delete-btn" onclick="deleteSkill(${skill.id}); event.stopPropagation();">Ã—</span>
                </div>
            `).join('');
            
            // æ›´æ–°ä»»åŠ¡è¡¨å•ä¸­çš„æŠ€èƒ½é€‰æ‹©å™¨
            updateTaskSkillSelector();
        }

        // æ›´æ–°ä»»åŠ¡è¡¨å•ä¸­çš„æŠ€èƒ½é€‰æ‹©å™¨ï¼ˆç –å—å½¢å¼ï¼‰
        function updateTaskSkillSelector() {
            const selector = document.getElementById('task-skills-selector');
            if (!selector) return;
            
            if (skills.length === 0) {
                selector.innerHTML = '<div style="color: #999; font-size: 14px;">æš‚æ— æŠ€èƒ½ï¼Œè¯·å…ˆæ·»åŠ æŠ€èƒ½</div>';
                return;
            }
            
            // è·å–å½“å‰é€‰ä¸­çš„æŠ€èƒ½
            const selectedSkillsInput = document.getElementById('selected-skills');
            const selectedIds = selectedSkillsInput.value ? selectedSkillsInput.value.split(',').map(id => parseInt(id)) : [];
            
            selector.innerHTML = skills.map(skill => {
                const isSelected = selectedIds.includes(skill.id);
                return `
                    <div class="skill-brick ${isSelected ? 'selected' : ''}" 
                         data-skill-id="${skill.id}"
                         onclick="toggleSkillSelection(${skill.id})">
                        ${skill.name}
                        ${isSelected ? '<span class="close-icon" onclick="toggleSkillSelection(' + skill.id + '); event.stopPropagation();">Ã—</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        // åˆ‡æ¢æŠ€èƒ½é€‰æ‹©çŠ¶æ€
        function toggleSkillSelection(skillId) {
            const selectedSkillsInput = document.getElementById('selected-skills');
            let selectedIds = selectedSkillsInput.value ? selectedSkillsInput.value.split(',').map(id => parseInt(id)) : [];
            
            if (selectedIds.includes(skillId)) {
                // å–æ¶ˆé€‰æ‹©
                selectedIds = selectedIds.filter(id => id !== skillId);
            } else {
                // é€‰æ‹©
                selectedIds.push(skillId);
            }
            
            selectedSkillsInput.value = selectedIds.join(',');
            updateTaskSkillSelector();
        }

        // æ·»åŠ å‘˜å·¥æŠ€èƒ½è¡Œ
        let employeeSkillRowCount = 0;
        
        function addEmployeeSkillRow(initialSkillId = null, initialRating = 5) {
            const container = document.getElementById('employee-skills-container');
            const rowId = employeeSkillRowCount++;
            
            const row = document.createElement('div');
            row.className = 'employee-skill-row';
            row.id = `employee-skill-row-${rowId}`;
            
            const skillOptions = skills.length > 0 
                ? skills.map(s => `<option value="${s.id}" ${s.id === initialSkillId ? 'selected' : ''}>${s.name}</option>`).join('')
                : '<option value="">æš‚æ— æŠ€èƒ½</option>';
            
            row.innerHTML = `
                <select class="employee-skill-select" data-row-id="${rowId}">
                    <option value="">é€‰æ‹©æŠ€èƒ½</option>
                    ${skillOptions}
                </select>
                <div class="rating-container">
                    <span style="color: #666; font-size: 13px;">è¯„åˆ†:</span>
                    <input type="range" class="rating-slider" min="1" max="10" value="${initialRating}" 
                           data-row-id="${rowId}"
                           oninput="updateRatingDisplay(${rowId}, this.value)">
                    <span class="rating-value" id="rating-value-${rowId}">${initialRating}</span>
                </div>
                <button type="button" class="remove-skill-btn" onclick="removeEmployeeSkillRow(${rowId})">Ã—</button>
            `;
            
            container.appendChild(row);
        }

        // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
        function updateRatingDisplay(rowId, value) {
            const valueDisplay = document.getElementById(`rating-value-${rowId}`);
            if (valueDisplay) {
                valueDisplay.textContent = value;
            }
        }

        // åˆ é™¤å‘˜å·¥æŠ€èƒ½è¡Œ
        function removeEmployeeSkillRow(rowId) {
            const row = document.getElementById(`employee-skill-row-${rowId}`);
            if (row) {
                row.remove();
            }
        }

        // è·å–å‘˜å·¥æŠ€èƒ½æ•°æ®
        function getEmployeeSkillsData() {
            const rows = document.querySelectorAll('.employee-skill-row');
            const skillsData = [];
            
            rows.forEach(row => {
                const select = row.querySelector('.employee-skill-select');
                const slider = row.querySelector('.rating-slider');
                
                if (select && slider && select.value) {
                    skillsData.push({
                        skill_id: parseInt(select.value),
                        rating: parseInt(slider.value)
                    });
                }
            });
            
            return skillsData;
        }

        // æ¸…ç©ºå‘˜å·¥æŠ€èƒ½è¡Œ
        function clearEmployeeSkillRows() {
            const container = document.getElementById('employee-skills-container');
            if (container) {
                container.innerHTML = '';
            }
            employeeSkillRowCount = 0;
        }

        // ä»»åŠ¡é€‰æ‹©å˜åŒ–æ—¶æ˜¾ç¤ºæŠ€èƒ½å’Œå…¶ä»–ä¿¡æ¯
        function onTaskSelectChange(selectElement) {
            const row = selectElement.closest('.distribute-row');
            const skillsDisplay = row.querySelector('.task-skills-display');
            const taskId = parseInt(selectElement.value);
            
            if (!taskId) {
                skillsDisplay.style.display = 'none';
                return;
            }
            
            // æŸ¥æ‰¾ä»»åŠ¡
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                const importanceColor = getImportanceColor(task.importance || 5);
                const importanceLabel = getImportanceLabel(task.importance || 5);
                
                // æŠ€èƒ½HTML
                const skillsHtml = task.skills && task.skills.length > 0
                    ? task.skills.map(s => `<span class="skill-tag task-skill">${s.name}</span>`).join('')
                    : '<span style="color: #999; font-size: 12px;">æœªè®¾ç½®æŠ€èƒ½</span>';
                
                skillsDisplay.innerHTML = `
                    <div style="width: 100%; margin-bottom: 8px;">
                        <span style="background: ${importanceColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-right: 10px;">
                            â­ é‡è¦åº¦ ${task.importance || 5}åˆ† ${importanceLabel}
                        </span>
                        ${task.estimated_hours ? `<span style="background: #d1fae5; color: #065f46; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">â±ï¸ ${task.estimated_hours}å°æ—¶</span>` : ''}
                    </div>
                    <span style="color: #e65100; font-size: 12px; margin-right: 5px;">ğŸ“‹ æ‰€éœ€æŠ€èƒ½:</span>
                    ${skillsHtml}
                `;
                skillsDisplay.style.display = 'flex';
                skillsDisplay.style.flexWrap = 'wrap';
            } else {
                skillsDisplay.innerHTML = '<span style="color: #999; font-size: 12px;">è¯¥ä»»åŠ¡æœªè®¾ç½®æ‰€éœ€æŠ€èƒ½</span>';
                skillsDisplay.style.display = 'flex';
            }
            
            updatePreview();
        }

        // å‘˜å·¥é€‰æ‹©å˜åŒ–æ—¶æ˜¾ç¤ºæŠ€èƒ½
        function onEmployeeSelectChange(selectElement) {
            const row = selectElement.closest('.distribute-row');
            const skillsDisplay = row.querySelector('.employee-skills-display');
            const employeeId = parseInt(selectElement.value);
            
            if (!employeeId) {
                skillsDisplay.style.display = 'none';
                return;
            }
            
            // æŸ¥æ‰¾å‘˜å·¥
            const employee = employees.find(e => e.id === employeeId);
            if (employee && employee.skills && employee.skills.length > 0) {
                const skillsHtml = employee.skills.map(s => 
                    `<span class="skill-tag employee-skill">${s.skill_name} <span class="rating">${s.rating}åˆ†</span></span>`
                ).join('');
                
                skillsDisplay.innerHTML = `
                    <span style="color: #2e7d32; font-size: 12px; margin-right: 5px;">ğŸ§‘â€ğŸ’¼ å‘˜å·¥æŠ€èƒ½:</span>
                    ${skillsHtml}
                `;
                skillsDisplay.style.display = 'flex';
            } else {
                skillsDisplay.innerHTML = '<span style="color: #999; font-size: 12px;">è¯¥å‘˜å·¥æœªè®¾ç½®æŠ€èƒ½</span>';
                skillsDisplay.style.display = 'flex';
            }
            
            updatePreview();
        }

        // æ¸²æŸ“å‘˜å·¥åˆ—è¡¨
        function renderEmployees() {
            const container = document.getElementById('employees-container');
            document.getElementById('employee-count').textContent = employees.length + ' åå‘˜å·¥';
            
            if (employees.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p>æš‚æ— å‘˜å·¥ï¼Œè¯·æ·»åŠ å‘˜å·¥ä¿¡æ¯</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = employees.map(emp => {
                // æ¸²æŸ“å‘˜å·¥æŠ€èƒ½
                const skillsHtml = emp.skills && emp.skills.length > 0
                    ? `<div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                        ${emp.skills.map(s => `
                            <span style="background: #e8f5e9; color: #2e7d32; padding: 3px 10px; border-radius: 4px; font-size: 12px;">
                                ${s.skill_name} <span style="background: rgba(0,0,0,0.1); padding: 1px 5px; border-radius: 3px; margin-left: 3px;">${s.rating}åˆ†</span>
                            </span>
                        `).join('')}
                       </div>`
                    : '<div style="margin-top: 8px; color: #999; font-size: 12px;">æš‚æ— æŠ€èƒ½</div>';
                
                return `
                    <div class="employee-card">
                        <div class="employee-info" style="flex: 1;">
                            <div class="employee-name">ğŸ‘¤ ${emp.name}</div>
                            <div class="employee-id">é’‰é’‰ID: ${emp.dingtalk_id || emp.dingtalkId}</div>
                            ${skillsHtml}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-small" style="background: #3b82f6;" onclick="editEmployee(${emp.id})">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteEmployee(${emp.id})">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“åˆ†é…è®°å½•
        function renderRecords() {
            const container = document.getElementById('records-container');
            document.getElementById('record-count').textContent = assignments.length + ' æ¡è®°å½•';
            
            if (assignments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>æš‚æ— åˆ†é…è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨æœ€å‰é¢ï¼‰
            const sortedAssignments = assignments.slice().sort((a, b) => {
                const timeA = new Date(a.assignedAt).getTime();
                const timeB = new Date(b.assignedAt).getTime();
                return timeB - timeA;  // é™åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨å‰
            });
            
            container.innerHTML = sortedAssignments.map(assign => {
                // çŠ¶æ€æ˜¾ç¤º
                let statusBadge = '';
                if (assign.status === 'completed') {
                    statusBadge = '<span class="status-badge status-completed">âœ… å·²å®Œæˆ</span>';
                } else if (assign.status === 'pending') {
                    statusBadge = '<span class="status-badge status-pending">â³ å¾…å¤„ç†</span>';
                } else if (assign.status === 'accepted') {
                    statusBadge = '<span class="status-badge status-accepted">ğŸ”„ è¿›è¡Œä¸­</span>';
                } else {
                    statusBadge = '<span class="status-badge status-rejected">âŒ å·²æ‹’ç»</span>';
                }
                
                // å®Œæˆæƒ…å†µæ˜¾ç¤º
                let completionSection = '';
                if (assign.status === 'completed' && assign.completionNote) {
                    completionSection = `
                        <div style="margin-top: 15px; padding: 15px; background: #f0fdf4; border-radius: 10px; border: 1px solid #bbf7d0;">
                            <div style="font-size: 14px; color: #166534; font-weight: 600; margin-bottom: 10px;">ğŸ“ å‘˜å·¥å®Œæˆæƒ…å†µ</div>
                            <div style="font-size: 14px; color: #4b5563; line-height: 1.6;">${assign.completionNote}</div>
                            <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 13px; color: #6b7280;">
                                ${assign.actualHours ? `<span>â±ï¸ å®é™…ç”¨æ—¶: ${assign.actualHours}å°æ—¶</span>` : ''}
                                ${assign.completedAt ? `<span>ğŸ“… å®Œæˆæ—¶é—´: ${formatDateTime(assign.completedAt)}</span>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // ç»ç†è¯„ä»·æ˜¾ç¤º
                let reviewSection = '';
                if (assign.status === 'completed') {
                    if (assign.efficiencyRating) {
                        reviewSection = `
                            <div style="margin-top: 15px; padding: 15px; background: #f5f3ff; border-radius: 10px; border: 1px solid #ddd6fe;">
                                <div style="font-size: 14px; color: #7c3aed; font-weight: 600; margin-bottom: 10px;">ğŸ“Š ç»ç†è¯„ä»·</div>
                                <div style="display: flex; gap: 30px; margin-bottom: 10px;">
                                    <div>
                                        <span style="color: #6b7280;">æ•ˆç‡è¯„åˆ†:</span>
                                        <span style="font-weight: 600; color: ${assign.efficiencyRating >= 7 ? '#16a34a' : assign.efficiencyRating >= 5 ? '#f59e0b' : '#ef4444'};">
                                            ${assign.efficiencyRating}/10
                                        </span>
                                    </div>
                                    <div>
                                        <span style="color: #6b7280;">è´¨é‡è¯„åˆ†:</span>
                                        <span style="font-weight: 600; color: ${assign.qualityRating >= 7 ? '#16a34a' : assign.qualityRating >= 5 ? '#f59e0b' : '#ef4444'};">
                                            ${assign.qualityRating}/10
                                        </span>
                                    </div>
                                </div>
                                ${assign.reviewComment ? `<div style="font-size: 14px; color: #4b5563; line-height: 1.6;">${assign.reviewComment}</div>` : ''}
                                <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">è¯„ä»·æ—¶é—´: ${formatDateTime(assign.reviewedAt)}</div>
                            </div>
                        `;
                    } else if (assign.completionNote) {
                        // æœ‰å®Œæˆæƒ…å†µä½†æœªè¯„ä»·ï¼Œæ˜¾ç¤ºè¯„ä»·æŒ‰é’®
                        reviewSection = `
                            <div style="margin-top: 15px; text-align: right;">
                                <button class="btn btn-primary" onclick="showReviewModal(${assign.id}, '${assign.taskName}', '${assign.employeeName}')" style="background: #8b5cf6;">
                                    ğŸ“ è¯„ä»·
                                </button>
                            </div>
                        `;
                    }
                }
                
                return `
                    <div class="record-card" style="${assign.status === 'completed' ? 'border-left: 4px solid #22c55e;' : ''}">
                        <div class="record-header">
                            ${statusBadge}
                            ${assign.notificationSent ? 
                                '<span class="notification-badge notification-success">âœ… é€šçŸ¥å·²å‘é€</span>' : 
                                '<span class="notification-badge notification-failed" title="' + (assign.notificationError || 'å‘é€å¤±è´¥') + '">âŒ é€šçŸ¥æœªå‘é€</span>'
                            }
                            <span class="record-time">ğŸ“… ${formatDateTime(assign.assignedAt)}</span>
                        </div>
                        <div class="record-detail">
                            <div class="record-field">
                                <strong>ä»»åŠ¡åç§°</strong>
                                ${assign.taskName}
                            </div>
                            <div class="record-field">
                                <strong>åˆ†é…ç»™</strong>
                                ${assign.employeeName}
                            </div>
                            ${assign.taskDeadline ? `
                            <div class="record-field">
                                <strong>é¢„è®¡å®Œæˆæ—¶é—´</strong>
                                ${formatDateTime(assign.taskDeadline)}
                            </div>
                            ` : ''}
                            ${assign.taskEstimatedHours ? `
                            <div class="record-field">
                                <strong>é¢„è®¡è€—æ—¶</strong>
                                ${assign.taskEstimatedHours}å°æ—¶
                            </div>
                            ` : ''}
                        </div>
                        ${assign.status === 'rejected' && assign.rejectReason ? `
                            <div class="reject-reason">
                                <strong>âŒ æ‹’ç»ç†ç”±</strong>
                                <p>${assign.rejectReason}</p>
                            </div>
                        ` : ''}
                        ${assign.notificationSent === false && assign.notificationError ? `
                            <div class="notification-error">
                                <strong>âš ï¸ é€šçŸ¥å‘é€å¤±è´¥åŸå› </strong>
                                <p>${assign.notificationError}</p>
                            </div>
                        ` : ''}
                        ${completionSection}
                        ${reviewSection}
                    </div>
                `;
            }).join('');
        }
        
        // æ˜¾ç¤ºè¯„ä»·å¼¹çª—
        function showReviewModal(assignmentId, taskName, employeeName) {
            const modalHtml = `
                <div class="modal" id="reviewModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>ğŸ“Š è¯„ä»·ä»»åŠ¡å®Œæˆæƒ…å†µ</h3>
                            <button class="close-btn" onclick="closeReviewModal()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 20px; padding: 15px; background: #f5f3ff; border-radius: 10px;">
                                <div style="font-size: 14px; color: #7c3aed;"><strong>ä»»åŠ¡:</strong> ${taskName}</div>
                                <div style="font-size: 14px; color: #7c3aed;"><strong>å‘˜å·¥:</strong> ${employeeName}</div>
                            </div>
                            
                            <div class="form-group">
                                <label>æ•ˆç‡è¯„åˆ† <span style="color: #6b7280;">(1-10åˆ†ï¼Œè¶Šé«˜è¶Šå¥½)</span></label>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <input type="range" id="efficiencyRating" min="1" max="10" value="7" 
                                           style="flex: 1;" oninput="document.getElementById('efficiencyValue').textContent = this.value">
                                    <span id="efficiencyValue" style="font-size: 20px; font-weight: bold; color: #8b5cf6; min-width: 30px;">7</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>è´¨é‡è¯„åˆ† <span style="color: #6b7280;">(1-10åˆ†ï¼Œè¶Šé«˜è¶Šå¥½)</span></label>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <input type="range" id="qualityRating" min="1" max="10" value="7" 
                                           style="flex: 1;" oninput="document.getElementById('qualityValue').textContent = this.value">
                                    <span id="qualityValue" style="font-size: 20px; font-weight: bold; color: #8b5cf6; min-width: 30px;">7</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>è¯„å®¡æ„è§ <span style="color: #6b7280;">(é€‰å¡«)</span></label>
                                <textarea id="reviewComment" rows="4" placeholder="è¯·å¡«å†™å¯¹å‘˜å·¥å®Œæˆæƒ…å†µçš„è¯„å®¡æ„è§..."
                                          style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-cancel" onclick="closeReviewModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="submitReview(${assignmentId})" style="background: #8b5cf6;">ä¿å­˜è¯„ä»·</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // å…³é—­è¯„ä»·å¼¹çª—
        function closeReviewModal() {
            const modal = document.getElementById('reviewModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // æäº¤è¯„ä»·
        async function submitReview(assignmentId) {
            const efficiencyRating = parseInt(document.getElementById('efficiencyRating').value);
            const qualityRating = parseInt(document.getElementById('qualityRating').value);
            const reviewComment = document.getElementById('reviewComment').value.trim();
            
            try {
                const response = await fetch(`/api/assignments/${assignmentId}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        efficiency_rating: efficiencyRating,
                        quality_rating: qualityRating,
                        review_comment: reviewComment
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeReviewModal();
                    alert('âœ… è¯„ä»·å·²ä¿å­˜ï¼');
                    // åˆ·æ–°æ•°æ®
                    await loadDataFromServer();
                } else {
                    alert(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤è¯„ä»·é”™è¯¯:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ›´æ–°ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡
        function updateTaskStatus() {
            // ç»Ÿè®¡å„ç§çŠ¶æ€
            const taskStatus = {};
            tasks.forEach(task => {
                taskStatus[task.id] = {
                    task: task,
                    assignments: [],
                    status: 'unassigned'  // unassigned, pending, accepted, rejected
                };
            });

            // ç»Ÿè®¡æ¯ä¸ªä»»åŠ¡çš„åˆ†é…æƒ…å†µ
            assignments.forEach(assign => {
                if (taskStatus[assign.taskId]) {
                    taskStatus[assign.taskId].assignments.push(assign);
                    // æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼ˆä¼˜å…ˆçº§ï¼šaccepted > pending > rejected > unassignedï¼‰
                    if (assign.status === 'accepted') {
                        taskStatus[assign.taskId].status = 'accepted';
                    } else if (assign.status === 'pending' && taskStatus[assign.taskId].status !== 'accepted') {
                        taskStatus[assign.taskId].status = 'pending';
                    } else if (assign.status === 'rejected' && taskStatus[assign.taskId].status === 'unassigned') {
                        taskStatus[assign.taskId].status = 'rejected';
                    }
                }
            });

            // ç»Ÿè®¡æ•°é‡
            let unassignedCount = 0;
            let pendingCount = 0;
            let acceptedCount = 0;
            let rejectedCount = 0;

            Object.values(taskStatus).forEach(item => {
                if (item.status === 'unassigned') unassignedCount++;
                else if (item.status === 'pending') pendingCount++;
                else if (item.status === 'accepted') acceptedCount++;
                else if (item.status === 'rejected') rejectedCount++;
            });

            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            document.getElementById('unassigned-count').textContent = unassignedCount;
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('accepted-count').textContent = acceptedCount;
            document.getElementById('rejected-count').textContent = rejectedCount;

            // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
            renderTaskStatusList(taskStatus);
        }

        // æ¸²æŸ“ä»»åŠ¡çŠ¶æ€åˆ—è¡¨
        function renderTaskStatusList(taskStatus) {
            const container = document.getElementById('task-status-list');
            
            if (Object.keys(taskStatus).length === 0) {
                container.innerHTML = '';
                return;
            }

            // æŒ‰çŠ¶æ€åˆ†ç»„
            const groups = {
                unassigned: { title: 'ğŸ“ æœªåˆ†é…ä»»åŠ¡', color: '#3b82f6', items: [] },
                rejected: { title: 'âŒ å·²æ‹’ç»å¾…é‡æ–°åˆ†é…', color: '#ef4444', items: [] },
                pending: { title: 'â³ å¾…å‘˜å·¥å¤„ç†', color: '#f59e0b', items: [] },
                accepted: { title: 'âœ… å·²æ¥å—è¿›è¡Œä¸­', color: '#10b981', items: [] }
            };

            Object.values(taskStatus).forEach(item => {
                groups[item.status].items.push(item);
            });

            let html = '';
            Object.entries(groups).forEach(([status, group]) => {
                if (group.items.length > 0) {
                    html += `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: ${group.color}; margin-bottom: 15px; font-size: 16px;">
                                ${group.title} (${group.items.length})
                            </h4>
                            <div style="display: grid; gap: 10px;">
                                ${group.items.map(item => {
                                    const importanceColor = getImportanceColor(item.task.importance || 5);
                                    return `
                                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${group.color};">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #333; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                                    ${item.task.name}
                                                    <span style="background: ${importanceColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">
                                                        â­${item.task.importance || 5}
                                                    </span>
                                                    ${item.task.estimated_hours ? `<span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 10px; font-size: 11px;">â±ï¸${item.task.estimated_hours}h</span>` : ''}
                                                </div>
                                                ${item.assignments.length > 0 ? `
                                                    <div style="font-size: 13px; color: #666;">
                                                        ${item.assignments.map(a => {
                                                            let statusText = '';
                                                            if (a.status === 'pending') statusText = 'â³ å¾…å¤„ç†';
                                                            else if (a.status === 'accepted') statusText = 'âœ… å·²æ¥å—';
                                                            else if (a.status === 'rejected') statusText = 'âŒ å·²æ‹’ç»';
                                                            return `${a.employeeName}: ${statusText}`;
                                                        }).join(' | ')}
                                                    </div>
                                                ` : '<div style="font-size: 13px; color: #999;">å°šæœªåˆ†é…</div>'}
                                            </div>
                                            ${status === 'unassigned' || status === 'rejected' ? `
                                                <button class="btn btn-small" onclick="quickAssignTask(${item.task.id})" style="white-space: nowrap;">
                                                    å¿«é€Ÿåˆ†é…
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html || '<p style="color: #999; text-align: center; padding: 20px;">æš‚æ— ä»»åŠ¡</p>';
        }

        // å¿«é€Ÿåˆ†é…ä»»åŠ¡
        function quickAssignTask(taskId) {
            // æ»šåŠ¨åˆ°åˆ†é…åŒºåŸŸ
            document.querySelector('.distribute-section h3').scrollIntoView({ behavior: 'smooth' });
            
            // è‡ªåŠ¨é€‰ä¸­è¯¥ä»»åŠ¡
            setTimeout(() => {
                const taskSelect = document.querySelector('.task-select');
                if (taskSelect) {
                    taskSelect.value = taskId;
                    taskSelect.focus();
                    updatePreview();
                }
            }, 500);
        }

        // æ›´æ–°åˆ†é…é¢æ¿çš„é€‰æ‹©å™¨
        function updateDistributeSelects() {
            // è¿‡æ»¤å‡ºå¯ä»¥åˆ†é…çš„ä»»åŠ¡ï¼ˆæœªåˆ†é…æˆ–å·²æ‹’ç»çš„ä»»åŠ¡ï¼‰
            const availableTasks = tasks.filter(task => {
                // æŸ¥æ‰¾è¯¥ä»»åŠ¡çš„æ‰€æœ‰åˆ†é…è®°å½•
                const taskAssignments = assignments.filter(a => a.taskId === task.id);
                
                // å¦‚æœæ²¡æœ‰åˆ†é…è®°å½•ï¼Œå¯ä»¥åˆ†é…
                if (taskAssignments.length === 0) {
                    return true;
                }
                
                // å¦‚æœæ‰€æœ‰åˆ†é…éƒ½æ˜¯æ‹’ç»çŠ¶æ€ï¼Œå¯ä»¥é‡æ–°åˆ†é…
                const allRejected = taskAssignments.every(a => a.status === 'rejected');
                if (allRejected) {
                    return true;
                }
                
                // å¦‚æœæœ‰å·²æ¥å—çš„åˆ†é…ï¼Œä¸èƒ½å†åˆ†é…
                const hasAccepted = taskAssignments.some(a => a.status === 'accepted');
                if (hasAccepted) {
                    return false;
                }
                
                // å¦‚æœæœ‰å¾…å¤„ç†çš„åˆ†é…ï¼Œå¯ä»¥ç»§ç»­åˆ†é…ç»™å…¶ä»–äºº
                return true;
            });
            
            const taskOptions = '<option value="">è¯·é€‰æ‹©ä»»åŠ¡</option>' + 
                availableTasks.map(t => {
                    const taskAssignments = assignments.filter(a => a.taskId === t.id);
                    const rejectedCount = taskAssignments.filter(a => a.status === 'rejected').length;
                    const pendingCount = taskAssignments.filter(a => a.status === 'pending').length;
                    
                    let label = t.name;
                    if (rejectedCount > 0) {
                        label += ` (å·²è¢«${rejectedCount}äººæ‹’ç»)`;
                    } else if (pendingCount > 0) {
                        label += ` (å¾…${pendingCount}äººå¤„ç†)`;
                    }
                    
                    return `<option value="${t.id}">${label}</option>`;
                }).join('');
            
            const employeeOptions = '<option value="">è¯·é€‰æ‹©å‘˜å·¥</option>' + 
                employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            
            document.querySelectorAll('.task-select').forEach(select => {
                select.innerHTML = taskOptions;
            });
            
            document.querySelectorAll('.employee-select').forEach(select => {
                select.innerHTML = employeeOptions;
            });
            
            updatePreview();
            updateTaskStatus();
        }

        // æ·»åŠ åˆ†é…è¡Œ
        let distributeRowCount = 1;  // ä»1å¼€å§‹ï¼Œå› ä¸º0æ˜¯åˆå§‹è¡Œ
        
        function addDistributeRow() {
            const container = document.getElementById('distribute-rows');
            const rowId = distributeRowCount++;
            const row = document.createElement('div');
            row.className = 'distribute-row';
            row.setAttribute('data-row-id', rowId);
            row.innerHTML = `
                <div class="form-group" style="margin-bottom: 0; flex: 1;">
                    <label>é€‰æ‹©ä»»åŠ¡</label>
                    <select class="task-select" onchange="onTaskSelectChange(this)" required>
                        <option value="">è¯·é€‰æ‹©ä»»åŠ¡</option>
                        ${tasks.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                    </select>
                    <div class="skill-display task-skills-display" style="display: none;">
                        <span style="color: #e65100; font-size: 12px; margin-right: 5px;">ğŸ“‹ ä»»åŠ¡æ‰€éœ€æŠ€èƒ½:</span>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0; flex: 1;">
                    <label>é€‰æ‹©å‘˜å·¥</label>
                    <select class="employee-select" onchange="onEmployeeSelectChange(this)" required>
                        <option value="">è¯·é€‰æ‹©å‘˜å·¥</option>
                        ${employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                    </select>
                    <div class="skill-display employee-skills-display" style="display: none;">
                        <span style="color: #2e7d32; font-size: 12px; margin-right: 5px;">ğŸ§‘â€ğŸ’¼ å‘˜å·¥æŠ€èƒ½:</span>
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeDistributeRow(this)">
                    âŒ ç§»é™¤
                </button>
            `;
            container.appendChild(row);
            updatePreview();
        }

        // ç§»é™¤åˆ†é…è¡Œ
        function removeDistributeRow(button) {
            button.closest('.distribute-row').remove();
            updatePreview();
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const rows = document.querySelectorAll('.distribute-row');
            const previewSection = document.getElementById('preview-section');
            const previewList = document.getElementById('preview-list');
            
            let previews = [];
            
            rows.forEach(row => {
                const taskId = row.querySelector('.task-select').value;
                const employeeId = row.querySelector('.employee-select').value;
                
                if (taskId && employeeId) {
                    const task = tasks.find(t => t.id == taskId);
                    const employee = employees.find(e => e.id == employeeId);
                    
                    if (task && employee) {
                        previews.push({ task, employee });
                    }
                }
            });
            
            if (previews.length > 0) {
                previewSection.style.display = 'block';
                previewList.innerHTML = previews.map(p => `
                    <div class="assignment-item">
                        <span>ğŸ“‹ ${p.task.name}</span>
                        <span>â†’</span>
                        <span>ğŸ‘¤ ${p.employee.name}</span>
                    </div>
                `).join('');
            } else {
                previewSection.style.display = 'none';
            }
        }

        // å‘é€ä»»åŠ¡åˆ†é…
        async function sendAssignments() {
            const rows = document.querySelectorAll('.distribute-row');
            let assignmentsToSend = [];
            
            rows.forEach(row => {
                const taskId = row.querySelector('.task-select').value;
                const employeeId = row.querySelector('.employee-select').value;
                
                if (taskId && employeeId) {
                    const task = tasks.find(t => t.id == taskId);
                    const employee = employees.find(e => e.id == employeeId);
                    
                    if (task && employee) {
                        assignmentsToSend.push({
                            id: Date.now() + Math.random(),
                            taskId: task.id,
                            taskName: task.name,
                            taskDescription: task.description,
                            taskDeadline: task.deadline,
                            employeeId: employee.id,
                            employeeName: employee.name,
                            employeeDingtalkId: employee.dingtalkId,
                            status: 'pending',
                            assignedAt: new Date().toISOString()
                        });
                    }
                }
            });
            
            if (assignmentsToSend.length === 0) {
                alert('âš ï¸ è¯·è‡³å°‘é…ç½®ä¸€ä¸ªä»»åŠ¡åˆ†é…');
                return;
            }
            
            // å‘é€åˆ°åç«¯ï¼ŒåŒ…å«åˆ†é…äººä¿¡æ¯
            try {
                const response = await fetch('/api/assignments/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        assignments: assignmentsToSend,
                        assignedByDingtalkId: currentAdmin ? currentAdmin.userid : null,
                        assignedByName: currentAdmin ? currentAdmin.name : 'ç®¡ç†å‘˜'
                    })
                });
                
                if (response.ok) {
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadDataFromServer();
                    
                    // æ¸…ç©ºåˆ†é…é¢æ¿
                    document.getElementById('distribute-rows').innerHTML = `
                        <div class="distribute-row" data-row-id="0">
                            <div class="form-group" style="margin-bottom: 0; flex: 1;">
                                <label>é€‰æ‹©ä»»åŠ¡</label>
                                <select class="task-select" onchange="onTaskSelectChange(this)" required>
                                    <option value="">è¯·é€‰æ‹©ä»»åŠ¡</option>
                                </select>
                                <div class="skill-display task-skills-display" style="display: none;">
                                    <span style="color: #e65100; font-size: 12px; margin-right: 5px;">ğŸ“‹ ä»»åŠ¡æ‰€éœ€æŠ€èƒ½:</span>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0; flex: 1;">
                                <label>é€‰æ‹©å‘˜å·¥</label>
                                <select class="employee-select" onchange="onEmployeeSelectChange(this)" required>
                                    <option value="">è¯·é€‰æ‹©å‘˜å·¥</option>
                                </select>
                                <div class="skill-display employee-skills-display" style="display: none;">
                                    <span style="color: #2e7d32; font-size: 12px; margin-right: 5px;">ğŸ§‘â€ğŸ’¼ å‘˜å·¥æŠ€èƒ½:</span>
                                </div>
                            </div>
                            <button type="button" class="btn btn-small" onclick="addDistributeRow()">
                                â• æ·»åŠ æ›´å¤š
                            </button>
                        </div>
                    `;
                    distributeRowCount = 1;  // é‡ç½®è®¡æ•°å™¨
                    updateDistributeSelects();
                    
                    showSuccess('distribute-success', `âœ… æˆåŠŸå‘é€ ${assignmentsToSend.length} ä¸ªä»»åŠ¡é€šçŸ¥åˆ°é’‰é’‰ï¼`);
                } else {
                    alert('âŒ å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                }
            } catch (error) {
                console.error('å‘é€å¤±è´¥:', error);
                alert('âŒ å‘é€å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ä»»åŠ¡
        async function deleteTask(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`${API_BASE}/tasks/${id}`, {method: 'DELETE'});
                    if (response.ok) {
                        await loadDataFromServer();
                    }
                } catch (error) {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
                }
            }
        }

        // åˆ é™¤å‘˜å·¥
        async function deleteEmployee(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‘˜å·¥å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`${API_BASE}/employees/${id}`, {method: 'DELETE'});
                    if (response.ok) {
                        await loadDataFromServer();
                    }
                } catch (error) {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
                }
            }
        }

        // åˆ é™¤æŠ€èƒ½
        async function deleteSkill(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ€èƒ½å—ï¼Ÿ\næ³¨æ„ï¼šä½¿ç”¨è¯¥æŠ€èƒ½çš„ä»»åŠ¡å’Œå‘˜å·¥å°†è‡ªåŠ¨è§£é™¤å…³è”ã€‚')) {
                try {
                    const response = await fetch(`${API_BASE}/skills/${id}`, {method: 'DELETE'});
                    if (response.ok) {
                        showSuccess('skill-success', 'âœ… æŠ€èƒ½åˆ é™¤æˆåŠŸï¼');
                        await loadDataFromServer();
                    } else {
                        const error = await response.json().catch(() => ({error: 'æœªçŸ¥é”™è¯¯'}));
                        alert('âŒ åˆ é™¤å¤±è´¥: ' + (error.error || 'æœåŠ¡å™¨é”™è¯¯'));
                    }
                } catch (error) {
                    alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
                }
            }
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.add('show');
            setTimeout(() => {
                element.classList.remove('show');
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(datetime) {
            if (!datetime) return '';
            const date = new Date(datetime);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ä»æœåŠ¡å™¨åŠ è½½æ•°æ®
        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        let loadingOverlay = null;
        function showLoading(message = 'æ­£åœ¨åŠ è½½æ•°æ®...') {
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; flex-direction: column;';
                document.body.appendChild(loadingOverlay);
            }
            loadingOverlay.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 40px; margin-bottom: 15px; animation: spin 1s linear infinite;">â³</div>
                    <div style="color: #667eea; font-size: 16px; font-weight: 600;">${message}</div>
                </div>
                <style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>
            `;
            loadingOverlay.style.display = 'flex';
        }
        
        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }
        
        async function loadDataFromServer() {
            const startTime = Date.now();
            showLoading('æ­£åœ¨åŠ è½½æ•°æ®...');
            
            try {
                // æ„å»ºURLï¼Œå¦‚æœå·²ç™»å½•åˆ™æ·»åŠ ç®¡ç†å‘˜ç­›é€‰å‚æ•°
                let employeesUrl = `${API_BASE}/employees`;
                let assignmentsUrl = `${API_BASE}/assignments`;
                let skillsUrl = `${API_BASE}/skills`;
                
                if (isLoggedIn && currentAdmin && currentAdmin.userid) {
                    employeesUrl += `?manager_dingtalk_id=${currentAdmin.userid}`;
                    assignmentsUrl += `?manager_dingtalk_id=${currentAdmin.userid}`;
                    skillsUrl += `?manager_dingtalk_id=${currentAdmin.userid}`;
                    console.log('ç­›é€‰ç®¡ç†å‘˜æ•°æ®:', currentAdmin.userid);
                }
                
                // å¹¶è¡Œè¯·æ±‚æ‰€æœ‰æ•°æ®
                const [tasksRes, employeesRes, assignmentsRes, skillsRes] = await Promise.all([
                    fetch(`${API_BASE}/tasks`),
                    fetch(employeesUrl),
                    fetch(assignmentsUrl),
                    fetch(skillsUrl)
                ]);
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!tasksRes.ok || !employeesRes.ok || !assignmentsRes.ok || !skillsRes.ok) {
                    throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
                }
                
                // å¹¶è¡Œè§£æJSON
                const [tasksData, employeesData, assignmentsData, skillsData] = await Promise.all([
                    tasksRes.json(),
                    employeesRes.json(),
                    assignmentsRes.json(),
                    skillsRes.json()
                ]);
                
                tasks = Array.isArray(tasksData) ? tasksData : [];
                employees = Array.isArray(employeesData) ? employeesData : [];
                assignments = Array.isArray(assignmentsData) ? assignmentsData : [];
                skills = Array.isArray(skillsData) ? skillsData : [];
                
                const loadTime = Date.now() - startTime;
                console.log(`âœ… æ•°æ®åŠ è½½å®Œæˆ (${loadTime}ms): ${tasks.length}ä¸ªä»»åŠ¡, ${employees.length}ä¸ªå‘˜å·¥, ${assignments.length}æ¡åˆ†é…è®°å½•, ${skills.length}ä¸ªæŠ€èƒ½`);
                
                renderAll();
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
                // ç¡®ä¿æœ‰é»˜è®¤ç©ºæ•°ç»„
                tasks = [];
                employees = [];
                assignments = [];
                skills = [];
                renderAll();
            } finally {
                hideLoading();
            }
        }
        
        // å®šæœŸåˆ·æ–°æ•°æ®ï¼ˆè½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€æ›´æ–°ï¼‰
        setInterval(async () => {
            try {
                const response = await fetch(`${API_BASE}/assignments`);
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        assignments = data;
                        renderRecords();
                    }
                }
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
            }
        }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡

        // æ¸²æŸ“æ‰€æœ‰
        function renderAll() {
            renderTasks();
            renderSkills();
            renderEmployees();
            renderRecords();
        }

        // ç›‘å¬é€‰æ‹©å™¨å˜åŒ–
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('task-select') || e.target.classList.contains('employee-select')) {
                updatePreview();
            }
        });
        
        // ==================== è‡ªåŠ¨åˆ†é…åŠŸèƒ½ ====================
        
        let autoAssignResult = null;  // å­˜å‚¨è‡ªåŠ¨åˆ†é…ç»“æœ
        
        // è¿è¡Œè‡ªåŠ¨åˆ†é…ç®—æ³•
        async function runAutoAssign() {
            const skillThreshold = parseInt(document.getElementById('skill-match-threshold').value);
            const workloadThreshold = parseInt(document.getElementById('workload-threshold').value);
            const enableBalance = document.getElementById('enable-balance').checked;
            
            console.log('è¿è¡Œè‡ªåŠ¨åˆ†é…ç®—æ³•...');
            console.log('å‚æ•°:', { skillThreshold, workloadThreshold, enableBalance });
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = 'â³ æ­£åœ¨åˆ†æ...';
                btn.disabled = true;
                
                const response = await fetch(`${API_BASE}/auto-assign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        manager_dingtalk_id: currentAdmin ? currentAdmin.userid : null,
                        skill_match_threshold: skillThreshold,
                        workload_threshold: workloadThreshold,
                        enable_balance: enableBalance
                    })
                });
                
                const result = await response.json();
                console.log('è‡ªåŠ¨åˆ†é…ç»“æœ:', result);
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                if (result.success) {
                    autoAssignResult = result;
                    renderAutoAssignResult(result);
                    
                    if (result.assignments.length === 0) {
                        alert('âš ï¸ æ²¡æœ‰å¯ä»¥è‡ªåŠ¨åˆ†é…çš„ä»»åŠ¡ï¼Œå¯èƒ½åŸå› ï¼š\n- æ‰€æœ‰ä»»åŠ¡å·²åˆ†é…\n- æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å‘˜å·¥');
                    }
                } else {
                    alert('âŒ è‡ªåŠ¨åˆ†é…å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('è‡ªåŠ¨åˆ†é…å¤±è´¥:', error);
                alert('âŒ è‡ªåŠ¨åˆ†é…å¤±è´¥: ' + error.message);
                
                const btn = document.querySelector('.distribute-section button');
                if (btn) {
                    btn.innerHTML = 'ğŸš€ è¿è¡Œè‡ªåŠ¨åˆ†é…ç®—æ³•';
                    btn.disabled = false;
                }
            }
        }
        
        // æ¸²æŸ“è‡ªåŠ¨åˆ†é…ç»“æœ
        function renderAutoAssignResult(result) {
            const container = document.getElementById('auto-assign-result');
            const statsContainer = document.getElementById('auto-assign-stats');
            const listContainer = document.getElementById('auto-assign-list');
            const unassignedContainer = document.getElementById('auto-assign-unassigned');
            const unassignedList = document.getElementById('unassigned-list');
            const balanceWarning = document.getElementById('balance-warning');
            const workloadPreview = document.getElementById('employee-workload-preview');
            const workloadChangeList = document.getElementById('workload-change-list');
            const delayWarning = document.getElementById('task-delay-warning');
            const delayRiskList = document.getElementById('delay-risk-list');
            
            if (result.assignments.length === 0 && result.unassigned_reasons.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            container.style.display = 'block';
            
            // æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
            const delayRiskCount = result.statistics.delay_risk_count || 0;
            statsContainer.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${result.statistics.total_tasks}</div>
                    <div style="color: #666; font-size: 13px;">å¾…åˆ†é…ä»»åŠ¡</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; color: #10b981;">${result.statistics.assigned_tasks}</div>
                    <div style="color: #666; font-size: 13px;">æˆåŠŸåŒ¹é…</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">${result.statistics.unassigned_tasks}</div>
                    <div style="color: #666; font-size: 13px;">æœªèƒ½åŒ¹é…</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; color: ${delayRiskCount > 0 ? '#ef4444' : '#10b981'};">${delayRiskCount}</div>
                    <div style="color: #666; font-size: 13px;">å»¶æœŸé£é™©</div>
                </div>
            `;
            
            // æ¸²æŸ“å‘˜å·¥è´Ÿè½½å˜åŒ–é¢„è§ˆ
            if (result.employee_workload_changes && result.employee_workload_changes.length > 0) {
                workloadPreview.style.display = 'block';
                workloadChangeList.innerHTML = result.employee_workload_changes.map(change => {
                    const changeValue = change.workload_change;
                    const changeColor = changeValue > 20 ? '#ef4444' : changeValue > 10 ? '#f59e0b' : '#10b981';
                    const changeIcon = changeValue > 0 ? 'â†‘' : changeValue < 0 ? 'â†“' : 'â†’';
                    
                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: #f9fafb; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 12px; min-width: 150px;">
                                <span style="font-size: 20px;">ğŸ‘¤</span>
                                <div>
                                    <div style="font-weight: 600; color: #333;">${change.employee_name}</div>
                                    <div style="font-size: 12px; color: #666;">
                                        åˆ†é… ${change.assigned_task_count} ä¸ªä»»åŠ¡ï¼Œå…± ${change.assigned_hours}h
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: #999; margin-bottom: 2px;">åˆ†é…å‰</div>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <div style="width: 80px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${Math.min(change.workload_before, 100)}%; height: 100%; background: ${change.level_before.color}; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 13px; font-weight: 600; color: ${change.level_before.color};">${change.workload_before}%</span>
                                    </div>
                                    <div style="font-size: 10px; color: ${change.level_before.color};">${change.level_before.label}</div>
                                </div>
                                <div style="font-size: 20px; color: ${changeColor};">${changeIcon}</div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: #999; margin-bottom: 2px;">åˆ†é…å</div>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <div style="width: 80px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${Math.min(change.workload_after, 100)}%; height: 100%; background: ${change.level_after.color}; border-radius: 4px;"></div>
                                        </div>
                                        <span style="font-size: 13px; font-weight: 600; color: ${change.level_after.color};">${change.workload_after}%</span>
                                    </div>
                                    <div style="font-size: 10px; color: ${change.level_after.color};">${change.level_after.label}</div>
                                </div>
                                <div style="text-align: center; padding: 5px 12px; background: ${changeColor}15; border-radius: 6px;">
                                    <div style="font-size: 11px; color: #999;">å˜åŒ–</div>
                                    <div style="font-size: 14px; font-weight: 700; color: ${changeColor};">
                                        ${changeValue > 0 ? '+' : ''}${changeValue}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                workloadPreview.style.display = 'none';
            }
            
            // æ¸²æŸ“ä»»åŠ¡å»¶æœŸé£é™©é¢„è­¦
            if (result.task_delay_risks && result.task_delay_risks.length > 0) {
                delayWarning.style.display = 'block';
                delayRiskList.innerHTML = result.task_delay_risks.map(risk => {
                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background: white; border-radius: 8px; border-left: 4px solid ${risk.risk_color};">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #333; margin-bottom: 3px;">${risk.task_name}</div>
                                <div style="font-size: 12px; color: #666;">
                                    åˆ†é…ç»™ ${risk.employee_name} Â· æˆªæ­¢ ${risk.deadline} Â· é¢„è®¡ ${risk.estimated_hours}h
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="display: inline-block; padding: 4px 12px; background: ${risk.risk_color}; color: white; border-radius: 15px; font-size: 12px; font-weight: 600;">
                                    ${risk.risk_label}
                                </div>
                                <div style="font-size: 11px; color: ${risk.risk_color}; margin-top: 3px;">
                                    ${risk.risk_reason}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                delayWarning.style.display = 'none';
            }
            
            // æ¸²æŸ“åˆ†é…è¯¦æƒ…
            if (result.assignments.length > 0) {
                listContainer.innerHTML = result.assignments.map((assign, index) => {
                    const task = assign.task;
                    const employee = assign.employee;
                    const importanceColor = getImportanceColor(task.importance || 5);
                    
                    // è¯„åˆ†è¯¦æƒ…
                    const scoreDetails = assign.score_details || {};
                    
                    // åŒ¹é…çš„æŠ€èƒ½
                    const matchedSkillsHtml = assign.matched_skills && assign.matched_skills.length > 0
                        ? assign.matched_skills.map(s => `<span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px;">${s.skill_name} (${s.rating}åˆ†)</span>`).join('')
                        : '<span style="color: #999; font-size: 12px;">æ— æŠ€èƒ½è¦æ±‚</span>';
                    
                    // å€™é€‰äººåˆ—è¡¨
                    const candidatesHtml = assign.all_candidates && assign.all_candidates.length > 1
                        ? `<div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
                            <span style="color: #666; font-size: 11px;">å…¶ä»–å€™é€‰äººï¼š</span>
                            ${assign.all_candidates.slice(1).map(c => 
                                `<span style="background: #f3f4f6; color: #666; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">${c.employee_name} (${c.score}åˆ†)</span>`
                            ).join('')}
                           </div>`
                        : '';
                    
                    return `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 250px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="font-size: 18px; font-weight: 600; color: #333;">${task.name}</span>
                                        <span style="background: ${importanceColor}; color: white; padding: 2px 10px; border-radius: 12px; font-size: 11px;">â­${task.importance || 5}</span>
                                        ${task.estimated_hours ? `<span style="background: #e0e7ff; color: #4338ca; padding: 2px 10px; border-radius: 12px; font-size: 11px;">â±ï¸${task.estimated_hours}h</span>` : ''}
                                    </div>
                                    <div style="color: #666; font-size: 13px; margin-bottom: 8px;">
                                        ${task.description ? (task.description.length > 80 ? task.description.substring(0, 80) + '...' : task.description) : 'æ— æè¿°'}
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <span style="color: #666; font-size: 12px;">åŒ¹é…æŠ€èƒ½ï¼š</span>
                                        ${matchedSkillsHtml}
                                    </div>
                                </div>
                                
                                <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 8px; min-width: 120px;">
                                    <div style="font-size: 24px; margin-bottom: 5px;">â†’</div>
                                    <div style="font-size: 11px; color: #666;">åˆ†é…ç»™</div>
                                </div>
                                
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 8px;">
                                        ğŸ‘¤ ${employee.name}
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                                        <span style="background: #667eea; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">
                                            æ€»åˆ†: ${assign.score}
                                        </span>
                                        <span style="background: #10b981; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">
                                            åŒ¹é…: ${assign.match_ratio.toFixed(0)}%
                                        </span>
                                        <span style="background: ${assign.workload_before > 70 ? '#f59e0b' : '#10b981'}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">
                                            è´Ÿè½½: ${assign.workload_before.toFixed(0)}%â†’${assign.workload_after.toFixed(0)}%
                                        </span>
                                    </div>
                                    <div style="font-size: 11px; color: #999;">
                                        è¯„åˆ†æ˜ç»†: æŠ€èƒ½åŒ¹é…${scoreDetails.skill_match || 0} + æŠ€èƒ½è¯„åˆ†${scoreDetails.skill_rating || 0} + è´Ÿè½½${scoreDetails.workload || 0} + å·¥æ—¶${scoreDetails.hours_match || 0}
                                    </div>
                                </div>
                                
                                <div style="display: flex; align-items: center;">
                                    <button class="btn btn-small btn-danger" onclick="removeAutoAssignment(${index})" style="padding: 5px 10px;">
                                        âœ•
                                    </button>
                                </div>
                            </div>
                            ${candidatesHtml}
                        </div>
                    `;
                }).join('');
            } else {
                listContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•åˆ†é…</p>';
            }
            
            // æ¸²æŸ“æœªåˆ†é…ä»»åŠ¡
            if (result.unassigned_reasons && result.unassigned_reasons.length > 0) {
                unassignedContainer.style.display = 'block';
                unassignedList.innerHTML = result.unassigned_reasons.map(item => `
                    <div style="padding: 8px 12px; background: white; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500;">${item.task_name}</span>
                        <span style="color: #92400e; font-size: 13px;">${item.reason}</span>
                    </div>
                `).join('');
            } else {
                unassignedContainer.style.display = 'none';
            }
            
            // æ¸²æŸ“è´Ÿè½½å¹³è¡¡è­¦å‘Š
            if (result.balance_adjustments && result.balance_adjustments.length > 0) {
                balanceWarning.style.display = 'block';
                const adj = result.balance_adjustments[0];
                document.getElementById('balance-message').textContent = 
                    `${adj.message}ï¼ˆæœ€é«˜è´Ÿè½½: ${adj.max_workload.toFixed(1)}%, æœ€ä½è´Ÿè½½: ${adj.min_workload.toFixed(1)}%ï¼‰`;
            } else {
                balanceWarning.style.display = 'none';
            }
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // ç§»é™¤å•ä¸ªè‡ªåŠ¨åˆ†é…
        function removeAutoAssignment(index) {
            if (autoAssignResult && autoAssignResult.assignments) {
                autoAssignResult.assignments.splice(index, 1);
                autoAssignResult.statistics.assigned_tasks = autoAssignResult.assignments.length;
                renderAutoAssignResult(autoAssignResult);
            }
        }
        
        // æ¸…ç©ºè‡ªåŠ¨åˆ†é…ç»“æœ
        function clearAutoAssignResult() {
            autoAssignResult = null;
            document.getElementById('auto-assign-result').style.display = 'none';
        }
        
        // ç¡®è®¤å¹¶å‘é€è‡ªåŠ¨åˆ†é…
        async function confirmAutoAssign() {
            if (!autoAssignResult || !autoAssignResult.assignments || autoAssignResult.assignments.length === 0) {
                alert('âš ï¸ æ²¡æœ‰å¾…ç¡®è®¤çš„åˆ†é…');
                return;
            }
            
            if (!confirm(`ç¡®è®¤å‘é€ ${autoAssignResult.assignments.length} ä¸ªä»»åŠ¡åˆ†é…é€šçŸ¥å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auto-assign/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assignments: autoAssignResult.assignments,
                        assignedByDingtalkId: currentAdmin ? currentAdmin.userid : null,
                        assignedByName: currentAdmin ? currentAdmin.name : 'ç®¡ç†å‘˜'
                    })
                });
                
                const result = await response.json();
                console.log('ç¡®è®¤ç»“æœ:', result);
                
                if (result.success) {
                    showSuccess('distribute-success', `âœ… ${result.message}`);
                    
                    // æ¸…ç©ºè‡ªåŠ¨åˆ†é…ç»“æœ
                    clearAutoAssignResult();
                    
                    // åˆ·æ–°æ•°æ®
                    await loadDataFromServer();
                    updateDistributeSelects();
                    updateTaskStatus();
                } else {
                    alert('âŒ ç¡®è®¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ç¡®è®¤å¤±è´¥:', error);
                alert('âŒ ç¡®è®¤å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>

